/*! For license information please see 136.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[136],{64366:(e,t,i)=>{"use strict";e.exports=i.p+"images/tagbg.png"},28636:(e,t,i)=>{"use strict";e.exports=i.p+"images/NoteColor.png"},27832:(e,t,i)=>{"use strict";e.exports=i.p+"images/objectColor.png"},30749:(e,t,i)=>{"use strict";e.exports=i.p+"images/pinAnchor.png"},44148:(e,t,i)=>{"use strict";e.exports=i.p+"images/pinIconDefault.png"},48072:(e,t,i)=>{"use strict";e.exports=i.p+"images/360_placement_pin_mask.png"},68444:(e,t,i)=>{"use strict";e.exports=i.p+"images/exterior.png"},85089:(e,t,i)=>{"use strict";e.exports=i.p+"images/exterior_hover.png"},45545:(e,t,i)=>{"use strict";e.exports=i.p+"images/interior.png"},64293:(e,t,i)=>{"use strict";e.exports=i.p+"images/interior_hover.png"},4592:(e,t,i)=>{"use strict";e.exports=i.p+"images/tagColor.png"},42606:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});var n=i(97542),a=i(57956),s=i(74903),o=i(25985),r=i(53954),d=i(65636),l=i(93642),h=i(49219),c=i(92001),m=i(14439),u=i(96042),p=i(34029),g=i(32597),v=i(43736),y=i(71776),w=i(45786),b=i(53203);class f extends n.Y{constructor(){super(...arguments),this.name="quick-menus"}async init(e,t){this.settingsModule=await t.getModuleBySymbol(a.y.SETTINGS),this.scanInfoDataModule=await t.getModuleBySymbol(a.y.SCAN_INFO),this.settingsGui=this.settingsModule.getSettingsGui();const i=await t.getModuleBySymbol(a.y.DEEP_LINKS),n=await t.market.waitForData(r.Z),f=await t.market.waitForData(p.e),T=await t.market.waitForData(o.M);this.uIndex=this.settingsGui.addPanel("Link to location",[g.R.U],{allowSubGroups:!1,width:400,ratio:90});const D=[38,38,40,40,37,39,37,39,66,65,g.R.O];this.oIndex=this.settingsGui.addPanel("Scan Info",D,{allowSubGroups:!1,width:400,ratio:75}),this.pIndex=this.settingsGui.addPanel("Quick settings",[g.R.P],{allowSubGroups:!1}),this.settingsGui.loadPromise.then((()=>{this.settingsGui.addControl(this.uIndex,"","Link",{}),this.settingsGui.addButton(this.uIndex,"","Copy to clipboard",(()=>{const e=document.createElement("input");e.type="text",e.value=this.buildLink(i),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)})),this.settingsGui.toggle(this.uIndex),this.settingsGui.addControl(this.oIndex,"","Scan ID",{}),this.settingsGui.addControl(this.oIndex,"","Anchor ID",{}),this.settingsGui.addControl(this.oIndex,"","Created",{}),this.settingsGui.addControl(this.oIndex,"","Time of Day",{}),this.settingsGui.addControl(this.oIndex,"","Alignment",{}),this.settingsGui.addControl(this.oIndex,"","Options",{}),this.settingsGui.addControl(this.oIndex,"","Camera",{}),this.settingsGui.addControl(this.oIndex,"","Camera Types",{}),this.settingsGui.addControl(this.oIndex,"","Sensor Serials",{}),this.settingsGui.addControl(this.oIndex,"","Serial Number",{}),this.settingsGui.addControl(this.oIndex,"","Mount Calibration",{}),this.settingsGui.addControl(this.oIndex,"","Software Version",{}),this.settingsGui.addButton(this.oIndex,"","Copy Scan ID",(async()=>{if(n.currentSweep){const e=await this.scanInfoDataModule.getScanInfo(n.currentSweep);if(e){const t=document.createElement("input");t.type="text",t.value=e.id,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}})),this.settingsGui.addButton(this.oIndex,"","Download Scan",(async()=>{if(n.currentSweep){const e=await this.scanInfoDataModule.getScanDownloadURL(n.currentSweep);e&&window.open(e)}})),this.settingsGui.toggle(this.oIndex);const e=l.WI*(180/Math.PI)*60;this.settingsGui.addControl(this.pIndex,"",c.U,!0),this.settingsGui.addControl(this.pIndex,"",v.s,!0),this.settingsGui.addControl(this.pIndex,"",y.re,!0),this.settingsGui.addControl(this.pIndex,"",w.b,!0),this.settingsGui.addSlider(this.pIndex,"",b.NR,b.Kb,0,100,1),this.settingsGui.addSlider(this.pIndex,"",h.lookAccelerationKey,e,.25,10,2),this.settingsGui.addSlider(this.pIndex,"",s.baseTransitionSpeedKey,d.Z.camera.baseTransitionTime,1,5e3,0);const t=f.tryGetProperty(m.EU,m.Im);this.settingsGui.addSlider(this.pIndex,"",m.WQ,(0,u.JG)(t),.5,10,2),this.settingsGui.toggle(this.pIndex),this.settingsModule.registerSetting("Quick settings",h.lookAccelerationKey,e,!1),this.settingsModule.registerSetting("Quick settings",s.baseTransitionSpeedKey,d.Z.camera.baseTransitionTime,!1),this.settingsModule.registerSetting("Quick settings",b.NR,b.Kb,!1),this.settingsGui.onToggle(this.uIndex,(e=>{e&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i))})),this.settingsGui.onToggle(this.oIndex,(e=>{e&&this.refreshScanInfo(n)})),T.pose.onChanged((()=>{this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.uIndex)&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i)),this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.oIndex)&&this.refreshScanInfo(n)})),f.onPropertyChanged(m.WQ,(e=>{f.setProperty(m.EU,(0,u.HG)(e))}))}))}refreshScanInfo(e){e.currentSweep?this.scanInfoDataModule.getScanInfo(e.currentSweep).then((e=>{this.updateScanInfo(e)})):this.updateScanInfo(void 0)}updateScanInfo(e){this.settingsGui.updateSetting(this.oIndex,"Scan ID",e?e.id:""),this.settingsGui.updateSetting(this.oIndex,"Anchor ID",e?e.anchorId:""),this.settingsGui.updateSetting(this.oIndex,"Created",e?e.created:""),this.settingsGui.updateSetting(this.oIndex,"Time of Day",e?e.timeOfDay:""),this.settingsGui.updateSetting(this.oIndex,"Alignment",e?e.alignment:""),this.settingsGui.updateSetting(this.oIndex,"Options",e?JSON.stringify(e.options):""),this.settingsGui.updateSetting(this.oIndex,"Camera",e?`${e.camera.vendor} ${e.camera.model}`:""),this.settingsGui.updateSetting(this.oIndex,"Camera Types",e?JSON.stringify(e.camera.cameraTypes):""),this.settingsGui.updateSetting(this.oIndex,"Sensor Serials",e?JSON.stringify(e.camera.sensorSerialNumbers):""),this.settingsGui.updateSetting(this.oIndex,"Serial Number",e?e.camera.serialNumber:""),this.settingsGui.updateSetting(this.oIndex,"Mount Calibration",e?e.camera.mountCalibrationVersion:""),this.settingsGui.updateSetting(this.oIndex,"Software Version",e?e.camera.softwareVersion:"")}buildLink(e){return decodeURIComponent(e.creator.createDeepLink().href)}}},95724:(e,t,i)=>{"use strict";i.d(t,{o:()=>n});class n{constructor(e){this.config=e}serialize(e){const{serializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.serialize(n);e&&i.push(e)}return i}deserialize(e){const{deserializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.deserialize(n);e&&i.push(e)}return i}}},2290:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AnnotationAttachmentClickedMessage:()=>c.q,AnnotationBlockClickedMessage:()=>c.i,AnnotationType:()=>m.J,AnnotationsViewData:()=>r.A,CloseAnnotationCommand:()=>d.Aj,CloseBillboardCommand:()=>d.G5,CloseDockedAnnotationCommand:()=>d.JD,CloseOtherAnnotationsCommand:()=>d.yL,DockAnnotationCommand:()=>d.bd,PreviewAnnotationCommand:()=>d.Kw,SelectAnnotationCommand:()=>d.oM,default:()=>u});var n=i(97542),a=i(40964),s=i(54244),o=i(80742),r=i(16935),d=i(43470),l=i(96154);class h extends n.Y{constructor(){super(...arguments),this.name="annotations",this.handleDockAnnotation=async e=>{const t=this.viewData,{dockedAnnotation:i}=t,{id:n,annotationType:a,force:s}=e;(this.viewData.getCapabilities(n).dock||s)&&((null==i?void 0:i.id)!==n||(null==i?void 0:i.annotationType)!==a?t.atomic((()=>{t.setDockedAnnotation(n,a),t.setBillboardAnnotation(null)})):this.log.debug("Annotation is already docked"))},this.handleSelectAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,billboardSelected:n}=t,{id:a,annotationType:s,force:o}=e;(this.viewData.getCapabilities(a).select||o)&&(n&&(null==i?void 0:i.id)===a&&(null==i?void 0:i.annotationType)===s?this.log.debug("Annotation is already selected"):t.atomic((()=>{t.setBillboardAnnotation(a,s,!0),t.setDockedAnnotation(null)})))},this.handlePreviewAnnotation=async e=>{this.viewData.getCapabilities(e.id).preview&&this.viewData.setBillboardAnnotation(e.id,e.annotationType,!1)},this.handleCloseBillboard=async()=>{this.viewData.setBillboardAnnotation(null)},this.handleCloseDockedAnnotation=async()=>{this.viewData.setDockedAnnotation(null)},this.handleClosingOtherAnnotations=async e=>{const{exceptType:t,exceptId:i}=e;this.closeOtherAnnotations(t,i)},this.closeOtherAnnotations=(e,t)=>{const i=this.viewData,{billboardAnnotation:n,dockedAnnotation:a}=i,s=n&&!this.isMatchingAnnotation(n,e,t),o=a&&!this.isMatchingAnnotation(a,e,t);i.atomic((()=>{n&&s&&i.setBillboardAnnotation(null),a&&o&&i.setDockedAnnotation(null)}))},this.handleCloseAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,dockedAnnotation:n}=t,{id:a,annotationType:s}=e;t.atomic((()=>{a===(null==i?void 0:i.id)&&s===(null==i?void 0:i.annotationType)&&t.setBillboardAnnotation(null),a===(null==n?void 0:n.id)&&s===(null==n?void 0:n.annotationType)&&t.setDockedAnnotation(null)}))},this.handleDockedAnnotationChanged=()=>{this.viewData.dockedAnnotation?this.engine.broadcast(new a.ro):this.engine.broadcast(new a.A)}}async init(e,t){this.viewData=new r.A,this.engine=t,[this.applicationData,this.layersData]=await Promise.all([t.market.waitForData(s.pu),t.market.waitForData(o.R)]),this.bindings.push(t.commandBinder.addBinding(d.bd,this.handleDockAnnotation),t.commandBinder.addBinding(d.oM,this.handleSelectAnnotation),t.commandBinder.addBinding(d.Kw,this.handlePreviewAnnotation),t.commandBinder.addBinding(d.Aj,this.handleCloseAnnotation),t.commandBinder.addBinding(d.G5,this.handleCloseBillboard),t.commandBinder.addBinding(d.JD,this.handleCloseDockedAnnotation),t.commandBinder.addBinding(d.yL,this.handleClosingOtherAnnotations),t.subscribe(l.oR,this.handleCloseBillboard),this.applicationData.onPropertyChanged("application",this.closeOtherAnnotations),this.layersData.onPropertyChanged("currentViewId",this.handleCloseBillboard),this.viewData.onDockedAnnotationChanged(this.handleDockedAnnotationChanged)),t.market.register(this,r.A,this.viewData)}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}onUpdate(){}isMatchingAnnotation(e,t,i){return!(!i&&!t)&&((!i||i===e.id)&&(!t||t===e.annotationType))}}var c=i(5604),m=i(86283);const u=h},58989:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Attachment:()=>o.P,AttachmentCategory:()=>r.G$,AttachmentEmbedStatus:()=>r._V,AttachmentUploadDoneMessage:()=>d.RE,AttachmentUploadError:()=>r.kV,AttachmentUploadProgressMessage:()=>d.Vj,AttachmentViewerCommand:()=>N.xW,AttachmentsData:()=>S.b,AttachmentsStore:()=>b,CancelAttachmentChangesCommand:()=>N.Ze,CloseAttachmentViewerMessage:()=>d.Rd,ConfirmAttachmentChangesCommand:()=>N.iu,EmbedMediaCommand:()=>N.wu,EmbeddingDoneMessage:()=>d.v8,ExternalAttachmentDeserializer:()=>p.d,ExternalAttachmentSerializer:()=>u,FileAttachmentDeserializer:()=>g.O,FileAttachmentStorage:()=>k,FileUploadDeserializer:()=>A,FileUploadSerializer:()=>I,LoadEmbeddedMediaCommand:()=>N.st,MediaType:()=>r.DD,RemoveAttachmentCommand:()=>N.$T,RemoveFailureCommand:()=>N.Rh,ResetAttachmentChangesCommand:()=>N.x9,UploadAttachmentsCommand:()=>N.It,ViewAttachmentsMessage:()=>d.O,default:()=>F});var n=i(97542),a=i(92558),s=i(5823),o=i(71608),r=i(32347),d=i(13794),l=i(17788),h=i(73123),c=i(97998),m=i(21149);class u{constructor(){this.getAttachmentDetails=e=>e.mediaType?{mediaType:(0,m.m)(e.mediaType),srcUrl:e.src,thumbnailUrl:e.src,width:e.width,height:e.height}:null,this.validate=e=>!!e&&void 0!==e.mediaType}serialize(e){const t=this.getAttachmentDetails(e);return t&&this.validate(t)?t:null}}var p=i(63665),g=i(65222),v=i(36159),y=i(63437);const w=new c.Z("AttachmentsStore");class b extends l.u{constructor(e){super(e),this.embedSerializer=new u,this.embedDeserializer=new p.d,this.fileDeserializer=new g.O}create(e){if(0===e.length)return Promise.resolve(null);const t=e[0].parentId,i=e[0].parentType;if(e.find((e=>e.parentId!==t||e.parentType!==i)))throw new Error("Cannot attach to different parents in one request");const n=this.getViewId(),a=[],o=[];let d,l;if(e.forEach((e=>{if(e.category===r.G$.EXTERNAL){const t=this.embedSerializer.serialize(e);if(!t)throw w.error("Failure attaching external attachment:",e),new Error("Could not attach External Attachment");a.push(t)}else e.category===r.G$.UPLOAD&&o.push(e.id)})),i!==s.ud.COMMENT)throw new Error(`Cannot attach to attachment to a ${i}`);return d=v.AddCommentAttachments,l="addCommentAttachments",this.mutate(d,{modelId:n,parentId:t,externalAttachments:a,fileAttachments:o}).then((e=>{const t=[],i=(0,h.q)(e,`data.${l}.externalAttachments`);if(i&&Array.isArray(i))for(const e of i){const i=this.embedDeserializer.deserialize(e);i&&t.push(i)}const n=(0,h.q)(e,`data.${l}.fileAttachments`);if(n&&Array.isArray(n))for(const e of n){const i=this.fileDeserializer.deserialize(e);i&&t.push(i)}return t.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async remove(e){const{id:t,parentId:i,parentType:n}=e,a=this.getViewId(),s=await this.mutate(y.RemoveFileAttachment,{modelId:a,attachmentId:t,parentType:n,parentId:i}),o=(0,h.q)(s,"data.removeFileAttachment")||!1;return o||w.error("remove file attachment failed!"),o}async delete(e,t,i){const n=this.getViewId();return Promise.all(e.map((e=>this.mutate(y.DeleteExternalAttachment,{modelId:n,attachmentId:e,parentType:i,parentId:t}))))}getViewId(){if(!this.viewId)throw new Error("Invalid valid id!");return this.viewId}}var f=i(77827),T=i(44602),D=i(9133),C=i(56367);const P=new c.Z("file-upload-deserializer");class A{deserialize(e){if(!e||!this.validate(e))return P.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new o.P;return t.id=e.id,t.created=(0,D.p)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,m.id)(e.mimeType)),t.thumbnailUrl=new C.n(e.url||"",(0,D.p)(e.validUntil,null)),t.url=new C.n(e.url||"",(0,D.p)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.category=r.G$.UPLOAD,t.width=e.imageWidth||0,t.height=e.imageHeight||0,t}validate(e){return["id","created","url","filename","mimeType","validUntil"].every((t=>t in e))}}class I{constructor(){}serialize(e){return{filename:e.file.name,contents:{filename:e.file.name,blob:e.file}}}}const E=new c.Z("FileAttachmentStorage");class k extends f.U{constructor(e){super(e),this.uploadDeserializer=new A,this.uploadSerializer=new I}async create(e,t){const i=f.U.baseViewId,n=this.uploadSerializer.serialize(e);let a;try{a=await this.client.upload(T.UploadFileAttachmentToModel,"UploadFileAttachmentToModel",Object.assign(Object.assign({},n),{modelId:i,organizationId:this.config.organizationId}),t)}catch(t){return E.error(t),"file.upload.quota.exceeded"===t.code?e.error=r.kV.OVER_QUOTA:e.error=r.kV.UPLOAD_FAILED,e.progress=100,e}if(a.errors&&a.errors.length>0)E.error(a.errors),e.error=r.kV.UPLOAD_FAILED;else{const t=(0,h.q)(a,"data.uploadFileAttachmentToModel")||null;if(t){const i=this.uploadDeserializer.deserialize(t);i?(E.info("upload successful!"),e.attachment=i):(E.error("cannot create attachment"),e.error=r.kV.UPLOAD_FAILED)}else E.error("upload failed!"),e.error=r.kV.UPLOAD_FAILED}return e.progress=100,e}async delete(e){const t=await this.client.mutate(T.DeleteFileAttachment,{id:e}),i=(0,h.q)(t,"data.deleteFileAttachment")||!1;return i?E.info("upload deleted!"):E.error("upload deletion failed!"),i}}var S=i(97163),N=i(35446),O=i(36892),M=i(56382);function V(e){switch(e){case M.ht.PHOTO:return r.DD.IMAGE;case M.ht.VIDEO:return r.DD.VIDEO;case M.ht.RICH:return r.DD.RICH;default:return}}function B(e){const{height:t,width:i,thumbnail_height:n,thumbnail_width:a,cache_age:s}=e,o=(void 0===t||void 0===i)&&(a&&n),r=e.type===M.ht.PHOTO?e.url:void 0,d=e.thumbnail_url||r,l=s?new Date(Date.now()+1e3*s):null;return{width:o?a:i,height:o?n:t,mediaType:V(e.type),url:new C.n(r||"",l),thumbnailUrl:new C.n(d||"",l)}}var x=i(80742);class R extends n.Y{constructor(){super(...arguments),this.name="attachments-module",this.loadEmbeddedAttachment=async e=>this.getUpdatedEmbed(e.attachment),this.embedMedia=async e=>{let t,i=null;const n=await this.oEmbedConsumer.getOEmbedData(e.src);return n?(i=new o.P,i.id=(0,a.fV)(),i.parentType=e.parentType,i.parentId=e.parentId,i.src=e.src,i.category=r.G$.EXTERNAL,Object.assign(i,B(n)),this.attachmentsData.addPending(i),t=r._V.EMBED_SUCCESS):t=r._V.EMBED_FAIL,this.engine.broadcast(new d.v8(i,t,e.parentId,e.parentType)),i},this.uploadAttachments=async e=>{const{parentType:t,parentId:i,files:n}=e,a=this.attachmentsData;n.forEach((e=>{this.uploadAttachment(e,i,t).then((e=>{a.atomic((()=>{e.error?(a.removeUpload(e.id),a.addFailure(e)):e.attachment&&(e.attachment.parentId=i,e.attachment.parentType=t,a.removeUpload(e.id),a.addPending(e.attachment))})),this.engine.broadcast(new d.RE(e))}))}))},this.onProgress=(e,t)=>{if(!e.lengthComputable)return;const i=e.total>0?Math.floor(e.loaded/e.total*100):100,n=Object.assign(Object.assign({},t),{progress:i});this.attachmentsData.updateUpload(n),this.engine.broadcast(new d.Vj(n))},this.removeFailure=async e=>{this.attachmentsData.removeFailure(e.id)},this.removeAttachment=async e=>{if(!this.fileAttachmentStorage)return void this.log.error("No file attachment store");const{attachment:t}=e,i=this.attachmentsData,n=i.getPendingAttachment(t.id);n?(n.category===r.G$.UPLOAD&&await this.fileAttachmentStorage.delete(t.id),i.removePendingAttachment(t.id)):i.markAttachmentForDelete(t)},this.confirmAttachmentChanges=async e=>{const t=this.attachmentsData,{pendings:i,removals:n}=t,{parentId:a,parentType:o,prevParentId:d}=e,l=i.length>0||n.length>0;if(i.length>0){const e=d||a;t.iteratePending((t=>{d&&t.parentId===e&&t.parentType===o&&(t.parentId=a)}));const n=o!==s.ud.MATTERTAG?i.values:i.values.filter((e=>e.category===r.G$.UPLOAD));await this.attachmentsStore.create(n)}if(n.length>0){const e=o!==s.ud.MATTERTAG?n.values:n.values.filter((e=>e.category===r.G$.UPLOAD));e.length>0&&await this.deleteAttachments(e,a,o)}return this.resetAttachmentData(),l},this.cancelAttachmentChanges=async()=>{const e=this.attachmentsData,{pendings:t,removals:i}=e;0===t.length&&0===i.length||(this.fileAttachmentStorage?(e.pendings.values.forEach((e=>{e.category===r.G$.UPLOAD&&this.fileAttachmentStorage.delete(e.id)})),this.resetAttachmentData()):this.log.error("No file attachment store"))},this.deleteAttachments=async(e,t,i)=>{if(!this.fileAttachmentStorage)return void this.log.error("No file attachment store");if(0===e.length)return;const n=[],a=[];this.attachmentsData.atomic((()=>{e.forEach((e=>{e.category===r.G$.UPLOAD?n.push(e):e.category===r.G$.EXTERNAL&&a.push(e.id)}))})),n.length>0&&await Promise.all(n.map((e=>this.attachmentsStore.remove(e)))),a.length>0&&await this.attachmentsStore.delete(a,t,i)},this.handleAttachmentViewerCommand=async e=>{const{open:t,attachments:i,attachmentId:n}=e;t&&i?this.openAttachmentViewer(i,n):this.closeAttachmentViewer()}}async init(e,t){this.engine=t;const{organizationId:i,oEmbedConsumer:n}=e;this.attachmentsStore=new b({readonly:!1});const a=await t.market.waitForData(x.R),s=()=>{this.attachmentsStore.setStoreViewId(a.getNonworkshopViewId())};s(),this.bindings.push(a.onPropertyChanged("currentViewId",s)),i&&(this.fileAttachmentStorage=new k({readonly:!1,organizationId:i})),this.oEmbedConsumer=await n,this.attachmentsData=new S.b,this.bindings.push(t.commandBinder.addBinding(N.It,this.uploadAttachments),t.commandBinder.addBinding(N.wu,this.embedMedia),t.commandBinder.addBinding(N.st,this.loadEmbeddedAttachment),t.commandBinder.addBinding(N.iu,this.confirmAttachmentChanges),t.commandBinder.addBinding(N.Ze,this.cancelAttachmentChanges),t.commandBinder.addBinding(N.x9,(async()=>this.resetAttachmentData())),t.commandBinder.addBinding(N.$T,this.removeAttachment),t.commandBinder.addBinding(N.Rh,this.removeFailure),t.commandBinder.addBinding(N.xW,this.handleAttachmentViewerCommand)),t.market.register(this,S.b,this.attachmentsData)}async getUpdatedEmbed(e){if(e.category===r.G$.EXTERNAL){const t=await this.oEmbedConsumer.getOEmbedData(e.src);return Object.assign(e,B(t)),t}return null}async uploadAttachment(e,t,i){const n={file:e,id:(0,a.fV)(),progress:0,error:null,attachment:null,parentId:t,parentType:i};if(!this.fileAttachmentStorage)return this.log.error("No file attachment store"),n.error=r.kV.PERMISSION_DENIED,Promise.resolve(n);const s=e.size;return 0===s?(n.error=r.kV.EMPTY_FILE,Promise.resolve(n)):s>O.z6?(n.error=r.kV.FILE_TOO_LARGE,Promise.resolve(n)):(this.attachmentsData.addUpload(n),this.fileAttachmentStorage.create(n,(e=>this.onProgress(e,n))))}resetAttachmentData(){const e=this.attachmentsData;e.atomic((()=>{e.clearPending(),e.clearRemovals(),e.clearUploads(),e.clearFailures()}))}openAttachmentViewer(e,t){this.viewerOpen=!0,this.engine.broadcast(new d.O(e,t))}closeAttachmentViewer(){this.viewerOpen&&(this.viewerOpen=!1,this.engine.broadcast(new d.Rd))}}const F=R},63665:(e,t,i)=>{"use strict";i.d(t,{d:()=>h});var n=i(97998),a=i(56367),s=i(9133),o=i(21149),r=i(71608),d=i(32347);const l=new n.Z("external-attachment-deserializer");class h{constructor(){}deserialize(e){if(!e||!this.validate(e))return l.debug("Deserialized invalid external attachment data from MDS",e),null;const t=new r.P;return t.id=e.id,t.created=(0,s.p)(e.created),t.src=e.url||"",t.thumbnailUrl=new a.n(e.thumbnailUrl||"",(0,s.p)(e.validUntil,null)),t.url=new a.n(e.url||"",(0,s.p)(e.validUntil,null)),e.mediaType&&(t.mediaType=(0,o.bY)(e.mediaType)),t.category=d.G$.EXTERNAL,e.width&&(t.width=e.width),e.height&&(t.height=e.height),t.parentType=e.parentDetails.type,t.parentId=e.parentDetails.parent.id,t}validate(e){if(!e)return!1;const t=["id","created","modified","mediaType","parentDetails"].filter((t=>!(t in e))),i=0===t.length;return i||l.debug("Attachment invalid:",{missingFields:t}),i}}},65222:(e,t,i)=>{"use strict";i.d(t,{O:()=>h});var n=i(97998),a=i(9133),s=i(21149),o=i(71608),r=i(32347),d=i(56367);const l=new n.Z("file-attachment-deserializer");class h{constructor(){}deserialize(e){if(!e||!this.validate(e))return l.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new o.P;return t.id=e.id,t.created=(0,a.p)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,s.id)(e.mimeType)),t.category=r.G$.UPLOAD,t.thumbnailUrl=new d.n(e.url||"",(0,a.p)(e.validUntil,null)),t.url=new d.n(e.url||"",(0,a.p)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.width=e.imageWidth||0,t.height=e.imageHeight||0,t}validate(e){if(!e)return!1;return["id","created","url","mimeType","filename"].every((t=>t in e))}}},25821:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var n=i(97542),a=i(57956),s=i(84428),o=i(12529),r=i(77597);const d=new s.Vector3(0,1,0),l=16724312,h=[{innerRadius:0,outerRadius:.42,color:l,opacity:.7},{innerRadius:.67,outerRadius:1,color:l,opacity:.7}];class c{constructor(e,t,i){this.scene=e,this.sweepData=t,this.mesh=new r.f({radius:.25,normal:d,rings:h}),this.mesh.name="CurrentPanoMarker",this.mesh.renderOrder=o.z.panoMarker,this.mesh.layers.mask=i.mask}init(){}dispose(){this.mesh.dispose()}render(){const e=this.sweepData.currentAlignedSweepObject;e&&this.move(e.floorPosition)}activate(){this.scene.add(this.mesh)}deactivate(){this.scene.remove(this.mesh)}move(e){this.mesh.position.copy(e).setY(e.y+c.floorOffset)}}c.floorOffset=.01;var m=i(23254),u=i(53954),p=i(19663);class g extends p.m{constructor(e){super(),this.id="TOGGLE_PANO_MARKER",this.payload={enabled:e}}}var v=i(95882);class y extends n.Y{constructor(){super(...arguments),this.name="current-pano-marker",this.state={markerEnabled:!1,transitionPromise:null}}async init(e,t){const i=(await t.getModuleBySymbol(a.y.WEBGL_RENDERER)).getScene(),n=t.claimRenderLayer(this.name),[s,o]=await Promise.all([t.market.waitForData(u.Z),t.market.waitForData(m.O)]);this.engine=t,this.sweepData=s,this.viewmodeData=o,this.markerRenderer=new c(i,s,n),this.bindings.push(t.commandBinder.addBinding(g,(async({enabled:e})=>this.setCommandOverride(e))),this.viewmodeData.makeModeChangeSubscription((()=>this.updateMarker())),this.sweepData.makeSweepChangeSubscription((()=>this.updateMarker()))),this.updateMarker()}setCommandOverride(e){this.state.commandOverride=e,this.updateMarker()}async updateMarker(){const{commandOverride:e}=this.state,t=this.viewmodeData.currentMode,i=this.sweepData.currentAlignedSweepObject,n=!1===e||(0,v.Bw)(t)||t===v.Ey.Transition;return this.toggleMarker(!!i&&!n)}async toggleMarker(e){const{markerEnabled:t,transitionPromise:i}=this.state;if(i&&await i,t===e)return;const n=e?this.enableMarker():this.disableMarker();return this.state.transitionPromise=n.finally((()=>{this.state.markerEnabled=e,this.state.transitionPromise=null})),this.state.transitionPromise}async enableMarker(){return this.engine.addComponent(this,this.markerRenderer)}async disableMarker(){return this.engine.removeComponent(this,this.markerRenderer)}}},95512:(e,t,i)=>{"use strict";i.d(t,{y:()=>a});var n=i(19663);class a extends n.m{constructor(e){super(),this.payload={disable:e}}}},79565:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n=i(97542),a=i(57956),s=i(95882),o=i(23254),r=i(2473),d=i(5135),l=i(53954),h=i(95512),c=i(34029),m=i(45786);class u extends n.Y{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(e,t){this.bindings.push(t.commandBinder.addBinding(h.y,(async e=>{this.disabled=e.disable}))),[this.cursorMesh,this.cursorModule]=await Promise.all([t.getModuleBySymbol(a.y.CURSOR_MESH),t.getModuleBySymbol(a.y.CURSORS)]),this.visibilityRules.push((()=>{const e=t.market.tryGetData(o.O);return!!e&&(0,s.Bw)(e.closestMode)}),(()=>{const e=t.market.tryGetData(l.Z);return!!e&&!e.isSweepUnaligned(e.currentSweep)}),(()=>{const e=t.market.tryGetData(r.k);return!!e&&!e.isTourActive()}),(()=>{const e=t.market.tryGetData(d.Z);return!!e&&!e.isMobile()}),(()=>{const e=t.market.tryGetData(c.e);return!!e&&e.tryGetProperty(m.b,!0)}))}onUpdate(){this.updateCursorVisibility()}addVisibilityRule(e){this.visibilityRules.push(e)}removeVisibilityRule(e){const t=this.visibilityRules.indexOf(e);-1!==t&&this.visibilityRules.splice(t,1)}setFadeProps(e){this.cursorModule.setFadeProps(e)}updateCursorVisibility(){const e=!this.disabled&&this.visibilityRules.reduce(((e,t)=>e&&t()),!0);this.cursorMesh.setVisible(e)}setTexture(e){this.cursorModule.setTexture(e)}}},45786:(e,t,i)=>{"use strict";i.d(t,{b:()=>n});const n="features/cursor"},30747:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var n=i(57956),a=i(97542),s=i(84428),o=i(93411),r=i(13310),d=i(67678),l=i(85992);class h extends a.Y{constructor(){super(...arguments),this.name="cursor-data",this.cursorState=new r.Y,this.position=new s.Vector2,this.timeToFade=0}async init(e,t){this.input=await t.getModuleBySymbol(n.y.INPUT),this.raycasterData=await t.market.waitForData(l.P),t.market.register(this,r.Y,this.cursorState),this.bindings.push(this.input.registerHandler(d.mE,this.onPointerMove.bind(this))),h.fadeInDuration>h.fadeOutDelay&&this.log.warn("fadeInDuration should be less than fadeOutDelay!")}onUpdate(e){let t=!1;this.timeToFade>0&&(this.timeToFade-=e,this.timeToFade<=0&&(t=!0)),this.cursorState.opacity.tick(e),this.cursorState.commit(),t&&this.cursorState.opacity.modifyAnimation(1,0,h.fadeOutDuration)}setFadeProps(e){const{fadeOut:t,fadeIn:i}=e;h.fadeOutDuration=t&&t.duration?t.duration:h.fadeOutDuration,h.fadeOutDelay=t&&t.delay?t.delay:h.fadeOutDelay,h.fadeInDuration=i&&i.duration?i.duration:h.fadeInDuration}setTexture(e){this.cursorState.texture=e}onPointerMove(){if(null!==this.raycasterData.hit&&this.raycasterData.pointerNdcPosition.distanceToSquared(this.position)>h.movementThreshold){this.position.copy(this.raycasterData.pointerNdcPosition),this.timeToFade=h.fadeOutDelay;const e=(0,o.t)(0,h.fadeInDuration,1-this.cursorState.opacity.value);this.cursorState.opacity.modifyAnimation(this.cursorState.opacity.value,1,e),this.cursorState.commit()}}dispose(e){super.dispose(e)}}h.fadeOutDelay=700,h.fadeOutDuration=700,h.fadeInDuration=300,h.movementThreshold=.003},13310:(e,t,i)=>{"use strict";i.d(t,{Y:()=>s});var n=i(89557),a=i(67992);class s extends a.V{constructor(){super(),this.name="cursor",this.opacity=new n.z(0),this.texture=null}}},85042:(e,t,i)=>{"use strict";var n;i.d(t,{L:()=>n}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(n||(n={}))},90763:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var n=i(97542),a=i(57956),s=i(84428),o=i(13310),r=i(85992),d=i(17878),l=i(85042),h=i(12529),c=i(77597);const m=[{outerRadius:.977,innerRadius:.926,color:16777215,opacity:1},{outerRadius:.898,innerRadius:.648,color:16777215,opacity:.73}];class u{constructor(e,t=d.o.ALL){this.scene=e,this.layer=t,this.supportsMobile=!1,this.style=l.L.Reticle,this.bindings=[],this.onCursorDataUpdated=e=>{this.mesh.configure({opacity:e.opacity.value,texture:e.texture})},this.onPositionUpdate=e=>{if(e.hit&&e.hit.face){const t=e.hit.point.clone(),i=e.hit.face.normal;this.container.position.copy(t),this.mesh.configure({normal:i})}},this.container=new s.Group,this.container.name="cursor",this.mesh=new c.f({radius:.2,rings:m}),this.container.add(this.mesh),this.mesh.renderOrder=h.z.reticule,this.mesh.layers.mask=this.layer.mask}init(){}render(){}dispose(){this.mesh.dispose(),this.container.children.forEach((e=>{if(e.isMesh&&e!==this.mesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(o.Y),i=await e.market.waitForData(r.P);this.bindings.push(t.onChanged(this.onCursorDataUpdated),i.onChanged(this.onPositionUpdate)),this.scene.add(this.container)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}class p extends n.Y{constructor(){super(...arguments),this.name="cursor-mesh",this.setVisible=e=>{this.cursor&&this.cursor.setVisible(e)}}async init(e,t){const i=(await t.getModuleBySymbol(a.y.WEBGL_RENDERER)).getScene(),n=t.claimRenderLayer(this.name);this.cursor=new u(i,n),t.addComponent(this,this.cursor)}get container(){return this.cursor.container}}},95810:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>d});var n=i(97542),a=i(57956),s=i(53058),o=i(84428),r=i(90304);class d extends n.Y{constructor(){super(...arguments),this.name="fat-caster",this.rayAssembly=new Array(d.rayCount),this.rayPlaneOrientation=new o.Quaternion,this.rayVisuals=[]}async init(e,t){this.config={debug:!!e.debug},this.raycaster=await t.getModuleBySymbol(a.y.RAYCASTER);for(let e=0;e<d.rayCount;++e)this.rayAssembly[e]=new o.Ray;if(e.debug){const e=(await t.getModuleBySymbol(a.y.WEBGL_RENDERER)).getScene();for(let t=0;t<d.rayCount;++t){this.rayVisuals[t]=new o.ArrowHelper(new o.Vector3,new o.Vector3);const i=this.rayVisuals[t];i.remove(i.cone),i.setLength(1e3),e.add(this.rayVisuals[t])}}}async dispose(e){const t=(await e.getModuleBySymbol(a.y.WEBGL_RENDERER)).getScene();for(const e of this.rayVisuals)t.remove(e)}get ray(){return this.raycaster.pointer.pointerRay.clone()}cast(e,t,i=s.a.Filter.AVERAGE){const n=this.ray;return this.updateRayAssembly(n.origin,n.direction,e),this.castRays(t,i)}castRays(e,t){const i=[];let n=null;for(const t of this.rayAssembly){const a=this.raycaster.picking.pick(t.origin,t.direction,e);a&&(t===this.rayAssembly[0]&&(n=a),a.point.add(this.rayAssembly[0].origin).sub(t.origin),i.push(a))}return t(i,n,this.rayAssembly)}updateRayAssembly(e,t,i){for(const e of this.rayAssembly)e.direction.copy(t);if(this.rayPlaneOrientation.setFromUnitVectors(r.f.FORWARD,t),this.rayAssembly[0].origin.copy(e),this.rayAssembly[1].origin.copy(r.f.RIGHT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[2].origin.copy(r.f.UP).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[3].origin.copy(r.f.LEFT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[4].origin.copy(r.f.DOWN).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[5].origin.copy(r.f.UP).add(r.f.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[6].origin.copy(r.f.UP).add(r.f.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[7].origin.copy(r.f.DOWN).add(r.f.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[8].origin.copy(r.f.DOWN).add(r.f.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.config.debug)for(let e=0;e<this.rayVisuals.length;++e){const i=this.rayVisuals[e];i.setDirection(t),i.position.copy(this.rayAssembly[e].origin)}}}d.rayCount=9},53058:(e,t,i)=>{"use strict";i.d(t,{a:()=>n});var n,a=i(84428);!function(e){let t;!function(e){const t=e=>{for(const t of e)if(t.face)return{point:t.point,object:t.object,distance:t.distance,face:t.face};return null},i=(e,t)=>e.distance-t.distance;e.CENTER_FIRST=(e,i)=>i&&i.face?{point:i.point,normal:i.face.normal,object:i.object,distance:i.distance,face:i.face}:t(e),e.CLOSEST=e=>t(e.sort(i)),e.AVERAGE=e=>{if(0===e.length)return null;const t={point:new a.Vector3,face:{a:0,b:1,c:2,normal:new a.Vector3,materialIndex:0},distance:0,object:e[0].object};for(const i of e)t.face&&i.face&&(t.point.add(i.point),t.face.normal.add(i.face.normal));return t.point.divideScalar(e.length),t.face&&t.face.normal.divideScalar(e.length).normalize(),t};e.CENTER_GROUP=t=>(i,a,s)=>{if(a){const n=[a];for(let e=1;e<i.length&&e<3;++e){const o=i[e];if(o.face){const i=Math.abs(s[e].direction.dot(o.face.normal));a.point.distanceTo(o.point)*i<=t&&n.push(o)}}if(n.length>=3){const t=e.AVERAGE(n,null,s);if(t&&t.face&&a.face)return t.face.normal=a.face.normal,t}}const o=n(i,s,t);return o?e.AVERAGE(o,null,s):e.CENTER_FIRST(i,a,s)};const n=(e,t,n)=>{const a=e.slice().sort(i),s=[a[0]];let o;for(o=1;o<a.length&&s.length<3;++o){const e=a[o];if(e.face){const i=Math.abs(t[o].direction.dot(e.face.normal));s[0].point.distanceTo(e.point)*i>n&&(s.length=0),s.push(e)}}return s.length<3?null:s}}(t=e.Filter||(e.Filter={}))}(n||(n={}))},69582:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GetFloorIntersectCommand:()=>n.Z,default:()=>w});var n=i(29900),a=i(97542),s=i(57956),o=i(947),r=i(25985),d=i(59370),l=i(76957),h=i(23254),c=i(95882),m=i(82814),u=i(16769),p=i(67944),g=i(84428),v=i(90304);class y extends a.Y{constructor(){super(...arguments),this.name="floor-caster",this.cameraPosition=new g.Vector3,this.forwardPosition=new g.Vector3,this.targetPlane=new g.Plane}async init(e,t){this.engine=t,[this.renderer,this.cameraData,this.viewmodeData,this.raycaster,this.floorsData,this.meshQuery]=await Promise.all([t.getModuleBySymbol(s.y.WEBGL_RENDERER),t.market.waitForData(r.M),t.market.waitForData(h.O),t.getModuleBySymbol(s.y.RAYCASTER),t.market.waitForData(l.i),t.getModuleBySymbol(s.y.MESH_QUERY)]),t.commandBinder.addBinding(n.Z,(e=>this.castToFloor(e.screenPosition,e.height,e.includeHiddenFloors)))}async castToFloor(e,t,i=!0){await this.engine.after(o.A.End);const n=this.renderer.getScene().camera,a=(0,d.z5)(e.x,e.y,this.cameraData.width,this.cameraData.height);let s,r=null;this.cameraPosition.set(a.x,a.y,-1).unproject(n),this.forwardPosition.set(a.x,a.y,1).unproject(n);const l=this.raycaster.picking.cast(this.cameraPosition,this.forwardPosition.clone().sub(this.cameraPosition).normalize(),i?u.T0:u.Pv)[0];if(l&&l.object instanceof m.S){r=l&&l.point||null;const e=this.meshQuery.floorIdFromObject(l.object);e?s=this.floorsData.getFloor(e):r&&(s=this.floorsData.getClosestFloorAtHeight(r.y))}if(void 0!==t){this.cameraPosition.copy(this.cameraData.pose.position);const e=(0,d.st)(this.cameraData,a);if(this.viewmodeData.currentMode!==c.Ey.Floorplan){const i=(0,p.n0)(this.cameraPosition,e);this.targetPlane.set(v.f.DOWN,t),r=(0,p.Fe)(this.cameraPosition,i,this.targetPlane)||null}else e.y=t,r=e}const h=s?s.index:-1;return{position:r,floor:h,floorIndex:h}}}const w=y},51728:(e,t,i)=>{"use strict";i.d(t,{U:()=>n});const n=Object.freeze({pink:"#f78da7",plum:"#9c4b92",purple:"#673ab7",teal:"#03687d",cerulean:"#03a9f4",ocean:"#00bcd4",fog:"#abb8c3",iron:"#607d8b",forest:"#417505",emerald:"#51a868",mint:"#37d67a",lime:"#cddc39",canary:"#fbcd00",sunflower:"#ffac17",tangerine:"#ff6900",sunset:"#f44336",sierra:"#d44441",magenta:"#e91e63"})},74082:(e,t,i)=>{"use strict";i.d(t,{$:()=>r});var n=i(49947),a=i(7159),s=i(30643),o=i(31362);class r{constructor(e){this.capabilites={links:{enable:e.supportLinks,keepLabels:e.keepLinkLabels}}}parse(e,t){const i=[];if(!e)return[];return e.split("[").map((function(e,t){return 0===t?e:"["+e})).forEach((e=>{const n=this.findLink(e);n?-1===n.url.indexOf("javascript:")&&(this.addLinkChunk(i,n,t),this.addTextChunk(i,e.slice(n.markdown.length))):this.addTextChunk(i,e)})),i}findLink(e){const t=e.match(/\[([^\]]*)\]\((.*)\)/);if(!t)return null;const i=t[2];let n=1,a=0;for(;a<i.length&&("("===i[a]?n++:")"===i[a]&&n--,0!==n);)a++;const s=i.length-a;return{markdown:t[0].substring(0,t[0].length-s),label:t[1],url:this.conditionallyEncode(t[2].substring(0,a))}}conditionallyEncode(e){return this.needsEncoding(e)?encodeURI(e):e}needsEncoding(e){if(e.match(o.jx))return!0;let t=e;try{t=decodeURI(e)}catch(e){}return!1}addTextChunk(e,t){0!==t.length&&e.push({type:s.z.text,text:t})}addLinkChunk(e,t,i){if(!this.capabilites.links.enable)return void(this.capabilites.links.keepLabels&&this.addTextChunk(e,t.label));const o={label:t.label,url:t.url,type:n.U.EXT_LINK};-1===o.url.indexOf("://")&&(o.url="http://"+o.url);const r=-1!==o.url.indexOf("matterport.com/show"),d=-1!==o.url.indexOf(window.location.host+"/show");if(r||d){const e=-1!==o.url.indexOf(i),t=a.K.deserialize(o.url);e&&t?(o.type=n.U.NAVIGATION,o.navigationData=t):(o.type=n.U.MODEL,o.url+="&play=1")}e.push({type:s.z.link,link:o})}static getNumLinks(e){let t=0;return e.forEach((e=>{"link"===e.type&&void 0!==e.link&&t++})),t}}},20480:(e,t,i)=>{"use strict";i.d(t,{U:()=>l});var n=i(84428),a=i(15462),s=i(30643),o=i(78283),r=i(75287);var d=i(10385);class l extends r.T{constructor(e){super(),this.sid="",this.layerId="",this.created=new Date,this.modified=new Date,this.enabled=!0,this.label="",this.description="",this.parsedDescription=[],this.anchorPosition=new n.Vector3,this.anchorNormal=new n.Vector3(0,1,0),this.stemVector=new n.Vector3(0,0,(0,o._F)(1)),this.stemHeight=(0,o._F)(1),this.stemVisible=!0,this.fileAttachments=new d.d,this.externalAttachments=new d.d,this.sandboxAttachments=new d.d,this.color=a.I.MATTERTAG_BLUE.clone(),this.mediaType=s.z.none,this.mediaSrc="",this.widgetFrame=null,this.keywords=[],e&&Object.assign(this,e)}copy(e){this.anchorNormal.copy(e.anchorNormal),this.anchorPosition.copy(e.anchorPosition),this.color.copy(e.color),this.created.setTime(e.created.getTime()),this.description=e.description,this.enabled=e.enabled,this.layerId=e.layerId,this.floorId=e.floorId,this.roomId=e.roomId,this.label=e.label,this.mediaType=e.mediaType,this.mediaSrc=e.mediaSrc,this.modified.setTime(e.modified.getTime()),this.sid=e.sid,this.stemVector.copy(e.stemVector),this.stemHeight=e.stemHeight,this.stemVisible=e.stemVisible,this.fileAttachments=e.fileAttachments,this.externalAttachments=e.externalAttachments,this.sandboxAttachments=e.sandboxAttachments,this.objectAnnotationId=e.objectAnnotationId,this.keywords=e.keywords,this.icon=e.icon,this.parsedDescription=[];for(const t of e.parsedDescription)this.parsedDescription.push({link:t.link&&{label:t.link.label.slice(),url:t.link.url.slice(),type:t.link.type,navigationData:t.link.navigationData&&{floorVisibility:t.link.navigationData.floorVisibility,mode:t.link.navigationData.mode,sweepIndex:t.link.navigationData.sweepIndex,panoId:t.link.navigationData.panoId,position:t.link.navigationData.position&&t.link.navigationData.position.clone(),quaternion:t.link.navigationData.quaternion.clone(),zoom:t.link.navigationData.zoom}},text:t.text,type:t.type});return this.copyWidgetFrame(e.widgetFrame),this.commit(),this}clone(){return(new l).copy(this)}copyWidgetFrame(e){e?this.widgetFrame?(!function(e,t,...i){for(const n of i)e[n]=t[n]}(this.widgetFrame.size,e.size,"width","height"),this.widgetFrame.frame=e.frame):this.widgetFrame=Object.assign({},e):this.widgetFrame=null}refresh(e){this.fileAttachments.forEach((t=>{const i=e[t.id];i&&(t.thumbnailUrl.refreshFrom(i.thumbnailUrl),t.url.refreshFrom(i.url))}))}getPin(){const{anchorPosition:e,color:t,enabled:i,floorId:n,roomId:a,stemVector:s,stemHeight:o,layerId:r}=this;return{anchorPosition:e,color:t.getHexString(),floorId:n,roomId:a,layerId:r,stemEnabled:i,stemNormal:s,stemLength:o}}updateFromOptions(e,t,i){void 0!==e.color&&(this.color=new n.Color(e.color.r,e.color.g,e.color.b)),void 0!==e.enabled&&(this.enabled=e.enabled),void 0!==e.stemHeight&&(this.stemHeight=e.stemHeight,this.stemVector.copy(this.anchorNormal).setLength(e.stemHeight)),void 0!==e.stemVisible&&(this.stemVisible=e.stemVisible),void 0!==e.label&&(this.label=e.label.slice()),void 0!==e.description&&(this.description=e.description,this.parsedDescription=t.parse(this.description,i)),void 0!==e.floorId&&(this.floorId=e.floorId),void 0!==e.normal&&(this.anchorNormal.copy(e.normal).normalize(),this.stemVector.copy(e.normal).setLength(this.stemHeight)),void 0!==e.position&&this.anchorPosition.copy(e.position),void 0!==e.keywords&&(this.keywords=e.keywords.slice()),Object.prototype.hasOwnProperty.call(e,"icon")&&(this.icon=e.icon),void 0!==e.objectAnnotationId&&(this.objectAnnotationId=e.objectAnnotationId)}}},60615:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>De});var n=i(97542),a=i(57956),s=i(20480),o=i(39880),r=i(79728),d=i(45905),l=i(90632),h=i(85979),c=i(635),m=i(71954),u=i(64567),p=i(2541),g=i(19648),v=i(47620),y=i(30643),w=i(85679),b=i(74082),f=i(29474),T=i(95724),D=i(17788),C=i(97998),P=i(73123),A=i(63665),I=i(65222),E=i(5823),k=i(40731);const S=new C.Z("mds-mattertag-serializer");class N{constructor(e,t){this.updateSerializer=e,this.mediaSerializer=t}serialize(e,t){const i=this.mediaSerializer.serialize(e),n=this.updateSerializer.serialize(e,t),a=null!==i?Object.assign(Object.assign({},i),n):n;return this.validate(a)?a:null}validate(e){if(!e)return!1;const t=["label","description","mediaUrl"].some((t=>t in e)),i=["floorId","enabled","anchorPosition"].filter((t=>!(t in e))),n=0===i.length,a=!!e.anchorPosition&&(0,k.u)(e.anchorPosition),s=n&&t&&a;return s||S.debug("Invalid MattertagDetails:",{missingFields:i,validPosition:a}),s}}var O=i(9133),M=i(2569),V=i(84428),B=i(37519),x=i(29282);const R=new C.Z("mds-mattertag-serializer");class F{constructor(e,t){this.fileAttachmentDeserializer=e,this.externalAttachmentDeserializer=t}deserialize(e){var t,i;if(!e||!this.validate(e))return R.debug("Deserialized invalid Mattertag data from MDS",e),null;const n=e.anchorPosition?M.ep.fromVisionVector(e.anchorPosition):void 0,a=e.stemNormal?M.ep.fromVisionVector(e.stemNormal):void 0,o=new s.U;if(o.sid=e.id,o.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",o.label=e.label||"",o.description=e.description||"",o.enabled=!!e.enabled,e.color&&(o.color=new V.Color(e.color)),o.created=(0,O.p)(e.created),o.modified=(0,O.p)(e.modified),e.floor&&e.floor.id&&(o.floorId=e.floor.id),e.room&&e.room.id&&(o.roomId=e.room.id),n&&(o.anchorPosition=n),e.media&&(o.mediaSrc=e.media),e.mediaType&&(o.mediaType=(0,v.m7)(e.mediaType)),o.fileAttachments.replace(this.getFileAttachments(o,e)),o.externalAttachments.replace(this.getExternalAttachments(o,e)),(0,B.hj)(e.stemLength)&&(o.stemHeight=e.stemLength),a&&a instanceof V.Vector3){const t=a.clone().setLength(o.stemHeight);o.anchorNormal=a,o.stemVector=t,o.stemVisible=!!e.stemEnabled}else o.stemVector=new V.Vector3(0,0,0),o.stemVisible=!!e.stemEnabled;return o.objectAnnotationId=null===(i=e.objectAnnotation)||void 0===i?void 0:i.id,o.keywords=e.keywords||[],(0,x.r)(e.icon)&&(o.icon=e.icon),o}validate(e){if(!e)return!1;return["id","created","modified","enabled"].every((t=>t in e))}getFileAttachments(e,t){return this.fileAttachmentDeserializer?this.deserializeFileAttachments(t).sort(((e,t)=>e.created.getTime()-t.created.getTime())):[]}getExternalAttachments(e,t){if(!this.externalAttachmentDeserializer)return[];const i=this.deserializeExternalAttachments(t);if(t.media&&t.mediaType){const n=(0,v.Nc)(e.sid,t.media,t.mediaType);n&&i.push(n)}return i.sort(((e,t)=>e.created.getTime()-t.created.getTime()))}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{var n;const a=null===(n=this.externalAttachmentDeserializer)||void 0===n?void 0:n.deserialize(t);a&&(a.parentId=e.id,a.parentType=E.ud.MATTERTAG,i.push(a))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{var n;const a=null===(n=this.fileAttachmentDeserializer)||void 0===n?void 0:n.deserialize(t);a&&(a.parentId=e.id,a.parentType=E.ud.MATTERTAG,i.push(a))})),i}}class L{serialize(e){return this.validate(e)?{sid:e.sid}:null}validate(e){const t=null!==e&&!!e.mediaType&&e.mediaType===y.z.none;return null!==e&&!!e.sid&&t}}const H=new C.Z("mds-mattertag-serializer");class U{serialize(e){const t=this.extractMedia(e);return this.validate(t)?t:null}validate(e){if(!e)return!1;const t=["mediaUrl","mediaType"].every((t=>t in e)),i=void 0!==e.mediaType&&["rich","photo","video"].includes(e.mediaType),n=t&&i;return n||H.debug("invalid media",e,{hasRequiredFields:t,hasValidMediaType:i}),n}extractMedia(e){const t={};return e.mediaSrc&&(t.mediaUrl=e.mediaSrc),e.mediaType&&e.mediaType in j&&(t.mediaType=e.mediaType),t.mediaUrl&&t.mediaType?t:null}}const j={[y.z.photo]:[E.L0.PHOTO],[y.z.rich]:[E.L0.RICH],[y.z.video]:[E.L0.VIDEO]};var G=i(69984);const z=new C.Z("mds-mattertag-serializer");class _{serialize(e,t){var i;if(!e)return null;const n={};return void 0!==e.enabled&&(n.enabled=e.enabled),void 0!==e.stemVisible&&(n.stemEnabled=e.stemVisible),void 0!==e.label&&(n.label=e.label),void 0!==e.description&&(n.description=e.description),void 0!==e.color&&(0,G.D5)(e.color)&&(n.color=(0,G.Ex)(e.color)),void 0!==e.anchorPosition&&(0,k.u)(e.anchorPosition)&&(n.anchorPosition=M.ep.toVisionVector(e.anchorPosition)),void 0!==e.anchorNormal&&(0,k.u)(e.anchorNormal)&&(n.stemNormal=M.ep.toVisionVector(e.anchorNormal)),void 0!==e.stemHeight&&(n.stemLength=e.stemHeight),Object.prototype.hasOwnProperty.call(e,"icon")&&(n.icon=null!==(i=e.icon)&&void 0!==i?i:""),void 0!==e.keywords&&(n.keywords=e.keywords),e.floorId&&(n.floorId=e.floorId),e.roomId&&(n.roomId=e.roomId),e.layerId&&t&&(n.layerId=e.layerId),e.objectAnnotationId&&(n.objectAnnotationId=e.objectAnnotationId),n&&this.validate(n)?n:null}validate(e){if(!e)return!1;const t=["layerId","floorId","roomId","color","label","description","enabled","stemEnabled","stemLength","stemNormal","stemDirection","anchorPosition","objectAnnotationId","keywords","icon"],i=Object.keys(e).length>0,n=Object.keys(e).every((e=>t.includes(e))),a=n&&i;return a||z.debug("Invalid MattertagPatch:",{hasContents:i,hasValidFields:n,data:e}),a}}class ${serialize(e){const t=e.fileAttachments;return void 0===t?null:{fileAttachments:t.map((e=>e.id))}}}var W=i(82686);const K=new C.Z("MdsMattertagStore");class J extends D.u{constructor(e,t){super(e),this.layeredType=E.SF.MATTERTAG,this.prefetchKey="data.model.mattertags";const i=t?new A.d:void 0;this.fileAttachmentDeserializer=t?new I.O:void 0,this.fileAttachmentSerializer=new $,this.patchSerializer=new _,this.mediaUpdateSerializer=new U,this.mediaRemovalSerializer=new L,this.createSerializer=new N(this.patchSerializer,this.mediaUpdateSerializer),this.tagDeserializer=new F(this.fileAttachmentDeserializer,i),this.deserializer=new T.o({deserializer:this.tagDeserializer})}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t,prefetchKey:this.prefetchKey,includeLayers:!!D.u.currentLayerId};return this.query(W.GetMattertags,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(e[t.sid]=t,e)),{})}))}async refreshFileAttachments(e){if(!this.fileAttachmentDeserializer)return{};const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t};return this.query(W.RefreshTagFileAttachments,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return{};const a=[];for(const e of n){if(!e.id||!e.fileAttachments)throw K.error("Failure refreshing tag file attachments"),new Error("Failure refreshing tag file attachments");e.fileAttachments.forEach((e=>{var t;const i=null===(t=this.fileAttachmentDeserializer)||void 0===t?void 0:t.deserialize(e);i&&a.push(i)}))}return a.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const n of e){const e=this.createSerializer.serialize(n,this.shouldWriteLayerId());if(!e)throw K.error("Failure saving tag:",n.sid,n),new Error("Could not save Mattertag");const a=n.sid;let o=", $data: MattertagDetails!";const r={modelId:t,mattertagId:a,data:e},d=this.fileAttachmentSerializer.serialize(n);d&&(o+=", $fileAttachments: [ID!]",r.fileAttachments=d.fileAttachments);const l=`\n        addMattertag(\n          modelId: $modelId,\n          mattertagId: "${a}",\n          mattertag: $data) {\n            id\n            created\n            modified\n          }\n        ${d?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${a}",\n            fileAttachments: $fileAttachments) {\n              id\n            }`:""}\n      `,h=f.Ps`
        mutation AddMattertag($modelId: ID! ${o}) {
          ${l}
        }
      `,c=await this.mutate(h,r),m=(0,P.q)(c,"data.addMattertag"),u=(new s.U).copy(n);u.sid=m.id,u.commit(),i.push(u)}return i}async update(e,t){if(!e||0===e.length)return;let i="";const n={},a=this.getViewId();n.modelId=a;let s="";for(const t of e){const e=t.sid,a=this.mediaUpdateSerializer.serialize(t),o=this.mediaRemovalSerializer.serialize(t),r=this.patchSerializer.serialize(t,this.shouldWriteLayerId()),d=r||o||a,l=this.fileAttachmentSerializer.serialize(t);if(!(r||a||o||l))return void K.debug(`Nothing to update for tag ${e}`,t);if(d){const t=r||{};i+=`, $patch${e}: MattertagPatch!`,o&&(t.mediaUrl=""),a&&(t.mediaUrl=a.mediaUrl,t.mediaType=a.mediaType),n[`patch${e}`]=t}l&&(i+=`, $fileAttachments${e}: [ID!]`,n[`fileAttachments${e}`]=l.fileAttachments),n[`mediaType${e}`]=a&&a.mediaType,n[`mediaUrl${e}`]=a&&a.mediaUrl;s+=`\n        update${e}:\n        ${d?`patchMattertag(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            patch: $patch${e}) {\n              id\n            }`:""}\n        ${l?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            fileAttachments: $fileAttachments${e}) {\n              id\n            }`:""}\n      `}for(const{attachment:e}of t)(null==e?void 0:e.id)&&(null==e?void 0:e.parentId)&&e.parentType?(i+=`, $parentType${e.id}: ParentType!`,n[`parentType${e.id}`]=e.parentType,s+=`\n        unattach${e.id}:\n        removeFileAttachment(modelId: $modelId,\n                             attachmentId: "${e.id}",\n                             parentType: $parentType${e.id},\n                             parentId: "${e.parentId}") `):K.debug("MattertagStore.update: unable to remove file attachment");const o=f.Ps`
      mutation tagUpdate($modelId: ID! ${i}) {
        ${s}
      }
    `;await this.mutate(o,n)}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const t of e){if(!t||t&&!t.sid)throw new Error("MattertagStore.delete failed");i+=`delete${t.sid}: deleteMattertag(modelId: $modelId, mattertagId: "${t.sid}") `}const n=f.Ps`
      mutation batchDeleteMattertag($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(n,{modelId:t}).then((()=>{}))}}var Y=i(25985),q=i(59370),Z=i(59279),Q=i(79232),X=i(33824),ee=i(54244),te=i(89570),ie=i(60975),ne=i(71776),ae=i(35221),se=i(64918),oe=i(36120),re=i(56163),de=i(39689),le=i(62612);class he extends re.K{constructor(e,t,i,n){super(e),this.mattertag=t,this.tagIconsEnabled=n,this.id=this.mattertag.sid,this.parentId=this.mattertag.sid,this.title=this.mattertag.label,this.description=this.textParser.getPlainText(this.mattertag.description),this.icon=`icon-${(0,de.m)(le.Er.MATTERTAG,this.mattertag.icon,this.tagIconsEnabled)}`,this.color=function(e){return`rgb(${255*e.r}, ${255*e.g}, ${255*e.b})`}(this.mattertag.color),this.typeId=E.SF.MATTERTAG,this.floorId=this.mattertag.floorId,this.layerId=this.mattertag.layerId,this.dateBucket=(0,ae.f)(this.mattertag.created),this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new oe.Y(this.mattertag.sid,se.n.FadeToBlack))},this.textParser=i}}var ce=i(52528),me=i(71166),ue=i(38399),pe=i(48945),ge=i(75557);const{TAGS:ve}=ue.Z.SHOWCASE,ye=new ce.v({links:!0}),we="0"===(0,Z.eY)("mt");var be=i(5666),fe=i(80742),Te=i(34029);class De extends n.Y{constructor(){super(...arguments),this.name="mattertag-data",this.monitor=null,this.filesToUnattach=[],this.getDiscPositions=(()=>{const e=[],t={},i={},n=new V.Vector3;return async a=>(e.length=0,a.tags.forEach((a=>{const s=this.data.getTag(a);s&&(i[a]||(i[a]=new V.Vector3),i[a].copy(s.anchorPosition).add(s.stemVector),t[a]||(t[a]=new V.Vector2),(0,q.q9)(this.cameraData,i[a],t[a],n),e.push({sid:a,screen:n.z>1?null:t[a],world:i[a]}))})),e)})(),this.addTag=async e=>{const t=[];return this.data.atomic((()=>{for(const i of e){const{positionOptions:e,standardOptions:n,mediaOptions:a}=i,s=Object.assign(Object.assign({},e),n),r=this.createTag(i.id||(0,o.O1)(11),s,[],a);r.modified=new Date,r.commit(),t.push(r.sid)}})),t},this.editTag=async e=>{const{sid:t,positionOptions:i,standardOptions:n,mediaOptions:a}=e,s=Object.assign(Object.assign({},i),n),o=this.data.getTag(t);o&&(this.updateTag(o,s,a),o.modified=new Date,o.commit())},this.removeTag=async e=>{const t=this.data.getTag(e.sid);if(void 0!==t&&this.data.removeTag(e.sid))return t&&t.objectAnnotationId&&this.engine.commandBinder.issueCommand(new be.SO(t.objectAnnotationId)),e.sid},this.saveNewTag=async e=>{const{id:t,properties:i,embed:n,fileAttachments:a}=e,s=n?{mediaSrc:n.src,mediaType:(0,v.F5)(n.mediaType)}:void 0;return this.createTag(t,i,a,s),this.engine.commandBinder.issueCommand(new c.VQ({dataTypes:[r.g.MATTERTAGS]}))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:a,embed:s}=e,o=this.data.getTag(t);if(!o)return void this.log.debug("Cannot save non-existent tag");const d=s?(0,v.F5)(s.mediaType):y.z.none,l=s?s.src:"";void 0!==s&&(l===o.mediaSrc&&d!==o.mediaType||this.updateExternalAttachment(o,s));const h=void 0!==s?{mediaSrc:l,mediaType:d}:void 0;return this.updateTag(o,i,h),n.forEach((e=>{o.fileAttachments.push(e)})),this.removeFileAttachments(o,a),this.data.addTag(o),this.data.updateOnStaleCallbacks(t),this.engine.commandBinder.issueCommand(new c.VQ({dataTypes:[r.g.MATTERTAGS]}))}}async init(e,t){const{readonly:i,baseUrl:n,newTagsEnabled:s}=e;this.engine=t,this.config=e,this.descParser=new b.$({supportLinks:!0,keepLinkLabels:!0}),[this.meshQueryModule,this.cameraData,this.layersData]=await Promise.all([t.getModuleBySymbol(a.y.MESH_QUERY),t.market.waitForData(Y.M),t.market.waitForData(fe.R)]),this.store=new J({readonly:i,includeDisabled:!i,baseUrl:n},s);const o=await t.getModuleBySymbol(a.y.STORAGE);if(this.data=new w.n,this.bindings.push(this.store.onNewData((async i=>{this.initializeTagData(i,t.market,e.parserOptions)})),t.commandBinder.addBinding(g.cH,this.getDiscPositions),t.commandBinder.addBinding(g.Fz,this.addTag),t.commandBinder.addBinding(g.Ek,this.editTag),t.commandBinder.addBinding(g.Gn,this.removeTag)),await this.store.refresh(),!i){this.bindings.push(t.commandBinder.addBinding(g.Mm,this.saveNewTag),t.commandBinder.addBinding(g.qq,this.saveTag),o.onSave((()=>this.save()),{dataType:r.g.MATTERTAGS}),o.onPublish((()=>this.onAfterPublish()),{dataType:r.g.MATTERTAGS,phase:d.Q.AFTER}));const e=await t.market.waitForData(l.Q);e.setRevertableType(r.g.MATTERTAGS),e.setPublishableType(r.g.MATTERTAGS),this.monitor=new u.c(this.data.collection,{aggregationType:p.E.Manual,shallow:!0}),this.configureTrash()}t.market.register(this,w.n,this.data);(async()=>{if(!s){const[e,t]=await Promise.all([this.engine.market.waitForData(Te.e),this.engine.market.waitForData(ee.pu)]),i=function(e,t,i,n,a){let s=a.application===ee.Mx.WORKSHOP;const o=n.tryGetProperty(pe.RV,!1),r=(n,a,r=[])=>{const d=[];return t.iterate((t=>{if(!(s||t.enabled&&i.layerToggled(t.layerId)))return;if(t.objectAnnotationId)return;let a=n(t.label,ye.getPlainText(t.description));a&&r.length>0&&(a=t.keywords.length>0&&t.keywords.some((e=>r.includes(e)))),a&&d.push(new he(e,t,ye,o))})),e.issueCommand(new ge.n(d.map((e=>e.id)))),d},d=new ie.u(n,{[ne.re]:!0}),l=t=>{e.issueCommand(new ge.E(!!t)),d.toggle(!!t)},h=e=>new te.V(t.onChanged(e)),c={renew:()=>{e.issueCommandWhenBound(new me.c6({id:E.SF.MATTERTAG,groupPhraseKey:ve.SEARCH_GROUP_HEADER,getSimpleMatches:r,registerChangeObserver:h,onSearchActivatedChanged:l,getKeywords:t.getTagKeywords.bind(t),groupOrder:20,groupIcon:"toolbar-mattertags"}))},cancel:()=>{e.issueCommandWhenBound(new me.Pe(E.SF.MATTERTAG))}},m=e=>{s=e===ee.Mx.WORKSHOP,!we||s?c.renew():c.cancel()},u=a.onPropertyChanged("application",m);return m(a.application),new te.V(c,u)}(this.engine.commandBinder,this.data,this.layersData,e,t);this.bindings.push(i)}})()}dispose(e){this.store.dispose(),super.dispose(e)}async save(){if(this.monitor&&this.monitor.commitChanges(),!this.store||!this.monitor)return void this.log.warn("Mattertags changes will NOT be saved");const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.data.getTag(e.index))||void 0===t?void 0:t.layerId);return Object.assign({layerId:i},e)})).filter((e=>!this.layersData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===m.KI.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),n=t.filter((e=>e.action===m.KI.added)).map((e=>this.data.getTag(e.index))),a=t.filter((e=>e.action===m.KI.updated)).map((e=>{const t=Object.assign({sid:e.index,layerId:e.layerId},e.diff);return"mediaSrc"in t&&(t.mediaType=this.data.getTag(e.index).mediaType),t.objectAnnotationId=this.data.getTag(e.index).objectAnnotationId,t}));await this.store.delete(i),await this.store.create(n),await this.store.update(a,this.filesToUnattach)}clearDiffRecord(){this.monitor&&this.monitor.clearDiffRecord()}initializeTagData(e,t,i){var n;const a=i?new b.$(i):this.descParser;this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,{})})),this.data.atomic((()=>{for(const t in e){const i=e[t];i.parsedDescription=a.parse(e[t].description,this.layersData.currentViewId),this.meshQueryModule.inferMeshIdsFromPoint(i,i.anchorPosition),this.data.addTag(i)}})),this.data.onStale=()=>this.store.refreshFileAttachments(),this.data.updateOnStaleCallbacks(),null===(n=this.monitor)||void 0===n||n.clearDiffRecord()}createTag(e,t,i,n){let a=e;for(;this.data.getTag(a);)a=(0,o.O1)(11);const r=new s.U;if(r.sid=a,r.layerId=this.layersData.activeLayerId,this.config.newTagsEnabled&&n){const e=(0,v.gj)(n.mediaType);if(n.mediaSrc&&e){const t=(0,v.Nc)(a,n.mediaSrc,e);t&&r.externalAttachments.push(t)}}return t.objectAnnotationId&&(r.objectAnnotationId=t.objectAnnotationId),t.keywords&&(r.keywords=t.keywords),i.forEach((e=>{r.fileAttachments.push(e)})),this.updateTag(r,t,n),this.data.addTag(r),this.data.updateOnStaleCallbacks(a),r}updateTag(e,t,i){e.updateFromOptions(t,this.descParser,this.layersData.currentViewId),void 0!==(null==i?void 0:i.mediaType)&&(e.mediaType=i.mediaType),void 0!==(null==i?void 0:i.mediaSrc)&&(e.mediaSrc=i.mediaSrc.slice())}removeFileAttachments(e,t){const{fileAttachments:i}=e;t.forEach((t=>{const n=i.findIndex((e=>e.id===t.id));-1!==n?(i.splice(n,1),this.filesToUnattach.push({attachment:t,layerId:e.layerId})):this.log.debug("Attempting to remove an attachment that is not in the tag")}))}updateExternalAttachment(e,t){const{mediaSrc:i}=e;i&&e.externalAttachments.replace([]),t&&e.externalAttachments.replace([t])}async onAfterPublish(){this.verifyDataIntegrity()}async verifyDataIntegrity(){const e="data-integrity"===(0,Z.eY)("error",""),t=this.data.getTagCount(),i=await this.store.read().catch((e=>{this.log.debug("Mattertag integrity check failed",e)}))||{},n=Object.keys(i).length;(n!==t||e)&&this.engine.broadcast(new h.Qq(`Unexpected tag count after publish (${n}/${t})`,r.g.MATTERTAGS,e))}async configureTrash(){const{readonly:e}=this.config,{commandBinder:t}=this.engine;if(e)return;const i=r.g.MATTERTAGS,n=new F,a={objectType:i,create:e=>new Q.F({label:e.label||(0,o.aS)(e.description||"",100)||"Mattertag",objectId:e.id,objectType:i,created:new Date,value:e}),restore:e=>{const t=n.deserialize(e.value);t&&this.data.addTag(t)}},s=await t.issueCommandWhenBound(new X.B(a));this.bindings.push(s)}}},47620:(e,t,i)=>{"use strict";i.d(t,{m7:()=>l,F5:()=>h,gj:()=>c,Nc:()=>u});var n=i(30643),a=i(32347),s=i(71608),o=i(92558),r=i(56367),d=i(5823);function l(e){const t={[d.L0.VIDEO]:n.z.video,[d.L0.PHOTO]:n.z.photo,[d.L0.RICH]:n.z.rich};return e in t?t[e]:n.z.none}function h(e){switch(e){case a.DD.VIDEO:return n.z.video;case a.DD.IMAGE:return n.z.photo;case a.DD.RICH:return n.z.rich}return n.z.none}function c(e){switch(e){case n.z.video:return d.L0.VIDEO;case n.z.photo:return d.L0.PHOTO;case n.z.rich:return d.L0.RICH}return null}function m(e){return{[d.L0.VIDEO]:a.DD.VIDEO,[d.L0.PHOTO]:a.DD.IMAGE,[d.L0.RICH]:a.DD.RICH}[e]}function u(e,t,i){return t?new s.P({id:(0,o.fV)(),created:new Date,parentId:e,parentType:d.ud.MATTERTAG,mediaType:m(i),src:t,url:new r.n(t,null),thumbnailUrl:new r.n(t,null),category:a.G$.EXTERNAL}):null}},28812:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n=i(97542),a=i(57956),s=i(34029),o=i(85679),r=i(54244),d=i(62612),l=i(48945),h=i(71776),c=i(67511),m=i(87926),u=i(64366),p=i(80742);class g extends n.Y{constructor(){super(...arguments),this.name="mattertag-mesh",this.visibilityDirty=!0,this.unanchoredTagOpacity=1,this.anchoredTagOpacity=1,this.addNewTagMesh=(e,t)=>{this.settings.tryGetProperty(l.RY,!1)||this.pinRenderer.updatePin(e.sid,d.Er.MATTERTAG,Object.assign(Object.assign({},e),{stemNormal:e.stemVector,stemLength:e.stemHeight,stemEnabled:e.stemVisible,color:`#${e.color.getHexString()}`,icon:d.Qk[d.Er.MATTERTAG]}),this.backgroundTexture,this.pinsModule.iconMaskTexture)},this.removeTagMesh=(e,t)=>{this.settings.tryGetProperty(l.RY,!1)||this.pinRenderer.removePin(e.sid)},this.updateTagMesh=(e,t)=>{this.addNewTagMesh(e,e.sid)},this.initializeTagVisibility=()=>{if(this.settings.tryGetProperty(l.RY,!1))return;const e=this.settings.tryGetProperty(h.re,!0);this.pinRenderer.setPinOpacityByType(d.Er.MATTERTAG,e?1:0),e&&this.mattertagData.iterate((e=>{this.pinRenderer.setPinVisible(e.sid,e.enabled)}))},this.updateTagVisibility=()=>{if(this.settings.tryGetProperty(l.RY,!1))return;this.settings.tryGetProperty(h.re,!1)?this.fadePinsToState():this.pinRenderer.fadePinOpacityByType(d.Er.MATTERTAG,0)},this.selectedTagChanged=()=>{if(!this.settings.tryGetProperty(l.RY,!1)){if(this.mattertagViewData.selectedTag&&!this.mattertagViewData.navigating){const e=this.mattertagData.getTag(this.mattertagViewData.selectedTag);this.pinRenderer.showSelectedMesh(d.Er.MATTERTAG,e.sid)}this.mattertagViewData.selectedTag||this.pinRenderer.hideSelectedMesh()}}}async init(e,t){[this.mattertagData,this.pinsModule,this.settings,this.mattertagViewData,this.layersData,this.appData]=await Promise.all([t.market.waitForData(o.n),t.getModuleBySymbol(a.y.PINS),t.market.waitForData(s.e),t.market.waitForData(c.P5),t.market.waitForData(p.R),t.market.waitForData(r.pu)]),this.pinRenderer=this.pinsModule.pinRenderer;this.pinsModule.fontManager.getFont(this.pinsModule.fontId).onChanged((()=>{this.mattertagData.iterate((e=>{this.addNewTagMesh(e,e.sid)}))}));const i=()=>{this.visibilityDirty=!0};this.bindings.push(this.mattertagData.collection.onElementChanged({onAdded:this.addNewTagMesh,onRemoved:this.removeTagMesh,onUpdated:this.updateTagMesh}),this.mattertagViewData.onChanged(i),this.appData.onChanged(i),this.settings.onPropertyChanged(h.re,i),this.mattertagData.onChanged(i),this.mattertagViewData.onSelectedTagChanged(this.selectedTagChanged),this.mattertagViewData.onNavigatingTagChanged(this.selectedTagChanged),this.layersData.onCurrentLayersChanged(i)),this.backgroundTexture=(0,m.p)(u),this.mattertagData.iterate((e=>{this.addNewTagMesh(e,e.sid)})),this.initializeTagVisibility()}dispose(e){this.pinRenderer.removePinsByType(d.Er.MATTERTAG),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(e){this.visibilityDirty&&(this.visibilityDirty=!1,this.updateTagVisibility())}showAnchorMesh(e){this.pinRenderer.showAnchorMesh(d.Er.MATTERTAG,e.sid,Object.assign(Object.assign({},e),{stemNormal:e.stemVector,stemLength:e.stemHeight})),this.unanchoredTagOpacity=.5,this.anchoredTagOpacity=1,this.anchorTagId=e.sid,this.fadePinsToState()}hideAnchorMesh(){this.unanchoredTagOpacity=1,this.anchoredTagOpacity=1,this.anchorTagId=void 0,this.pinRenderer.hideAnchorMesh(),this.fadePinsToState()}resetPinOpacity(){this.fadePinsToState()}changeDiscOpacity(e,t){this.pinRenderer.setPinOpacity(e,t)}setTagVisibility(e){this.pinRenderer.setPinTypeVisible(d.Er.MATTERTAG,e)}setTagVisible(e,t){this.pinRenderer.setPinVisible(e,t)}setOverrideMaterial(e,t,i){this.pinRenderer.setPinRenderOverrides(e,t,i)}layerToggledOn(e){return this.appData.application===r.Mx.WORKSHOP||this.layersData.layerToggled(e)}fadePinsToState(){const{selectedTag:e,idVisibilityEnabled:t,idVisibility:i}=this.mattertagViewData;this.mattertagData.iterate((n=>{const{sid:a,enabled:s,layerId:o}=n,r=e===a,d=this.layerToggledOn(o),l=this.layersData.layerVisible(o),h=!t||i.has(a),c=d&&(r||s&&h&&l);this.pinRenderer.setPinVisible(n.sid,c);const m=a===this.anchorTagId?this.anchoredTagOpacity:this.unanchoredTagOpacity;this.pinRenderer.fadePinOpacity(n.sid,c?m:0)}))}}},75557:(e,t,i)=>{"use strict";i.d(t,{E:()=>a,n:()=>s});var n=i(19663);class a extends n.m{constructor(e){super(),this.payload={enabled:e}}}class s extends n.m{constructor(e){super(),this.payload={ids:e}}}},81149:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>k});var n=i(84428),a=i(97542),s=i(57956),o=i(85679),r=i(19648),d=i(25985),l=i(55502),h=i(18923),c=i(5090),m=i(10374),u=i(64918),p=i(51397),g=i(54244),v=i(95882),y=i(71776),w=i(48945),b=i(34029),f=i(36120),T=i(67511),D=i(12039),C=i(90304),P=i(75557),A=i(62612),I=i(13132),E=i(80742);class k extends a.Y{constructor(){super(...arguments),this.name="mattertags-viewdata",this.distance=new n.Vector3,this.cameraPosition=new n.Vector3,this.hoverTimeout=0,this.updateViewData=()=>{this.data.iterate((e=>{this.viewData.derivedData[e.sid]=this.makeViewDataForMattertag(e)})),this.viewData.commit()},this.makeViewDataForMattertag=e=>{const t=this.viewData.activeBillboards.get(e.sid),i=this.viewData.selectedTag===e.sid,n=t?t.position:null,a=t?t.distance:0;return{position:n,selected:i,located:!(!n||!a),closeTheTag:!t||t.closing||!(i||!this.viewData.selectedTag),navigating:!(!this.viewData.navigating||this.viewData.navigating!==e.sid),navigatingPosition:i?this.viewData.getNavigatingPosition():void 0,positioned:!1,distance:a,stemHeight:e.stemHeight,visible:e.enabled,color:`#${e.color.getHexString()}`,onTagDirectionChanged:this.onTagDirectionChanged}},this.onCameraUpdate=e=>{this.viewData.activeBillboards.keys.length>0&&(this.cameraPosition.copy(e.pose.position),this.updateActiveBillboards(this.viewData.activeBillboards.keys),this.viewData.commit())},this.updateBillboardData=(e,t)=>{const i=this.viewData.activeBillboards.get(e);i&&(Object.assign(i,t),i.commit())},this.addActiveBillboard=e=>{this.viewData.activeBillboards.has(e)||this.viewData.activeBillboards.set(e,new T.ZJ(e))},this.removeFromActiveBillboards=e=>{this.viewData.activeBillboards.has(e)&&this.viewData.activeBillboards.delete(e)},this.handleOpenBillboardChanged=()=>{const e=this.viewData.openTag;this.viewData.activeBillboards.atomic((()=>{e&&(this.viewData.activeBillboards.get(e)?(window.clearTimeout(this.viewData.activeBillboards.get(e).timeoutId),this.updateBillboardData(e,{timeoutId:0,closing:!1})):this.addActiveBillboard(e),this.updateActiveBillboards([e]));for(const t of this.viewData.activeBillboards.keys){if(t===e)return;this.updateBillboardData(t,{closing:!0,direction:void 0,timeoutId:window.setTimeout((()=>{this.removeFromActiveBillboards(t)}),1e3)})}}))},this.updateActiveBillboards=async e=>{try{await this.engine.commandBinder.issueCommand(new r.cH(e)).then((e=>{for(const t of e)this.updateBillboardData(t.sid,{distance:this.distance.copy(this.cameraPosition).distanceToSquared(t.world),position:t.screen})}))}catch(e){this.log.error(`Could not get Disc Positions for tags - ${e}`)}},this.onSweepChosen=e=>{this.viewData.setNavigatingPosition(e)},this.onDiscHoverChange=e=>{if(this.settings.tryGetProperty(w.RY,!1))return;if(e.pinType!==A.Er.MATTERTAG)return;const t=this.viewData.toolState;if(t!==T.rI.CLOSED&&this.viewData.selectedTag)return;const i=this.data.getTag(e.id);if(i&&i.enabled)if(clearTimeout(this.hoverTimeout),e.hovering)t!==T.rI.EDITING&&(this.hoverTimeout=window.setTimeout((()=>this.discHoverChange(e.id,e.hovering)),125));else{if(e.id===this.viewData.selectedTag)return;this.discHoverChange(e.id,!1)}},this.onDiscClicked=e=>{if(this.settings.tryGetProperty(w.RY,!1))return;const t=this.viewData.toolState;e.pinType===A.Er.MATTERTAG&&t===T.rI.CLOSED&&(e.id===this.viewData.selectedTag?this.closeBillboard(e.id):(this.viewData.setSelectedTag(e.id),this.navigateToTag(e.id,u.n.Interpolate)))},this.onSweepExit=e=>{e.toSweep&&e.fromSweep!==e.toSweep&&(this.viewData.isCreatingNewMattertag()||this.viewData.closeOpenBillboard())},this.onAppChange=e=>{this.currentApp=e.application,this.viewData.closeOpenBillboard(),this.viewData.setSelectedTag(null)},this.onViewmodeChange=e=>{null===this.viewData.navigating&&(0,v.Bw)(e.fromMode)&&this.viewData.closeOpenBillboard()},this.onTagDirectionChanged=(e,t)=>{this.updateBillboardData(e,{direction:t})},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit()}}async init(e,t){this.engine=t;const[i,n,a,r]=await Promise.all([t.market.waitForData(o.n),t.market.waitForData(b.e),t.market.waitForData(d.M),t.getModuleBySymbol(s.y.PINS),t.market.waitForData(E.R)]);this.data=i,this.settings=n,this.cameraData=a,this.pinRenderer=r.pinRenderer,this.viewData=t.market.tryGetData(T.P5)||new T.P5(this.data),t.market.register(this,T.P5,this.viewData),this.viewData.setViewDataFactory(this.makeViewDataForMattertag),this.updateViewData(),this.settings.onPropertyChanged(y.re,(e=>{0!==e&&this.viewData.closeOpenBillboard()})),this.bindings.push(t.subscribe(I.tP,this.onDiscHoverChange),t.subscribe(I.F7,this.onDiscClicked),t.subscribe(h.Z,this.onSweepExit),t.subscribe(c.Z,this.onViewmodeChange),t.subscribe(m.bS,this.onAppChange),this.cameraData.onChanged(this.onCameraUpdate),this.data.onChanged(this.updateViewData),this.viewData.onOpenTagChanged(this.handleOpenBillboardChanged),this.viewData.activeBillboards.onChanged(this.updateViewData),t.commandBinder.addBinding(P.n,this.filterVisibleTags),t.commandBinder.addBinding(P.E,this.tagVisbilityFilterEnabled)),this.engine.commandBinder.addBinding(f.Y,(async e=>this.navigateToTag(e.sid,e.transition,e.navigateToDisabled)))}openBillboard(e){const t=this.viewData.tagCapabilities[e];t&&!t.opening||this.viewData.openBillboard(e)}closeBillboard(e){this.viewData.closeBillboard(e)}async navigateToTag(e,t,i=!1){if(this.settings.tryGetProperty(w.RY,!1))return;const n=this.data.getTag(e);if(!n)throw new Error("No tag with that sid was found");if(!n.enabled&&!i)throw new Error("Cannot navigate to a disabled mattertag");const a=this.viewData.tagCapabilities[e];if(a&&!a.navigating)return;this.viewData.setNavigatingTag(e);const s=this.viewData.activeBillboards.get(e),o=s&&s.direction,r=this.tagDirectionToOrientationAdjust(o);return this.engine.commandBinder.issueCommand(new D.OR({pinPosition:n.getPin(),transition:t,orientationAdjust:r,onSweepChosen:this.onSweepChosen})).then((()=>{this.viewData.setSelectedTag(e),this.onTagVisited(e),this.openBillboard(e),this.viewData.setNavigatingTag(null),this.viewData.setNavigatingPosition(void 0)})).catch((e=>{this.log.debug(e),this.viewData.setNavigatingTag(null),this.viewData.setNavigatingPosition(void 0)}))}onTagVisited(e){this.viewData.visitTag(e),this.engine.broadcast(new l.dJ(e,p.V.OPEN)),this.engine.broadcast(new l.QY(e))}discHoverChange(e,t){if(this.settings.tryGetProperty(w.RY,!1))return;if(!this.data.getTag(e))return;const i=this.viewData.openTag===e;t&&!i?(this.currentApp===g.Mx.SHOWCASE&&this.engine.broadcast(new l.dJ(e,p.V.HOVER)),this.openBillboard(e),this.pinRenderer.setPinColorVariant(e,A.K_.HIGHLIGHTED)):!t&&i&&(this.closeBillboard(e),this.pinRenderer.setPinColorVariant(e,A.K_.DEFAULT)),this.viewData.commit()}tagDirectionToOrientationAdjust(e,t=new n.Quaternion){const i=.25;let a=0,s=0;if(e){switch(e){case T.Pg.RIGHT:case T.Pg.RIGHT_DOWN:case T.Pg.RIGHT_UP:a=-.25;break;case T.Pg.LEFT:case T.Pg.LEFT_DOWN:case T.Pg.LEFT_UP:a=i}switch(e){case T.Pg.UP:case T.Pg.LEFT_UP:case T.Pg.RIGHT_UP:s=i;break;case T.Pg.DOWN:case T.Pg.LEFT_DOWN:case T.Pg.RIGHT_DOWN:a=-.25}}else a=-.25,s=-.25;return t.setFromAxisAngle(C.f.RIGHT,s),t.multiply((new n.Quaternion).setFromAxisAngle(C.f.UP,a)),t}}},84810:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AddCommentCommand:()=>te.Df,CancelCommentChangesCommand:()=>te.oH,CancelNewNoteCommand:()=>te.gc,CloseNoteCommand:()=>te._N,Comment:()=>we,DeleteCommentCommand:()=>te.mH,DeleteNoteCommand:()=>te.sG,EditCommentCommand:()=>te.x4,FilterVisibleNotesCommand:()=>te.Gx,FocusCommentMessage:()=>ie.J,HashtagData:()=>ee.c,Note:()=>Y,NoteColorVariant:()=>z.Y,NoteResolutionChangeMessage:()=>ie.h,NotesData:()=>Q,NotesFilter:()=>z.$,NotesModeToggleCommand:()=>te.yK,NotesPhase:()=>G.U,NotesViewData:()=>X.X,NotesVisibilityFilterEnabledCommand:()=>te.GV,OpenNoteCommentCommand:()=>te.yP,ResolveNoteCommand:()=>te.yp,SaveNewNoteCommand:()=>te.FB,SaveNoteAppearanceCommand:()=>te.oE,SaveNoteChangesCommand:()=>te.kd,StartNewNoteCommand:()=>te.VI,ToggleNoteToolEditorCommand:()=>te.df,ToggleNotesFilterCommand:()=>te.RO,UpdateCommentCommand:()=>te.Uw,default:()=>Le});var n=i(97542),a=i(57956),s=i(35895),o=i(5823),r=i(87926),d=i(28636),l=i(39880),h=i(64918),c=i(52528),m=i(95160),u=i(76631),p=i(40964),g=i(89549),v=i(91380),y=i(92211),w=i(20436),b=i(66197),f=i(5686),T=i(10374),D=i(53954),C=i(23254),P=i(34029),A=i(5135),I=i(79727),E=i(80742),k=i(14630),S=i(64773),N=i(12039),O=i(72936),M=i(62612),V=i(60083),B=i(13132),x=i(43470),R=i(86283),F=i(16935),L=i(5604),H=i(44877),U=i(35446),j=i(21149),G=i(38965),z=i(22744),_=i(84428),$=i(75287),W=i(10385),K=i(67622),J=i(39693);class Y extends $.T{constructor(e){super(),this.id="",this.layerId="",this.color=J.Rn,this.anchorPosition=new _.Vector3,this.stemNormal=new _.Vector3,this.stemLength=J.ZP.stem.length,this.stemEnabled=!0,this.created=new Date,this.modified=new Date,this.lastCommentMs=(new Date).getTime(),this.resolved=!1,this.user=(0,K.Q)(""),this.comments=(0,W.C)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.resolved=e.resolved,this.color=e.color,this.floorId=e.floorId,this.roomId=e.roomId,this.anchorPosition.copy(e.anchorPosition),this.stemNormal.copy(e.stemNormal),this.stemLength=e.stemLength,this.stemEnabled=e.stemEnabled,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.lastCommentMs=e.lastCommentMs,this.comments.replace(e.comments.values()),this.commit(),this}getComment(e){return this.comments.find((t=>t.id===e))||null}updateComment(e){const t=this.comments.findIndex((t=>t.id===e.id));-1!==t&&(e.assetId=this.id,this.comments.update(t,e))}deleteComment(e){const t=this.comments.findIndex((t=>t.id===e));-1!==t&&this.comments.splice(t,1)}}var q=i(67992),Z=i(15637);class Q extends q.V{constructor(e){super(),this.name="notes-data",this.notes=(0,Z.q)(e)}iterate(e){for(const t of this.notes)e(t)}updateNote(e){this.notes.has(e.id)?this.notes.get(e.id).copy(e):this.notes.set(e.id,e)}updateNoteProperties(e,t){if(this.notes.has(e)){const i=this.notes.get(e);let n=!1;void 0!==t.resolved&&t.resolved!==i.resolved&&(i.resolved=t.resolved,n=!0),void 0!==t.color&&t.color!==i.color&&(i.color=t.color,n=!0),void 0!==t.anchorPosition&&t.anchorPosition!==i.anchorPosition&&(i.anchorPosition=t.anchorPosition,n=!0),void 0!==t.stemNormal&&t.stemNormal!==i.stemNormal&&(i.stemNormal=t.stemNormal,n=!0),void 0!==t.stemLength&&t.stemLength!==i.stemLength&&(i.stemLength=t.stemLength,n=!0),void 0!==t.stemEnabled&&t.stemEnabled!==i.stemEnabled&&(i.stemEnabled=t.stemEnabled,n=!0),void 0!==t.floorId&&t.floorId!==i.floorId&&(i.floorId=t.floorId,n=!0),void 0!==t.roomId&&t.roomId!==i.roomId&&(i.roomId=t.roomId,n=!0),n&&i.commit()}}removeNote(e){this.notes.has(e)&&(this.notes.delete(e),this.commit())}getNote(e){return this.notes.get(e)}getNoteProperties(e){const t=this.notes.get(e);if(!t)return null;return Object.assign({},t)}get collection(){return this.notes}}var X=i(66291),ee=i(10359),te=i(24696),ie=i(35004),ne=i(17788),ae=i(97998),se=i(63665),oe=i(65222),re=i(40731),de=i(2569);const le=new ae.Z("mds-note-serialize");class he{constructor(){this.getNoteDetails=(e,t,i)=>{const n={enabled:!0,floorId:"",roomId:void 0};void 0!==e.floorId&&""!==e.floorId&&(n.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(n.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(n.color=e.color),void 0!==e.stemEnabled&&(n.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(n.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,re.u)(e.anchorPosition)&&(n.anchorPosition=de.ep.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,re.u)(e.stemNormal)&&(n.stemNormal=de.ep.toVisionVector(e.stemNormal)),void 0!==e.resolved&&(n.resolution=e.resolved?o.d7.RESOLVED:o.d7.OPEN),i&&e.layerId&&(n.layerId=e.layerId);const a={text:t};return n.comment=a,Object.keys(n).length>0?n:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","enabled"].filter((t=>!(t in e))),i=0===t.length,n=!!e.floorId&&"string"==typeof e.floorId,a=!!e.anchorPosition&&(0,re.u)(e.anchorPosition),s=i&&n&&a;return s||le.debug("Note invalid:",{missingFields:t,validPosition:a}),s}}serialize(e,t,i){const n=this.getNoteDetails(e,t,i);return this.validate(n)?n:null}}class ce{constructor(){this.getNotePatch=(e,t)=>{if(!e)return null;const i={};return void 0!==e.floorId&&""!==e.floorId&&(i.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(i.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(i.color=e.color),void 0!==e.stemEnabled&&(i.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(i.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,re.u)(e.anchorPosition)&&(i.anchorPosition=de.ep.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,re.u)(e.stemNormal)&&(i.stemNormal=de.ep.toVisionVector(e.stemNormal.normalize())),t&&e.layerId&&(i.layerId=e.layerId),Object.keys(i).length>0?i:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","color","anchorPosition","stemNormal","stemLength","stemEnabled","stemNormal","enabled"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e,t){const i=this.getNotePatch(e,t);return i&&this.validate(i)?i:null}}var me=i(9133),ue=i(37519);function pe(e){const t=Object.assign({modelAccess:o.x6.PUBLIC},e);return t.__typename&&delete t.__typename,t}const ge=new ae.Z("mds-note-deserializer");class ve{constructor(e,t){this.commentDeserializer=e,this.userData=t,this.validate=e=>{if(!e)return!1;const t=["id","created","modified","floor","resolution"].filter((t=>!(t in e))),i=0===t.length,n=!(!e.floor||!e.floor.id);return i&&n||ge.debug("Note invalid:",{missingFields:t,validFloor:n}),i&&n}}deserialize(e){var t;if(!e||!this.validate(e)||!e.floor)return ge.debug("Deserialized invalid Note data from MDS",e),null;const i=new Y;i.id=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,e.room&&e.room.id&&(i.roomId=e.room.id),i.resolved=e.resolution===o.d7.RESOLVED,i.created=(0,me.p)(e.created),i.modified=(0,me.p)(e.modified),i.user=this.userData.loadContributor(pe(e.createdBy)),i.lastCommentMs=(0,me.p)(e.lastCommentAt).getTime();const n=this.deserializeComments(e);if(!(n.length>0))return ge.error("Note without a comment:",i.id),null;i.comments.replace(n),e.color&&(i.color=e.color);const a=e.anchorPosition?de.ep.fromVisionVector(e.anchorPosition):void 0;a&&(i.anchorPosition=a),(0,ue.hj)(e.stemLength)&&(i.stemLength=e.stemLength);const s=e.stemNormal?de.ep.fromVisionVector(e.stemNormal):void 0;return s?(i.stemNormal=s,i.stemEnabled=!!e.stemEnabled):(i.stemNormal=new _.Vector3(0,0,0),i.stemEnabled=!!e.stemEnabled),i}deserializeComments(e){var t;const i=(null===(t=e.comments)||void 0===t?void 0:t.results)||[],n=[];return i.forEach((t=>{const i=this.commentDeserializer.deserialize(t);i&&(i.assetId=e.id,n.push(i))})),n}}class ye{constructor(){this.validate=e=>!!e}serialize(e){if(void 0===e.text)return null;const t={text:e.text};return t&&this.validate(t)?t:null}}class we extends $.T{constructor(e){super(),this.id="",this.assetId="",this.text="",this.user=(0,K.Q)(""),this.created=new Date,this.modified=new Date,this.edited=!1,this.attachments=(0,W.C)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.assetId=e.assetId,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.text=e.text,this.edited=e.edited,this.attachments=e.attachments,this.commit(),this}}const be=new ae.Z("mds-comment-deserializer");class fe{constructor(e,t,i){this.fileDeserializer=e,this.embedDeserializer=t,this.userData=i}deserialize(e){if(!e||!this.validate(e))return be.debug("Deserialized invalid Comment data from MDS",e),null;const t=new we;t.id=e.id,t.created=(0,me.p)(e.created),t.modified=(0,me.p)(e.modified),e.text&&(t.text=e.text),t.edited=e.edited,t.user=this.userData.loadContributor(pe(e.createdBy));const i=this.deserializeExternalAttachments(e),n=this.deserializeFileAttachments(e),a=i.concat(n).sort(((e,t)=>e.created.getTime()-t.created.getTime()));return a.length>0&&t.attachments.replace(a),t}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{const n=this.embedDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=o.ud.COMMENT,i.push(n))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{const n=this.fileDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=o.ud.COMMENT,i.push(n))})),i}validate(e){if(!e)return!1;const t=["id","created","modified","edited","createdBy"].filter((t=>!(t in e))),i=0===t.length;return i||be.debug("Comment invalid:",{missingFields:t}),i}}var Te=i(44571),De=i(36159);const Ce=new ae.Z("MdsNoteStore");class Pe extends ne.u{constructor(e,t){super(e),this.userData=t,this.prefetchKey="data.model.notes",this.layeredType=o.SF.NOTE,this.embedDeserializer=new se.d,this.fileDeserializer=new oe.O,this.commentDeserializer=new fe(this.fileDeserializer,this.embedDeserializer,this.userData),this.deserializer=new ve(this.commentDeserializer,this.userData),this.createSerializer=new he,this.patchSerializer=new ce,this.commentSerializer=new ye}async read(e){const t={modelId:this.getViewId(),ids:null,includeLayers:!!ne.u.currentLayerId};return this.query(Te.GetNotes,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;if(!n||!Array.isArray(n))return{};const a=[];for(const e of n){const t=this.deserializer.deserialize(e);t&&a.push(t)}return a.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async readNote(e,t){const i={modelId:this.getViewId(),ids:[e],includeLayers:!!ne.u.currentLayerId};return this.query(Te.GetNotes,i,t).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;return n&&Array.isArray(n)&&1===n.length?this.deserializer.deserialize(n[0]):null}))}async create(e,t){const i=this.getViewId(),n=this.createSerializer.serialize(e,t,this.shouldWriteLayerId());if(!n)throw Ce.error("Failure creating note:",e.id,e),new Error("Could not create Note");const a={modelId:i,data:n,includeLayers:!!ne.u.currentLayerId};return this.mutate(Te.AddNote,a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.addNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.addNote):null}))}async update(e){const t=this.getViewId(),i=e.id,n=this.patchSerializer.serialize(e,this.shouldWriteLayerId());if(!n||!i)throw Ce.error("Failure updating note:",i),new Error("Could not update Note");const a={modelId:t,noteId:i,data:n,includeLayers:!!ne.u.currentLayerId};return this.mutate(Te.PatchNote,a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchNote):null}))}async updateResolution(e,t){const i={modelId:this.getViewId(),noteId:e};return t?this.mutate(Te.ResolveNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.resolveNote})):this.mutate(Te.ReopenNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.reopenNote}))}async delete(e){const t=this.getViewId();for(const i of e)await this.mutate(Te.DeleteNote,{modelId:t,noteId:i.id})}async createComment(e,t){const i=this.getViewId(),n=this.commentSerializer.serialize(t);if(!n)throw Ce.error("Failure creating comment:",t),new Error("Could not create Comment");const a={modelId:i,noteId:e,data:n};return this.mutate(Te.AddNoteComment,a).then((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.addNoteComment)?this.commentDeserializer.deserialize(e.data.addNoteComment):null}))}async updateComment(e){const t=this.getViewId(),i=e.id,n=this.commentSerializer.serialize(e);if(!n||!i)throw Ce.error("Failure updating comment:",i),new Error("Could not update Comment");const a={modelId:t,commentId:i,data:n};return this.mutate(De.PatchComment,a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchComment)?this.commentDeserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchComment):null}))}async deleteComment(e){const t=this.getViewId();if(!e||!(null==e?void 0:e.id))throw new Error("MdsNoteStore.deleteComment failed");const i={modelId:t,commentId:e.id};await this.mutate(De.DeleteComment,i)}}var Ae=i(54244),Ie=i(89570),Ee=i(71166),ke=i(25071),Se=i(35221),Ne=i(56163);class Oe extends Ne.K{constructor(e,t,i,n,a,s){super(e,t),this.comment=i,this.note=n,this.textParser=a,this.asWholeNote=s,this.id=this.comment.id,this.parentId=this.note.id,this.title=this.comment.user.name,this.description=this.textParser.getPlainText(this.comment.text),this.icon="icon-comment",this.typeId=o.SF.NOTE,this.floorId=this.note.floorId,this.layerId=this.note.layerId,this.dateBucket=this.getNoteOrCommentDateBucket(),this.color=this.note.color,this.resolved=this.note.resolved,this.numAttachments=this.comment.attachments.length,this.numComments=this.note.comments.length,this.user=this.comment.user,this.enabled=!this.note.resolved,this.onSelect=async()=>{super.onSelect();const e=!(0,ke.OR)();this.commandBinder.issueCommand(new te.yP(this.note.id,e,!1,this.comment.id))}}getNoteOrCommentDateBucket(){return(0,Se.f)(new Date(this.asWholeNote?this.note.lastCommentMs:this.comment.created))}}var Me=i(38399);const{NOTES:Ve}=Me.Z.SHOWCASE;var Be=i(635),xe=i(79728),Re=i(28022);class Fe extends n.Y{constructor(){super(...arguments),this.name="notes",this.activated=!1,this.registered=!1,this.activeBindings=[],this.refreshPromise=null,this.pollOnNotes=()=>{let e;return(0,s.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.refreshNotes()}),1e3*J.GR)}),(()=>{window.clearInterval(e)}),!0)},this.modelViewChanged=()=>{this.cancelNoteCreation(!0)},this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(J.Mp,!1),t=!this.in360View(),i=!this.interactionmodeData.isVR(),n=t&&i&&e,a=n?this.getFilteredNoteIds(!1):[];this.engine.commandBinder.issueCommand(new O.kb(M.Er.NOTE,n?1:0,a)),n||this.closeNoteBillboard()},this.toggleNotesMode=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.togglePinAssetEditor=async e=>{this.viewData.setActiveNotation(null),e.opened?this.changeNotesPhase(G.U.EDITING):this.viewData.notesPhase===G.U.EDITING&&this.changeNotesPhase(G.U.OPEN)},this.toggleNotesFilter=async e=>{const{filter:t,enabled:i}=e;i?this.viewData.setNotesFilter(t):this.viewData.setNotesFilter(z.$.ALL)},this.openNoteToComment=async e=>{const{noteId:t,commentId:i,dock:n,edit:a,transition:s}=e,o=this.viewData,r=o.getNoteView(t);if(!r)return void this.log.error(`Missing note ${t}`);const{notesFilter:d}=o,l=d===z.$.RESOLVED;d!==z.$.ALL&&r.resolved!==l&&o.setNotesFilter(z.$.ALL);const c=n||a,m=this.toolsData.toolPanelLayout===u.wS.SIDE_PANEL?h.n.FadeToBlack:h.n.Instant;await this.openNote(t,s||m,c,i,a),this.openAnnotation(t,c)},this.onAppChange=()=>{this.deactivateTool(),this.updatePerSettings(),this.displayNotes()},this.onNotesPhaseChanged=()=>{let e=!0;const t=this.toolsData.toolPanelLayout===u.wS.BOTTOM_PANEL;switch(this.viewData.notesPhase){case G.U.EDITING:case G.U.CREATING:e=!1;break;case G.U.OPENING:case G.U.OPEN:e=!t}this.engine.broadcast(new p.ps(e))},this.changeNotesPhase=e=>{e!==this.viewData.notesPhase&&this.viewData.setNotesPhase(e)},this.onCloseNote=async()=>{this.closeNote()},this.pinAddCancelled=e=>{e.pinType===M.Er.NOTE&&this.cancelNoteCreation(!1)},this.onCancelNewNote=async()=>{this.cancelNoteCreation(!0)},this.cancelNoteCreation=e=>{var t;if(!this.userData.isCommenter())return;const i=this.viewData,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id;n&&(e&&this.engine.commandBinder.issueCommand(new O.tT(n,M.Er.NOTE)),this.engine.commandBinder.issueCommand(new x.Aj(n,R.J.NOTE))),this.cancelAttachmentChanges(),i.setActiveNotation(null),i.setOpenNoteView(null),i.setFocusedComment(null),i.isNewNote=!1,i.commit(),this.changeNotesPhase(G.U.IDLE)},this.notesWereChanged=()=>{this.parseNotes(),this.updateNoteViewData(),this.displayNotes()},this.onNoteFilterChanged=()=>{this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),this.updateNoteViewData(),this.displayNotes()},this.onViewModeOrFloorChanged=()=>{this.updatePerSettings()},this.onLayersChanged=()=>{this.closeNoteBillboard(),this.displayNotes()},this.onOpenNoteViewChanged=()=>{const e=this.viewData.openNoteView;e&&this.updateNotePin(e)},this.startNoteCreation=async()=>{if(!this.userData.isCommenter())return;this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!1));const e=this.viewData,t=this.appData.application===Ae.Mx.WORKSHOP;let i=(0,l.O1)(11);for(;this.notesData.getNote(i);)i=(0,l.O1)(11);const n=new Y;n.user=this.userData.getCurrentUser(),n.id=i,n.floorId=this.floorsViewData.getHighestVisibleFloorId(),n.layerId=this.layersData.getNotesLayerId(t);const a=e.createNoteView(n);e.isNewNote=!0,e.commit(),this.changeNotesPhase(G.U.CREATING),e.setOpenNoteView(a),e.setFocusedComment(null),this.engine.commandBinder.issueCommand(new O.fM(n.id,a,M.Er.NOTE,a.backgroundTexture))},this.saveNewNote=async e=>{if(!this.userData.isCommenter())return;const{text:t}=e,i=this.viewData,n=i.getPendingNote();if(n){if(this.layersData.isInMemoryLayer(n.layerId)){const e=new Y(n);return this.notesData.updateNote(e),i.setActiveNotation(null),i.isNewNote=!1,i.commit(),void this.updateNoteViewData()}const e=await this.store.create(n,t);if(!e)return void this.log.error("MDS Note saved failed");const a=e.comments.get(0);if(!a)throw new Error("No root comment in the new note");const s=await this.confirmAttachmentChanges(a.id,n.id);this.notesData.updateNote(e),s&&await this.refreshNote(e.id),this.parseMarkdown(t),i.setOpenNoteView(i.getNoteView(e.id));const o=i.openNoteView;if(o){const t=(0,H.C)(this.userData,R.J.NOTE,o.user);this.engine.commandBinder.issueCommand(new O.Ar(e.id,M.Er.NOTE,t)),this.engine.commandBinder.issueCommand(new O.OL(n.id,M.Er.NOTE))}i.setActiveNotation(null),i.isNewNote=!1,i.commit(),this.updateNoteViewData()}else this.log.debug("No pending note")},this.pinMoved=async e=>{const{id:t,pinType:i,pinPos:n}=e,a=this.viewData.openNoteView;if(a&&i===M.Er.NOTE&&t===a.id){const e=this.notesData.getNote(t);if(e){if(this.layersData.isInMemoryLayer(e.layerId))return;const{anchorPosition:i,stemNormal:a,floorId:s,roomId:o}=n;this.store.update({id:t,anchorPosition:i,stemNormal:a,floorId:s,roomId:o}).then((e=>{e&&this.notesData.updateNote(e)}))}else this.log.debug("Cannot move a non-existent note")}},this.pinPlaced=e=>{const t=this.viewData.openNoteView;t&&e.pinType===M.Er.NOTE&&e.id===t.id&&(this.viewData.updateOpenNoteView(e.pinPos),this.changeNotesPhase(G.U.OPEN),this.viewData.setActiveNotation(t.id),this.openAnnotation(t.id,!0))},this.onEditComment=async e=>{this.viewData.setActiveNotation(e.id)},this.handlePinFocusChange=async()=>{const{openNoteView:e,isNewNote:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPinId:a}=this.pinsViewData,{billboardAnnotation:s,billboardSelected:o}=this.annotationsViewData;if(!n)return void(s&&s.annotationType===R.J.NOTE&&s.id!==a&&this.closeNoteBillboard());const r=(null==e?void 0:e.id)===(null==s?void 0:s.id)&&o,d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeNote(),n.pinType===M.Er.NOTE){const t=this.viewData.getNoteView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no note view.");t.id!==(null==e?void 0:e.id)&&i.issueCommand(new x.Kw(t.id,R.J.NOTE))}},this.handleAnnotationsChanged=async()=>{const{openNoteView:e,isNewNote:t,focusedComment:i}=this.viewData;if(t)return;const{dockedAnnotation:n,selectedAnnotation:a}=this.annotationsViewData,s=n||a,o=(null==n?void 0:n.annotationType)===R.J.NOTE&&n,r=(null==a?void 0:a.annotationType)===R.J.NOTE&&a,d=o||r,l=!!o;d&&d.id!==(null==e?void 0:e.id)?await this.openNote(d.id,null,l):e&&e.id!==(null==s?void 0:s.id)&&this.closeNote(),l?(this.activated||await this.engine.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!0)),i&&this.engine.broadcast(new ie.J(i.id))):this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new g.CH(u.w1.NOTES))},this.handlePinSelectionChange=async()=>{const{openNoteView:e,activeNotation:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null;if(!e||n&&n.pinType===M.Er.NOTE){if(i&&n&&n.pinType===M.Er.NOTE){const e=!0;await this.openNote(i,h.n.Interpolate,e),this.openAnnotation(i,e)}}else this.activated?this.deactivateTool():this.closeNote()},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==R.J.NOTE)return;const a=this.viewData.getNoteAttachments(i),s=a.find((e=>e.id===n));if(s&&(0,j.lV)(s)){const e=a.filter((e=>(0,j.lV)(e)));this.engine.commandBinder.issueCommand(new U.xW(!0,e,n))}},this.deleteNote=async e=>{const t=e.noteId,i=this.notesData.getNote(t);if(i){this.engine.commandBinder.issueCommand(new y.rE),this.layersData.isInMemoryLayer(i.layerId)||this.store.delete([i]),this.notesData.removeNote(t);const e=this.viewData.openNoteView;e&&e.id===t&&this.closeNote(),this.engine.commandBinder.issueCommand(new O.OL(t,M.Er.NOTE))}else this.log.debug("Cannot delete a non-existent note")},this.onResolveNoteCommand=async e=>{const{noteId:t,resolved:i}=e;i?await this.resolveNote(t):await this.reopenNote(t)},this.onSaveNoteChanges=async e=>{const{noteId:t,text:i}=e,n=this.notesData.getNote(t);if(n){const e=n.comments.get(0);if(e)return this.updateNoteComment(t,e.id,i);this.log.warn("no root comment")}else this.log.debug("Cannot update a non-existent note")},this.cancelCommentChanges=async e=>{this.cancelAttachmentChanges(),this.viewData.setActiveNotation(null)},this.saveNoteAppearance=async e=>{const t=this.notesData,{noteId:i,properties:n}=e,a=t.getNote(i);if(a){const e=this.viewData,{openNoteView:s}=e;if(Object.keys(n)){const o=this.layersData.isInMemoryLayer(a.layerId)?Object.assign(a,n):await this.store.update(Object.assign({id:i},n));o&&(this.updateNotePin(o),t.updateNote(o),(null==s?void 0:s.id)===i&&e.updateOpenNoteView(n))}}else this.log.debug("Cannot update a non-existent note")},this.addComment=async e=>{const{noteId:t,text:i,replyId:n}=e,a=this.notesData.getNote(t);if(a){a.resolved&&(this.viewData.setNotesFilter(z.$.ALL),this.reopenNote(a.id));const e=await this.store.createComment(t,{text:i});return e?(this.viewData.setActiveNotation(null),this.parseMarkdown(i),await this.confirmAttachmentChanges(e.id,n),await this.refreshNote(a.id),this.refreshNotes(),e):(this.log.error("Cannot create MDS comment"),null)}return this.log.debug("Cannot add a comment to a non-existent note"),null},this.onUpdateComment=async e=>{const{noteId:t,commentId:i,text:n}=e;return this.updateNoteComment(t,i,n)},this.deleteComment=async e=>{const{commentId:t,noteId:i}=e,n=this.notesData.getNote(i);if(n){const e=n.getComment(t);e&&(this.layersData.isInMemoryLayer(n.layerId)||await this.store.deleteComment(e),n.deleteComment(t)),this.refreshNotes()}else this.log.debug("Cannot delete a comment in a non-existent note")},this.notationBlockClicked=async e=>{const{annotationType:t,block:i}=e;t===R.J.NOTE&&(i.blockType!==m.C.USER&&i.blockType!==m.C.HASH||(this.activated&&!this.toolsData.softOpening||await this.engine.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!1)),this.engine.commandBinder.issueCommand(new Ee.H1(i.text||"")),i.text&&this.closeNote()))},this.filterVisibleNotes=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayNotes()},this.noteVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayNotes()}}async init(e,t){const[i,n,s,l]=await Promise.all([t.market.waitForData(P.e),t.market.waitForData(A.Z),t.market.waitForData(w.m),t.market.waitForData(Ae.pu)]);if(!s.isLoggedIn()||n.isVR()||!i.tryGetProperty(J.IA,!1))return;this.engine=t,this.config=e,this.interactionmodeData=n,this.userData=s,this.settingsData=i,this.appData=l;const[h,m,u,p,g,y,b]=await Promise.all([t.market.waitForData(v.t),t.market.waitForData(D.Z),t.market.waitForData(C.O),t.market.waitForData(I.c),t.market.waitForData(F.A),t.getModuleBySymbol(a.y.DEEP_LINKS),t.market.waitForData(E.R)]);this.toolsData=h,this.sweepData=m,this.viewmodeData=u,this.floorsViewData=p,this.annotationsViewData=g,this.linkHandler=y,this.layersData=b;const{readonly:f,baseUrl:N}=this.config;this.store=new Pe({readonly:f,includeDisabled:!0,baseUrl:N},this.userData);const O=()=>{this.store.setStoreViewId(b.getNonworkshopViewId())};O(),this.bindings.push(this.store.onNewData(this.loadNewNotes.bind(this)),b.onPropertyChanged("currentViewId",O)),this.notesData=new Q({}),this.textParser=new c.v({links:!0,hashtags:!0,users:this.userData}),this.backgroundTexture=(0,r.p)(d),this.viewData=new X.X(this.notesData,this.textParser,this.linkHandler,this.backgroundTexture),this.hashtagData=new ee.c,t.market.register(this,ee.c,this.hashtagData),this.pinsViewData=await t.market.waitForData(V.B),this.bindings.push(i.onPropertyChanged(J.Mp,this.updatePerSettings),t.commandBinder.addBinding(te.yK,this.toggleNotesMode),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),g.onChanged(this.handleAnnotationsChanged),t.subscribe(L.q,this.handleViewingAttachment),t.subscribe(L.i,this.notationBlockClicked),t.commandBinder.addBinding(te.yP,this.openNoteToComment),t.subscribe(T.bS,this.onAppChange),u.makeModeChangeSubscription(this.onViewModeOrFloorChanged),p.makeFloorChangeSubscription(this.onViewModeOrFloorChanged),t.subscribe(k.Z,this.updatePerSettings),t.subscribe(S.m,this.updatePerSettings),this.layersData.onCurrentLayersChanged(this.onLayersChanged),t.commandBinder.addBinding(te.Gx,this.filterVisibleNotes),t.commandBinder.addBinding(te.GV,this.noteVisbilityFilterEnabled),this.pollOnNotes(),this.viewData.onOpenNoteViewChanged(this.onOpenNoteViewChanged),this.notesData.onChanged(this.notesWereChanged),this.notesData.collection.onElementChanged({onAdded:this.updateNotePin.bind(this),onUpdated:this.updateNotePin.bind(this),onRemoved:this.removeNotePin.bind(this)}),t.subscribe(Re.Y,this.modelViewChanged)),t.market.register(this,X.X,this.viewData),this.updatePerSettings(),this.parseNotes(),async function(e,t,i,n,a,s,r){let d=n.application===Ae.Mx.WORKSHOP;const l=(n,s,o=[])=>{const r=[],l=t.getFilteredNotesMap().values,h=!s,c=[];return 0===o.length&&l.forEach((t=>{if(!d&&!i.layerToggled(t.layerId))return;let s=0;t.comments.forEach(((o,d)=>{h&&d>0||n(o.user.name,a.getPlainText(o.text))&&(s++,r.push(new Oe(e,i,o,t,a,h)))})),s>0&&c.push(t.id)})),e.issueCommand(new te.Gx(c)),r},h=t=>{e.issueCommand(new te.GV(!!t))},c=e=>new Ie.V(t.getFilteredNotesMap().onChanged(e),s.onChanged(e)),m={renew:()=>{e.issueCommandWhenBound(new Ee.c6({id:o.SF.NOTE,groupPhraseKey:Ve.SEARCH_GROUP_HEADER_NOTES,groupMatchingPhraseKey:Ve.SEARCH_GROUP_HEADER,getSimpleMatches:l,registerChangeObserver:c,onSearchActivatedChanged:h,groupOrder:50,groupIcon:"comment-outline"}))},cancel:()=>{e.issueCommandWhenBound(new Ee.Pe(o.SF.NOTE))}},u=()=>{d=n.application===Ae.Mx.WORKSHOP,r.tryGetProperty(J.IA,!1)||d?m.renew():m.cancel()},p=n.onPropertyChanged("application",u),g=r.onPropertyChanged(J.IA,u);return u(),new Ie.V(m,p,g)}(t.commandBinder,this.viewData,this.layersData,l,this.textParser,this.userData,this.settingsData).then((e=>this.bindings.push(e))),await this.refreshNotes(),t.market.register(this,Q,this.notesData)}dispose(e){this.deactivateTool(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new O.zM(M.Er.NOTE)),this.backgroundTexture.dispose(),this.store.dispose(),super.dispose(e)}onUpdate(){}async refreshNotes(){if(this.refreshPromise)return;const e=this.viewData,{isNewNote:t,notesPhase:i}=e;t||i===G.U.EDITING||(this.refreshPromise=this.store.refresh().finally((()=>{this.refreshPromise=null})))}loadNewNotes(e){var t;const{viewData:i}=this,n=Object.values(e),a=null===(t=i.openNoteView)||void 0===t?void 0:t.id,{collection:s}=this.notesData;this.notesData.atomic((()=>{const t=s.keys.filter((t=>!this.layersData.isInMemoryLayer(s.get(t).layerId)&&!e[t]));t.length&&t.forEach((e=>{e===a&&(this.log.debug("Open note was deleted"),i.setOpenNoteView(null),i.setFocusedComment(null),i.setActiveNotation(null),i.setNotesPhase(G.U.IDLE)),s.delete(e)})),n.length&&n.forEach((e=>{this.notesData.updateNote(e)}))}))}async refreshNote(e){if(this.refreshPromise)return;const t=this.notesData.getNote(e);if(this.layersData.isInMemoryLayer(null==t?void 0:t.layerId))this.notesData.updateNote(t);else{const t=await this.store.readNote(e);t&&this.notesData.updateNote(t)}}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new x.yL(R.J.NOTE)),this.userData.isCommenter()&&this.engine.commandBinder.issueCommand(new O.Ki(!0)),this.changeNotesPhase(G.U.IDLE),this.updateNoteViewData(),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0)}deactivateTool(e){var t;if(!this.activated)return;this.engine.commandBinder.issueCommand(new O.iK);const{isNewNote:i,openNoteView:n}=this.viewData,a=(null===(t=this.annotationsViewData.dockedAnnotation)||void 0===t?void 0:t.annotationType)===R.J.NOTE;i?this.cancelNoteCreation(!0):n&&(e||a)&&this.closeNote(),this.changeNotesPhase(G.U.CLOSED),this.engine.commandBinder.issueCommand(new O.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.activated=!1}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(B.b0,this.pinPlaced),this.engine.subscribe(B.bV,this.modifyInsideSaveCommand(this.pinMoved)),this.engine.subscribe(B.hu,this.pinAddCancelled),e.addBinding(te.VI,this.startNoteCreation),e.addBinding(te.FB,this.modifyInsideSaveCommand(this.saveNewNote)),e.addBinding(te.gc,this.onCancelNewNote),e.addBinding(te._N,this.onCloseNote),e.addBinding(te.kd,this.modifyInsideSaveCommand(this.onSaveNoteChanges)),e.addBinding(te.oH,this.cancelCommentChanges),e.addBinding(te.x4,this.onEditComment),e.addBinding(te.sG,this.modifyInsideSaveCommand(this.deleteNote)),e.addBinding(te.yp,this.modifyInsideSaveCommand(this.onResolveNoteCommand)),e.addBinding(te.Df,this.modifyInsideSaveCommand(this.addComment)),e.addBinding(te.Uw,this.modifyInsideSaveCommand(this.onUpdateComment)),e.addBinding(te.mH,this.modifyInsideSaveCommand(this.deleteComment)),e.addBinding(te.oE,this.modifyInsideSaveCommand(this.saveNoteAppearance)),e.addBinding(te.df,this.togglePinAssetEditor),e.addBinding(te.RO,this.toggleNotesFilter),this.viewData.onNotesFilterChanged(this.onNoteFilterChanged),this.viewData.onNotesPhaseChanged(this.onNotesPhaseChanged)),this.registered=!0}async parseNotes(){const e=[],t=[];return this.notesData.iterate((i=>{i.comments.forEach((i=>{const n=this.getUserMentionsAndHashtags(i.text);n.emails.forEach((t=>{e.push({email:t,userStatus:b.J.MENTIONED})})),t.push(...n.hashtags)}))})),this.hashtagData.addHashtags(t),this.engine.commandBinder.issueCommand(new f.Vu(e))}async parseMarkdown(e){const t=[],i=this.getUserMentionsAndHashtags(e);return i.emails.forEach((e=>{t.push({email:e,userStatus:b.J.MENTIONED})})),this.hashtagData.addHashtags(i.hashtags),this.engine.commandBinder.issueCommand(new f.Vu(t))}getUserMentionsAndHashtags(e){const t=[],i=[];for(const n of this.textParser.parse(e))n.blockType===m.C.USER&&n.value?t.push(n.value):n.blockType===m.C.HASH&&i.push(n.text);return{emails:t,hashtags:i}}closeNoteBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===R.J.NOTE&&this.engine.commandBinder.issueCommand(new x.Aj(e.id,R.J.NOTE))}openAnnotation(e,t){t?this.engine.commandBinder.issueCommand(new x.bd(e,R.J.NOTE)):this.engine.commandBinder.issueCommand(new x.oM(e,R.J.NOTE))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeNote(){var e;const{commandBinder:t}=this.engine,{openNoteView:i,notesPhase:n}=this.viewData;if(this.viewData.setActiveNotation(null),this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),n!==G.U.CLOSED&&this.changeNotesPhase(G.U.IDLE),i){const n=i.id;this.cancelAttachmentChanges(),t.issueCommand(new Ee.IL(null)),t.issueCommand(new U.xW(!1));const a=this.notesData.getNote(n);a&&(t.issueCommand(new O.RH(n,M.Er.NOTE)),t.issueCommand(new O.ik(n,M.Er.NOTE,this.getNoteVisibility(n,a.layerId,i.resolved))));(null===(e=this.annotationsViewData.dockedAnnotation)||void 0===e?void 0:e.annotationType)===R.J.NOTE&&await t.issueCommand(new x.JD)}}updateNoteViewData(){this.viewData.updateNoteViews()}getFilteredNoteIds(e){const t=[];return this.notesData.iterate((i=>{this.getNoteVisibility(i.id,i.layerId,i.resolved)===e&&t.push(i.id)})),t}getNoteVisibility(e,t,i){const{notesFilter:n,openNoteView:a,idVisibilityEnabled:s,idVisibility:o}=this.viewData,r=this.appData.application===Ae.Mx.WORKSHOP||this.layersData.layerToggled(t),d=this.layersData.layerVisible(t),l=(null==a?void 0:a.id)===e,h=!s||o.has(e),c=n===z.$.ALL||i&&n===z.$.RESOLVED||!i&&n===z.$.OPEN;return r&&(l||c&&h&&d)}displayNotes(){const e=[];this.notesData.iterate((t=>{e.push(Object.assign(Object.assign({},t),{pinType:M.Er.NOTE,backgroundTexture:this.backgroundTexture,visible:this.getNoteVisibility(t.id,t.layerId,t.resolved)}))})),this.engine.commandBinder.issueCommand(new O.mE(e))}updateNotePin(e){const t=Object.assign(Object.assign({},e),{pinType:M.Er.NOTE,backgroundTexture:this.backgroundTexture,visible:this.getNoteVisibility(e.id,e.layerId,e.resolved),icon:M.Qk[M.Er.NOTE]});this.engine.commandBinder.issueCommand(new O.mE([t]))}removeNotePin(e){this.engine.commandBinder.issueCommand(new O.OL(e.id,M.Er.NOTE))}async confirmAttachmentChanges(e,t){return this.engine.commandBinder.issueCommand(new U.iu(e,o.ud.COMMENT,t))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new U.Ze)}setFocusedNoteComment(e,t){if(t){const i=this.viewData.getComment(e,t);this.viewData.setFocusedComment(i)}else this.viewData.setFocusedComment(null)}async openNote(e,t,i,n,a){var s;const r=(null===(s=this.annotationsViewData.dockedAnnotation)||void 0===s?void 0:s.annotationType)===R.J.NOTE,d=null!==i?i:r;return this.engine.commandBinder.issueCommand(new Ee.IL(e,o.SF.NOTE)),d?this.dockNote(e,t,n,a):this.selectNote(e,t,n)}async selectNote(e,t,i){var n;const{commandBinder:a}=this.engine;this.setFocusedNoteComment(e,i);const s=this.viewData.getNoteView(e);if(s){const{openNoteView:i}=this.viewData,o=(null==i?void 0:i.id)===e,r=(null===(n=this.annotationsViewData.dockedAnnotation)||void 0===n?void 0:n.id)===e;if(o&&!r&&i)return void this.log.debug("Note is already selected");this.activated&&await a.issueCommand(new g.CH(u.w1.NOTES)),a.issueCommand(new U.xW(!1)),i&&(a.issueCommand(new x.Aj(i.id,R.J.NOTE)),a.issueCommand(new O.RH(i.id,M.Er.NOTE))),this.viewData.setOpenNoteView(s),await a.issueCommand(new O.Ar(e,M.Er.NOTE,!1)),null!==t&&await a.issueCommand(new N.OR({pinPosition:s,transition:t}))}else this.log.debug("Cannot select a non-existent note")}async dockNote(e,t,i,n=!1){var a;const{toolsData:s,viewData:o,engine:r,activated:d,userData:l}=this,h=o.getNoteView(e);if(h){const{openNoteView:c,focusedComment:m}=this.viewData,p=(null==c?void 0:c.id)===e,v=(null===(a=this.annotationsViewData.dockedAnnotation)||void 0===a?void 0:a.id)===e;if(s.toolCollapsed&&r.commandBinder.issueCommand(new g.Fg(!1)),this.setFocusedNoteComment(e,i),p&&v)return void(o.focusedComment&&i!==(null==m?void 0:m.id)&&this.engine.broadcast(new ie.J(o.focusedComment.id)));r.commandBinder.issueCommand(new y.rE),d||await r.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!0)),p||o.setOpenNoteView(h);const w=(0,H.C)(l,R.J.NOTE,h.user);if(r.commandBinder.issueCommand(new O.Ar(e,M.Er.NOTE,w)),this.changeNotesPhase(G.U.OPENING),null!==t&&await r.commandBinder.issueCommand(new N.OR({pinPosition:h,transition:t})),this.changeNotesPhase(G.U.OPEN),n){const t=h.comments.get(0);let n=i?o.getComment(e,i):void 0;if(n||(n=t),!n)throw new Error("No root comment in the note");const a=(0,H.C)(l,R.J.NOTE,n.user);o.setActiveNotation(a?n.id:null)}else o.setActiveNotation(null)}else this.log.debug("Cannot open a non-existent note")}async resolveNote(e){const t=this.notesData.getNote(e);if(t){if(t.resolved)return;this.closeNote(),await(0,l.gw)(350),this.engine.broadcast(new ie.h(e,!0));!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!0)?this.notesData.updateNoteProperties(e,{resolved:!0}):this.log.error("Resolving note failed")}else this.log.debug("Cannot resolve a non-existent note")}async reopenNote(e){const t=this.notesData.getNote(e);if(t){if(!t.resolved)return;this.viewData.updateOpenNoteView({resolved:!1});!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!1)?this.notesData.updateNoteProperties(e,{resolved:!1}):this.log.error("Reopen note failed")}else this.log.debug("Cannot reopen a non-existent note")}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new Be.VQ({dataTypes:[xe.g.NOTES],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}async updateNoteComment(e,t,i){const n=this.notesData.getNote(e);if(n){const a=this.layersData.isInMemoryLayer(n.layerId),s=n.getComment(t);if(s)if(s.user.id===this.userData.getCurrentUserId()){const r=!a&&await this.confirmAttachmentChanges(t,o.ud.COMMENT),d=i!==s.text;if(d){if(a)s.text=i;else{const e=await this.store.updateComment({id:t,text:i});e&&n.updateComment(e)}this.parseMarkdown(i)}(r||d)&&(await this.refreshNote(n.id),n.resolved&&(this.viewData.setNotesFilter(z.$.ALL),this.reopenNote(e))),this.viewData.setActiveNotation(null)}else this.log.debug("Cannot update another user's comment");else this.log.debug("Cannot update a non-existent comment")}else this.log.debug("Cannot update a comment in a non-existent note")}}const Le=Fe},95153:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>X});var n=i(97542),a=i(57956),s=i(84428),o=i(5823),r=i(64918),d=i(12039),l=i(62612),h=i(72936),c=i(60083),m=i(43470),u=i(16935),p=i(5666),g=i(59512),v=i(71166),y=i(54244),w=i(89570),b=i(86283),f=i(56163),T=i(35221),D=i(38399);const{OBJECT_TAG_SUGGESTION:C}=D.Z.WORKSHOP;class P extends f.K{constructor(e,t,i,n,a){var s,r,d;super(e.commandBinder,t),this.isEditable=i,this.suggestion=n,this.mattertag=a,this.id=this.suggestion.id,this.title=this.suggestion.displayLabel,this.description=this.suggestion.displayCategory,this.icon="icon-simple-tag",this.color=this.suggestion.color,this.enabled=this.suggestion.visible,this.typeId=o.SF.OBJECTANNOTATION,this.floorId=this.suggestion.floorId,this.dateBucket=(0,T.f)(this.suggestion.created),this.layerId=this.suggestion.layerId,this.onToggleVisible=async e=>{const{visible:t,id:i}=this.suggestion;this.commandBinder.issueCommand(new p.Q_(i,!t)),e.stopPropagation();const n=t?"object_tags_hide_click":"object_tags_show_click";this.trackEvent(n)},this.onEditClick=()=>{this.trackEvent("object_tags_edit_click"),this.commandBinder.issueCommand(new p.OD(this.suggestion.id))},this.onDeleteClick=()=>{const e=this.suggestion.id;this.commandBinder.issueCommand(new p.SO(e)),this.commandBinder.issueCommand(new h.OL(e,l.Er.OBJECT)),this.commandBinder.issueCommand(new m.Aj(e,b.J.OBJECT)),this.trackEvent("object_tags_delete_click")},this.actions=this.isEditable?[{icon:this.suggestion.visible?"eye-show":"eye-hide",tooltipKey:this.suggestion.visible?C.SEARCH_ITEM_HIDE_TOOLTIP:C.SEARCH_ITEM_SHOW_TOOLTIP,handler:this.onToggleVisible}]:void 0,this.menuActions=this.isEditable?[{labelKey:C.SEARCH_ITEM_EDIT,handler:this.onEditClick,icon:"toggle-pencil"},{labelKey:C.SEARCH_ITEM_DELETE,handler:this.onDeleteClick,className:"menu-delete-btn",icon:"delete"}]:void 0,this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new p.w$(this.suggestion.id))},this.title=(null===(s=this.mattertag)||void 0===s?void 0:s.label)?this.mattertag.label:this.suggestion.displayLabel,this.description=(null===(r=this.mattertag)||void 0===r?void 0:r.description)?this.mattertag.description:this.suggestion.displayCategory,this.color=(null===(d=this.mattertag)||void 0===d?void 0:d.color)?`#${this.mattertag.color.getHexString()}`:this.suggestion.color,this.init(e)}async init(e){this.analytics=await e.getModuleBySymbol(a.y.ANALYTICS)}trackEvent(e){this.analytics&&this.analytics.track("showcase_gui",{tool:"object_tags",gui_action:e})}}var A=i(6735);const{OBJECT_TAG_SUGGESTION:I}=D.Z.WORKSHOP;var E=i(69665),k=i(2569),S=i(17788),N=i(95724),O=i(75287),M=i(45611);class V extends O.T{constructor(e){super(),this.created=new Date,this.modified=new Date,this.sweeps=[],this.position=new s.Vector3,this.stemDirection=new s.Vector3,this.stemLength=M.Kn,this.stemEnabled=!1,this.enabled=!0,e&&(Object.assign(this,e),this.keywords=e.keywords||[])}get displayLabel(){return this.localizedName?this.localizedName:this.label}get displayCategory(){return this.localizedCategory?this.localizedCategory:""}get visible(){return this.enabled}set visible(e){this.enabled=e,this.commit()}getMattertagOptions(){return{color:new s.Color(this.color),description:this.displayCategory,enabled:!0,floorId:this.floorId,label:this.displayLabel,normal:this.stemDirection.clone(),objectAnnotationId:this.id,position:this.position.clone(),stemHeight:this.stemLength,stemVisible:!0,keywords:this.keywords.slice()}}getPin(e){return{id:this.id,floorId:this.floorId,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemEnabled:!1,stemLength:M.Kn,layerId:this.layerId,color:e?`#${e.color.getHexString()}`:this.color,roomId:this.roomId}}toTagView(e){return{id:this.id,label:e?e.label:this.displayLabel,description:e?e.description:this.displayCategory,enabled:this.enabled,backgroundTexture:Q,attachments:(null==e?void 0:e.fileAttachments.values())||[],created:this.created,modified:this.modified,stemEnabled:this.stemEnabled,color:this.color,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemLength:this.stemLength,floorId:this.floorId,roomId:this.roomId,layerId:this.layerId,keywords:e?null==e?void 0:e.keywords.slice():this.keywords.slice(),icon:"simple-tag-small"}}}var B,x=i(9133),R=i(97998),F=i(51728);!function(e){e.APPLIANCE="Appliance",e.CONSUMER_ELECTRONICS="Consumer Electronics",e.FIXTURE="Fixture",e.FURNITURE="Furniture",e.LIGHTING="Lighting"}(B||(B={}));const L="WORKSHOP.OBJECT_TAG_SUGGESTION.VISION.";class H{constructor(e){this.locale=e,this.locale=e,this.log=new R.Z("Object-tag-deserializer"),this.keywordList=Object.values(B)}deserialize(e){var t,i,n,a;if(!e||!this.validate(e))return null;const s=e.region,o=(null==s?void 0:s.anchorPosition)?k.ep.fromVisionVector(s.anchorPosition):void 0,r=(null==s?void 0:s.stemNormal)?k.ep.fromVisionVector(s.stemNormal):void 0,d=new V;d.id=e.id,d.confidence=null!==(t=e.confidence)&&void 0!==t?t:0,d.created=(0,x.p)(e.created),d.modified=(0,x.p)(e.modified),d.enabled=e.enabled,(null===(i=e.region)||void 0===i?void 0:i.stemLength)&&(d.stemLength=e.region.stemLength),d.sweeps=[],e.panos&&e.panos.forEach((e=>{e&&e.id&&d.sweeps.push(e.id)})),e.floor&&e.floor.id&&(d.floorId=e.floor.id),e.room&&e.room.id&&(d.roomId=e.room.id),e.layer&&e.layer.id&&(d.layerId=e.layer.id),o&&(d.position=o),r&&(d.stemDirection=r),d.mattertagId=null===(n=e.tag)||void 0===n?void 0:n.id;let l=e.keywords||[],h=e.label||"";if(e.classification){const t=e.classification,i=L+this.formatStringToPhraseKey(t.label);this.locale.has(i)&&(d.localizedName=this.locale.t(i));const{defaultKeywords:n}=t;if(n&&n.length>0){const e=n[n.length-1],t=L+this.formatStringToPhraseKey(e);this.locale.has(t)&&(d.localizedCategory=this.locale.t(t))}t.label&&(h=t.label),t.defaultKeywords&&(l=t.defaultKeywords);const a=[];for(const e of l){const t=L+this.formatStringToPhraseKey(e);this.locale.has(t)?a.push(this.locale.t(t)):a.push(e)}l=a}return d.keywords=l,d.label=h,this.postProcess(d,null===(a=e.classification)||void 0===a?void 0:a.defaultKeywords),d}formatStringToPhraseKey(e){return e.trim().replace(/\s/,"_").toUpperCase()}validate(e){if(!e)return!1;const t=["id","label","created","modified","region"];for(const i of t){if(!(i in e))return this.log.error("Missing field: ",i),!1}return!0}postProcess(e,t){let[i,n]=e.label.split(".").slice(1);if(i&&!e.localizedCategory){const t=L+i.toUpperCase();this.locale.has(t)?e.localizedCategory=this.locale.t(t):e.localizedCategory=i}if(n&&!e.localizedName){const t=L+n.toUpperCase();this.locale.has(t)?e.localizedName=this.locale.t(t):e.localizedName=n}if(t&&t.length>0)for(const e of this.keywordList)if(t.includes(e)){i=e;break}e.color=this.getCategoryColor(i)}getCategoryColor(e){switch(e){case"appliances":return F.U.cerulean;case"consumer_electronics":return F.U.emerald;case"fixtures":return F.U.sunset;case B.APPLIANCE:return F.U.cerulean;case B.CONSUMER_ELECTRONICS:return F.U.emerald;case B.FIXTURE:return F.U.sunset;case B.FURNITURE:return F.U.canary;case B.LIGHTING:return F.U.fog;default:return F.U.forest}}}class U extends S.u{constructor(e,t,i,n){super(e),this.modelId=i,this.classifications=[],this.layeredType=o.SF.OBJECTANNOTATION,this.confidence=n||.9,this.objectDeserializer=new H(t),this.deserializer=new N.o({deserializer:this.objectDeserializer})}async read(e){const t={modelId:this.getViewId(),minConfidence:this.confidence,includeDisabled:!0,inferenceEvents:null,ids:null,includeLayers:!!S.u.currentLayerId};return this.query(E.GetObjectAnnotations,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.objectAnnotations;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async toggleEnabled(e,t){const i={modelId:this.getViewId(),objectAnnotationId:e,data:{enabled:t},includeLayers:!!S.u.currentLayerId};return this.mutate(E.PatchObjectAnnotation,i).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchObjectAnnotation)?this.objectDeserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchObjectAnnotation):null}))}async toggleAllEnabled(e,...t){const i={modelId:this.modelId,objectAnnotationIds:t,setEnabled:e,includeLayers:!!S.u.currentLayerId};return this.query(E.SetBulkObjectAnnotationsEnabled,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.setBulkObjectAnnotationsEnabled;if(!i)return[];return i.map((e=>e.id))}))}async deleteObjectAnnotation(e){const t={modelId:this.modelId,objectAnnotationId:e};return this.query(E.DeleteObjectAnnotation,t).then((e=>{var t;return!!(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.deleteObjectAnnotation)}))}async createObjectTag(e){const t={label:e.label,keywords:e.keywords||[],floorId:e.floorId,enabled:!0,vectorRegion:{anchorPosition:k.ep.toVisionVector(e.position),stemNormal:k.ep.toVisionVector(e.stemDirection),stemLength:e.stemLength}},i={modelId:this.modelId,objectAnnotation:t,includeLayers:!!S.u.currentLayerId};return this.query(E.AddObjectAnnotation,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.addObjectAnnotation;return i?this.objectDeserializer.deserialize(i):null}))}}var j=i(87926),G=i(27832),z=i(29883),_=i(85679),$=i(43037),W=i(39880),K=i(19648),J=i(89549),Y=i(76631),q=i(66917),Z=i(80742);const Q=(0,j.p)(G);class X extends n.Y{constructor(){super(...arguments),this.name="object-tag-suggestions-data",this.visibilityEnabled=!1,this.idVisibility=new Set,this.onPinSelectionChange=e=>{const{commandBinder:t}=this.engine,{billboardAnnotation:i}=this.annotationsViewData,n=e?this.data.getObjectTag(e):null;n?(t.issueCommand(new v.IL(n.id,o.SF.OBJECTANNOTATION)),t.issueCommand(new m.Kw(n.id,b.J.OBJECT))):i&&i.annotationType===b.J.OBJECT&&t.issueCommand(new m.Aj(i.id,b.J.OBJECT))},this.onPinFocusChange=async()=>{const{commandBinder:e}=this.engine,{focusedPin:t,selectedPinId:i}=this.pinsViewData,{billboardAnnotation:n,dockedAnnotation:a}=this.annotationsViewData;if(!t)return void(n&&n.annotationType===b.J.OBJECT&&n.id!==i&&await e.issueCommand(new m.Aj(n.id,b.J.OBJECT)));const s=i?this.pinsViewData.getPin(i):null;s&&s.pinType===l.Er.OBJECT&&(e.issueCommand(new h.RH(s.id,l.Er.OBJECT)),e.issueCommand(new v.IL(null))),t.pinType===l.Er.OBJECT&&t.id!==(null==a?void 0:a.id)&&e.issueCommand(new m.Kw(t.id,b.J.OBJECT))},this.onLayersChanged=()=>{this.closeSelectedSuggestion(),this.displayObjects()},this.toggleObjectAnnotations=async e=>{const{enabled:t}=e;this.visibilityEnabled=t,this.engine.commandBinder.issueCommand(new h.qN(l.Er.OBJECT,t)),t||this.closeSelectedSuggestion(),this.displayObjects()},this.selectedItemChanged=()=>{const{activeItemId:e,selectedType:t}=this.searchData;if(e&&t===o.SF.OBJECTANNOTATION){const t=this.data.getObjectTag(e);t&&this.updatePin(t)}},this.createObjectTag=async e=>{const{id:t,options:i,pendingAttachments:n,embed:a}=e,r=new V,d=null==i?void 0:i.color,c=d?`#${new s.Color(d.r,d.g,d.b).getHexString()}`:"#ffffff";r.label=i.label||"",r.floorId=i.floorId||"",r.keywords=i.keywords||[],r.stemDirection=i.normal||new s.Vector3,r.stemLength=i.stemHeight?Math.max(i.stemHeight,M.Kn):M.Kn,r.position=i.position||new s.Vector3,r.color=c;const m=await this.store.createObjectTag(r);if(!m)return;const{commandBinder:u}=this.engine;i.objectAnnotationId=m.id,r.mattertagId=t,await u.issueCommand(new $.QG(t,i,n,void 0,a)),m.mattertagId=t,this.data.updateObjectTag(m),u.issueCommand(new h.tE(m.id,l.Er.OBJECT,this.getPinUpdate(r))),await u.issueCommand(new J.CH(Y.w1.TAGS)),u.issueCommand(new q.M);const g=this.config.hasLayersTool?Y.w1.LAYERS:Y.w1.SEARCH;await u.issueCommand(new J.z2(g)),u.issueCommand(new q.I),u.issueCommand(new v.IL(r.id,o.SF.OBJECTANNOTATION)),await u.issueCommand(new p.w$(m.id))},this.dockObjectTag=async e=>{const{id:t}=e,i=this.data.getObjectTag(t);if(!i)return;const{commandBinder:n}=this.engine;if(!i.mattertagId){const e=i.getMattertagOptions(),t=(0,W.O1)(11);n.issueCommand(new K.Mm(t,e)),i.mattertagId=t}n.issueCommand(new $.lt(i.mattertagId,{dock:!0,objectTag:!0}))}}async init(e,t){super.init(e,t),this.engine=t,this.config=e,[this.locale,this.pinsViewData,this.annotationsViewData,this.mattertagsData,this.layersData,this.searchData,this.appData]=await Promise.all([t.getModuleBySymbol(a.y.LOCALE),t.market.waitForData(c.B),t.market.waitForData(u.A),t.market.waitForData(_.n),t.market.waitForData(Z.R),t.market.waitForData(z.T),t.market.waitForData(y.pu)]),this.store=new U({readonly:!1,baseUrl:e.baseUrl},this.locale,e.baseModelId,e.minConfidence),this.engine.commandBinder.issueCommand(new h.qN(l.Er.OBJECT,!1)),this.data=new g.h,this.store.onNewData(this.loadNewData.bind(this));const{commandBinder:i}=this.engine;this.bindings.push(i.addBinding(p.AN,this.toggleObjectAnnotations),i.addBinding(p.yJ,(async e=>this.filterObjectTagSuggestions(e.ids))),i.addBinding(p.w$,(async({id:e})=>this.navigateToSuggestion(e))),i.addBinding(p.cO,(async({ids:e,enabled:t})=>this.setAllObjectTagsEnabled(t,...e))),i.addBinding(p.Q_,(async e=>this.toggleObjectTagEnabled(e.id,e.enabled))),i.addBinding(p.SO,(async({ids:e})=>this.deleteTags(...e))),i.addBinding(p.I2,(async e=>this.createObjectTag(e))),i.addBinding(p.OD,(async e=>this.dockObjectTag(e))),this.appData.onChanged((()=>this.displayObjects())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.searchData.onPropertyChanged("activeItemId",this.selectedItemChanged),this.pinsViewData.onSelectedPinChanged(this.onPinSelectionChange),this.pinsViewData.onFocusedPinChanged((()=>this.onPinFocusChange())),this.data.onChanged((()=>this.displayObjects())),this.data.collection.onElementChanged({onAdded:this.updatePin.bind(this),onUpdated:this.updatePin.bind(this),onRemoved:this.removePin.bind(this)})),await this.store.refresh(),this.engine.market.register(this,g.h,this.data),async function(e,t,i,n){const a=await e.market.waitForData(y.pu),s=await e.getModuleBySymbol(A.y.ANALYTICS);let r=a.application===y.Mx.WORKSHOP;const d=[],l=(a,s,l=[])=>{d.length=0;let c=!0,m=!0;return t.iterate((t=>{if(!(r||t.visible&&n.layerToggled(t.layerId)))return;const s=[t.displayLabel,t.displayCategory],o=[...t.keywords],h=t.mattertagId?i.getTag(t.mattertagId):void 0;h&&(s.length=0,o.length=0,s.push(h.label,h.description),o.push(...h.keywords));const u=s.filter((e=>!!e));let p=a(...u);p&&l.length>0&&(p=o.length>0&&o.some((e=>l.includes(e)))),p&&(t.visible?m=!1:c=!1,d.push(new P(e,n,r,t,h)))})),e.commandBinder.issueCommand(new p.yJ(d.map((e=>e.id)))),r&&e.commandBinder.issueCommand(new v.Np(o.SF.OBJECTANNOTATION,f(m,c))),h(d),d},h=e=>{e.sort(((e,t)=>{var i;const n=e,a=t,s=null===(i=n.description)||void 0===i?void 0:i.localeCompare(a.description);return 0!==s?s:n.title.localeCompare(a.title)}))},c=t=>{e.commandBinder.issueCommand(new p.AN(!!t))},m=()=>{e.commandBinder.issueCommand(new p.cO(!0,...d.map((e=>e.id)))),e.commandBinder.issueCommand(new v.Np(o.SF.OBJECTANNOTATION,f(!1,!0))),s.track("showcase_gui",{tool:"object_tags",gui_action:"show_all_click"})},u=()=>{e.commandBinder.issueCommand(new p.cO(!1,...d.map((e=>e.id)))),e.commandBinder.issueCommand(new v.Np(o.SF.OBJECTANNOTATION,f(!0,!1))),s.track("showcase_gui",{tool:"object_tags",gui_action:"hide_all_click"})},g=()=>{e.commandBinder.issueCommand(new p.SO(...d.map((e=>e.id)))),s.track("showcase_gui",{tool:"object_tags",gui_action:"delete_all_click"})},b=()=>{let e=[];return t.iterate((t=>{t.visible&&t.keywords.length&&!t.mattertagId&&(e=e.concat(t.keywords))})),e},f=(e,t)=>{const i=0===d.length;return[{labelKey:I.SEARCH_GROUP_HIDE_ALL,handler:u,disabled:e},{labelKey:I.SEARCH_GROUP_SHOW_ALL,handler:m,disabled:t},{labelKey:I.SEARCH_GROUP_DELETE_ALL,handler:g,disabled:i}]},T=e=>new w.V(t.onChanged(e),i.onChanged(e)),D=()=>{e.commandBinder.issueCommandWhenBound(new v.c6({id:o.SF.OBJECTANNOTATION,groupPhraseKey:"WORKSHOP.OBJECT_TAG_SUGGESTION.SEARCH_GROUP_HEADER",getSimpleMatches:l,registerChangeObserver:T,onSearchActivatedChanged:c,getKeywords:b,groupMenuActions:r?f(!0,!0):void 0,groupOrder:90,groupIcon:"snap"}))},C=()=>{e.commandBinder.issueCommandWhenBound(new v.Pe(o.SF.OBJECTANNOTATION))},E={renew:D,cancel:C},k=e=>{r=e===y.Mx.WORKSHOP,C(),D()},S=a.onPropertyChanged("application",k);return k(a.application),new w.V(E,S)}(t,this.data,this.mattertagsData,this.layersData).then((e=>this.bindings.push(e)))}loadNewData(e){this.data.atomic((()=>{for(const t in e){const i=e[t];this.data.updateObjectTag(i)}}))}dispose(e){super.dispose(e),this.data&&e.market.unregister(this,g.h)}displayObjects(){const e=[];this.data.collection.values.forEach((t=>{e.push(this.getPinUpdate(t))})),this.engine.commandBinder.issueCommand(new h.mE(e))}removePin(e){this.engine.commandBinder.issueCommand(new h.OL(e.id,l.Er.OBJECT))}updatePin(e){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new h.mE([t]))}getPinUpdate(e){const t=this.mattertagsData.getTag(e.mattertagId||""),i=e.getPin(t);return Object.assign({id:e.id,pinType:l.Er.OBJECT,backgroundTexture:Q,visible:this.getObjectVisibility(e.id,e.layerId,e.visible),scale:new s.Vector3(.75,.75,.75),icon:"simple-tag-small"},i)}getObjectVisibility(e,t,i){if(!this.visibilityEnabled)return!1;const{activeItemId:n,selectedType:a}=this.searchData,s=this.appData.application===y.Mx.WORKSHOP||this.layersData.layerToggled(t),r=this.layersData.layerVisible(t),d=this.idVisibility.has(e),l=n===e&&a===o.SF.OBJECTANNOTATION;return s&&(l||i&&d&&r)}async filterObjectTagSuggestions(e){this.idVisibility.clear(),e.forEach((e=>this.idVisibility.add(e))),this.displayObjects()}async navigateToSuggestion(e){const t=this.data.getObjectTag(e);if(!t)return;const i={anchorPosition:t.position.clone(),stemNormal:t.stemDirection.clone(),stemLength:t.stemLength,stemEnabled:!0,color:"",floorId:t.floorId,roomId:t.roomId,layerId:t.layerId};await this.engine.commandBinder.issueCommand(new d.OR({pinPosition:i,transition:r.n.FadeToBlack})),this.engine.commandBinder.issueCommand(new h.Ar(e,l.Er.OBJECT,!1))}closeSelectedSuggestion(){const{selectedPinId:e}=this.pinsViewData;if(e){const t=this.pinsViewData.getPin(e);t&&t.pinType===l.Er.OBJECT&&this.engine.commandBinder.issueCommand(new h.RH(t.id,l.Er.OBJECT))}this.searchData.selectedType===o.SF.OBJECTANNOTATION&&this.engine.commandBinder.issueCommand(new v.IL(null))}async setAllObjectTagsEnabled(e,...t){0===t.length&&(t=this.data.getObjectTagIds()),await this.store.toggleAllEnabled(e,...t),this.data.atomic((()=>{for(const i of this.data.suggestions)t.includes(i.id)&&(i.enabled=e,i.commit())}))}async toggleObjectTagEnabled(e,t){const i=this.data.getObjectTag(e);if(!i)throw new Error("Object tag not found!");if(i.enabled===t)return;i.enabled=t,i.commit(),this.engine.commandBinder.issueCommand(new h.ik(e,l.Er.OBJECT,this.getObjectVisibility(e,i.layerId,t)));await this.store.toggleEnabled(e,t)||(this.log.error("Failed to toggle enabled on Object Annotation"),i.enabled=!t,i.commit(),this.engine.commandBinder.issueCommand(new h.ik(e,l.Er.OBJECT,this.getObjectVisibility(e,i.layerId,!t))))}async deleteTags(...e){const t=this.annotationsViewData.billboardAnnotation;(null==t?void 0:t.annotationType)===b.J.OBJECT&&this.engine.commandBinder.issueCommand(new m.Aj(t.id,t.annotationType)),0===e.length&&(e=this.data.getObjectTagIds());for(const t of e){if(await this.store.deleteObjectAnnotation(t)){this.data.removeObjectTag(t);const e=this.data.getObjectTag(t);e&&e.mattertagId&&await this.engine.commandBinder.issueCommand(new $.T3(e.mattertagId,"search_menu_object_tag"))}}}}},66338:(e,t,i)=>{"use strict";i.d(t,{W:()=>s});var n=i(67992),a=i(15637);class s extends n.V{constructor(e){super(),this.name="ordered-list-data",this.lists=(0,a.q)(e)}replace(e){this.lists.replace(e)}getOrderedLists(){return this.lists.values}getOrderedList(e){return this.lists.get(e)}updateOrderedList(e){this.lists.has(e.name)?this.lists.get(e.name).copy(e):this.lists.set(e.name,e)}}},43846:(e,t,i)=>{"use strict";i.d(t,{wg:()=>a,Bd:()=>s,ui:()=>o});var n=i(19663);class a extends n.m{constructor(e,t){super(),this.payload={name:e,entries:t}}}class s extends n.m{constructor(e,t){super(),this.payload={name:e,entries:t}}}class o extends n.m{constructor(e,t,i){super(),this.payload={id:e,name:t,entries:i}}}},24102:(e,t,i)=>{"use strict";var n;i.d(t,{l:()=>n}),function(e){e.TAG="tag"}(n||(n={}))},51366:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CreateOrderedListCommand:()=>f.Bd,MdsOrderedListDeserializer:()=>v,MdsOrderedListStore:()=>w,OrderedList:()=>l,OrderedListData:()=>b.W,OrderedListEntryType:()=>P.l,SaveNamedOrderedListCommand:()=>f.wg,TAG_ORDERED_LIST_NAME:()=>A.q,UpdateOrderedListCommand:()=>f.ui,default:()=>I});var n=i(97542),a=i(57956),s=i(79728),o=i(635),r=i(90632),d=i(75287);class l extends d.T{constructor(e){super(),this.id="",this.name="",this.description="",this.entries=[],e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.name=e.name,e.description&&(this.description=e.description),this.entries=e.entries.slice(),this.commit(),this}}var h=i(17788),c=i(29474),m=i(73123),u=i(97998),p=i(22001);const g=new u.Z("ordered-list-deserializer");class v{deserialize(e){var t;return e&&this.validate(e)?new l({id:e.id,name:null!==(t=e.label)&&void 0!==t?t:"",entries:e.entries.filter((e=>!!e)).map((e=>({id:e.id,type:e.type})))}):(g.debug("Deserialized invalid ordered list data from Mds",e),null)}validate(e){return["id","label","entries"].every((t=>t in e))}}const y=new u.Z("MdsOrderedListStore");class w extends h.u{constructor(e){super(e),this.prefetchKey="data.model.orderedLists",this.deserializer=new v}async read(){const e=this.getViewId();return this.query(p.GetOrderedLists,{modelId:e}).then((e=>{var t,i;const n=null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.orderedLists;if(!n||!Array.isArray(n))return y.debug("GetOrderedLists failed"),{};return n.reduce(((e,t)=>{const i=this.deserializer.deserialize(t);return i&&(e[i.name]&&y.debug(`Duplicate orderedList found with label: ${i.name}`),e[i.name]=i),e}),{})}))}async create(e,t){if(0===e.length)return[];const i=this.getViewId();return Promise.all(e.map((e=>{const n={modelId:i,label:e.name,description:e.description,entries:e.entries};if(this.shouldWriteLayerId()){const e=Object.assign({layerId:t},n);return this.mutate(p.AddOrderedListWithLayer,e).then((e=>{var t;return this.deserializer.deserialize(null===(t=e.data)||void 0===t?void 0:t.addOrderedList)}))}return this.mutate(p.AddOrderedList,n).then((e=>{var t;return this.deserializer.deserialize(null===(t=e.data)||void 0===t?void 0:t.addOrderedList)}))})))}async update(e,t){if(0===e.length)return;const i=this.getViewId();let n="";const a={};a.modelId=i;let s="";for(const i of e){const e=i.id;n+=`\n        , $label${e}: String!\n        , $description${e}: String!\n        , $entries${e}: [EntryInput!]\n      `,a[`label${e}`]=i.name,a[`description${e}`]=i.description,a[`entries${e}`]=i.entries;let o="";this.shouldWriteLayerId()&&(a[`layerId${e}`]=t,o=`layerId: $layerId${e}`,n+=`\n          , $layerId${e}: ID!\n        `),s+=`\n        update${e}:\n        patchOrderedList(modelId: $modelId,\n                         orderedListId: "${e}",\n                         label: $label${e},\n                         description: $description${e},\n                         ${o}\n                         entries: $entries${e}) {\n          id\n          label\n          entries {\n            id\n            type\n          }\n        }\n      `}const o=c.Ps`
      mutation orderedListsUpdate($modelId: ID! ${n}) {
        ${s}
      }
    `;return this.mutate(o,a).then((e=>{y.debug(Object.assign({type:"patchOrderedList"},Object.values((0,m.q)(e,"data"))))}))}}var b=i(66338),f=i(43846),T=i(80742),D=i(63319);class C extends n.Y{constructor(){super(...arguments),this.name="ordered-lists",this.saveNamedOrderedList=async e=>{const{name:t,entries:i}=e;let n=this.data.getOrderedList(t);return n?n.entries=i:n=new l({name:t,entries:i}),this.data.updateOrderedList(n),this.engine.commandBinder.issueCommand(new o.VQ({dataTypes:[s.g.ORDERED_LISTS]}))}}async init(e,t){const{baseUrl:i,workshop:n}=e;if(this.engine=t,this.store=new w({baseUrl:i,readonly:!n}),this.bindings.push(this.store.onNewData((async e=>{this.data.replace(e);const i=(await t.market.waitForData(T.R)).currentLayers(),n=i.find((e=>e.layerType===D.s.VIEW_DATA_LAYER));if(n)this.orderedListLayerId=n.id;else{const e=i.find((e=>e.layerType===D.s.BASE_LAYER));if(!e)throw new Error("Missing base layer in view!");this.orderedListLayerId=e.id}}))),this.data=new b.W({}),await this.store.refresh(),n){const e=await t.getModuleBySymbol(a.y.STORAGE);this.bindings.push(t.commandBinder.addBinding(f.wg,this.saveNamedOrderedList),e.onSave((()=>this.save()),{dataType:s.g.ORDERED_LISTS}));const i=await t.market.waitForData(r.Q);i.setPublishableType(s.g.ORDERED_LISTS),i.setRevertableType(s.g.ORDERED_LISTS)}t.market.register(this,b.W,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}onUpdate(){}async save(){const e=this.data.getOrderedLists(),t=[],i=[];e.forEach((e=>{""===e.id?t.push(e):i.push(e)}));return Promise.all([this.store.create(t,this.orderedListLayerId),this.store.update(i,this.orderedListLayerId)]).then((e=>{e[0].forEach((e=>{e&&this.data.updateOrderedList(e)}))}))}}var P=i(24102),A=i(25561);const I=C},25561:(e,t,i)=>{"use strict";i.d(t,{q:()=>n});const n="mp.tags"},47297:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelNewPinCommand:()=>$.tT,ChangePinOpacityByTypeCommand:()=>$.kb,ChangePinOpacityCommand:()=>$._Y,ChangePinOpacityScaleCommand:()=>$.nP,ChangePinVisibilityByTypeCommand:()=>$.qN,ChangePinVisibilityCommand:()=>$.ik,ClearPinSelectionCommand:()=>$.iK,ClickOffPinCommand:()=>$.yR,CreatePinCommand:()=>$.fM,EnablePinCreationCommand:()=>$.Ki,MovePinCommand:()=>$.I$,NewPinReadyMessage:()=>W.cd,PinAddCancelledMessage:()=>W.hu,PinAnchorMesh:()=>_,PinClickedMessage:()=>W.F7,PinColorVariant:()=>L.K_,PinEditor:()=>Z,PinEditorState:()=>L.V8,PinHeadMesh:()=>H.$,PinHoverChangeMessage:()=>W.tP,PinMovedMessage:()=>W.bV,PinPlacedMessage:()=>W.b0,PinPlacementCancelledMessage:()=>W.pe,PinPreviewDirection:()=>L.Od,PinRenderer:()=>ae,PinType:()=>L.Er,PinsViewData:()=>D.B,PlacePinCommand:()=>$.ip,RemovePinCommand:()=>$.OL,RemovePinsByTypeCommand:()=>$.zM,SelectPinCommand:()=>$.Ar,UnselectPinCommand:()=>$.RH,UpdatePinCommand:()=>$.tE,UpdatePinViewsCommand:()=>$.mE,default:()=>Se});var n=i(84428),a=i(97542),s=i(57956),o=i(59370),r=i(31362),d=i(54244),l=i(5332),h=i(79727),c=i(5135),m=i(25985),u=i(53954),p=i(23254),g=i(95882),v=i(95512),y=i(38987),w=i(34956),b=i(14630),f=i(10699),T=i(79596),D=i(60083),C=i(89570),P=i(53058),A=i(82814);var I=i(94046),E=i(97998),k=i(72996),S=i(16769),N=i(16782),O=i(67678),M=i(86819),V=i(80592),B=i(62017),x=i(89553),R=i(6667),F=i(32597),L=i(62612),H=i(33160),U=i(12529),j=i(87926),G=i(30749),z=i(84958);class _ extends n.Mesh{constructor(e){super(new n.PlaneGeometry(z.Z.anchor.size,z.Z.anchor.size),new n.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:_.getTexture(),side:n.DoubleSide})),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=U.z.pins}static getTexture(){return _.anchorTexture||(_.anchorTexture=(0,j.p)(G)),_.anchorTexture}}var $=i(72936),W=i(13132),K=i(76957),J=i(35826),Y=i(12039),q=i(51411);class Z{constructor(e,t,i,a){this.viewData=e,this.engine=t,this.input=i,this.pinRenderer=a,this.editEnabled=!1,this.handlersRegistered=!1,this.bindings=[],this.externalBehaviorsBlocked=!1,this.touchDevice=(0,r.Jm)(),this.longPressCreateThreshold=500,this.ndcPoint=new n.Vector3,this.movingPin=!1,this.anchored=!1,this.inAnchorClick=!1,this.startingPinData=void 0,this.log=new E.Z("pin-editor"),this.stopEventPropagation=()=>!0,this.updateMeshPreviewSphere=async(e,t)=>{this.engine.commandBinder.issueCommand(new q.n(e,t))},this.startPinCreation=()=>{this.editEnabled&&(this.addingHandlers.renew(),this.touchDevice||this.engine.commandBinder.issueCommand(new y.u(w.C.XHAIR)),this.engine.commandBinder.issueCommand(new J.ZD))},this.endPinCreation=()=>{this.editEnabled&&(this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.clearLongPressTimeout(),this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new y.u(w.C.DEFAULT)),this.engine.commandBinder.issueCommand(new J.zd))},this.onSelectedPinChanged=()=>{const{selectedPinId:e}=this.viewData;e?this.selectedHandlers.renew():this.selectedHandlers.cancel(),this.updateAnchorMesh()},this.onPinStateUpdated=()=>{const e=this.viewData.pinEditorState;switch(this.updateAnchorMesh(),e){case L.V8.PLACING:this.draggingHandlers.renew();break;case L.V8.IDLE:this.allowExternalBehaviors(!0)}},this.updateAnchorMesh=()=>{if(!this.editEnabled)return;const{pinEditorState:e,isPinEditable:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;n&&e!==L.V8.CREATING?([L.V8.PLACING,L.V8.PLACED].includes(e)||t?(this.pinRenderer.showAnchorMesh(n.pinType,n.id,n),this.anchored=!0):this.removePinAnchorMesh(),this.editableSelectedHandlers.renew()):(this.editableSelectedHandlers.cancel(),this.anchored&&this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1))},this.clearLongPressTimeout=()=>{this.longPressStart=0,-1!==this.longPressTimeout&&window.clearTimeout(this.longPressTimeout),this.longPressTimeout=-1},this.placePin=()=>{this.viewData.pinEditorState===L.V8.PLACING&&(this.engine.commandBinder.issueCommand(new y.u(w.C.DEFAULT)),this.engine.commandBinder.issueCommand(new $.ip),this.engine.broadcast(new W.cd),this.updateMeshPreviewSphere(!1))},this.onDragEvent=e=>{e.buttons!==N.r.PRIMARY&&(this.touchDevice||this.viewData.selectedPinId)||this.positionPin(e)},this.onDragEnd=e=>{const{creatingNewPin:t,pinEditorState:i,selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;t&&!this.touchDevice&&i===L.V8.PLACING||(a&&!t&&(this.engine.commandBinder.issueCommand(new $.I$(a.id,this.copyPinData(a),this.startingPinData)),this.updateMeshPreviewSphere(!1)),this.doneMovingPin(),this.inAnchorClick=!1)},this.positionPin=(()=>{const e=new n.Vector3;return async t=>{if(this.touchDevice&&t.buttons!==N.r.PRIMARY)return!1;const i=this.viewData,{pinEditorState:n,selectedPinId:a}=i;if(n===L.V8.CREATING)this.engine.commandBinder.issueCommand(new v.y(!0));else if(n!==L.V8.PLACING&&!this.movingPin)return!1;const s=a?i.getPin(a):null;if(!s)return!1;this.saveScreenPosition(t.position.x,t.position.y);const o=this.getModelIntersection();if(o&&o.face){this.engine.commandBinder.issueCommand(new y.u(w.C.XHAIR)),i.setCanPlace(!0);const t=((e,t,i)=>{var n;return null!==(n=t.floorIdFromObject(i.object))&&void 0!==n?n:e.getClosestFloorAtHeight(i.point.y).id})(this.floorsData,this.meshQuery,o);if(null===t)return!1;const a=this.meshQuery.mdsRoomIdFromObject(o.object);e.copy(s.stemNormal).setLength(s.stemLength),this.updateMeshPreviewSphere(!0,s.anchorPosition);const r={anchorPosition:s.anchorPosition.copy(o.point),stemNormal:s.stemNormal.copy(o.face.normal).normalize(),floorId:t,roomId:a};return this.engine.commandBinder.issueCommand(new $.tE(s.id,s.pinType,r)),n===L.V8.CREATING&&i.setPinEditorState(L.V8.PLACING),!0}return this.engine.commandBinder.issueCommand(new y.u(w.C.NOPE)),i.setCanPlace(!1),!1}})(),this.allowExternalBehaviors=async e=>{e||this.externalBehaviorsBlocked?e&&this.externalBehaviorsBlocked&&(this.dragInterceptor.cancel(),this.engine.commandBinder.issueCommand(new Y.Lp),this.externalBehaviorsBlocked=!1):(this.dragInterceptor.renew(),this.engine.commandBinder.issueCommand(new Y.ZK),this.externalBehaviorsBlocked=!0)},this.getModelIntersection=()=>{const e=.5*z.Z.anchor.size;return this.fatcaster.cast(e,(e=>!!(0,S.Pv)(e)&&(!this.viewmodeData.isDollhouse()&&!this.viewmodeData.isFloorplan()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup))),P.a.Filter.CENTER_GROUP(e))},this.onPointerButton=e=>{e.down||this.viewData.pinEditorState!==L.V8.PLACED||(this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new v.y(!1)))},this.onAnchorDragBegin=e=>{const{isPinEditable:t,pinEditorState:i,selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;!a||e.buttons!==N.r.PRIMARY||i!==L.V8.PLACED&&i!==L.V8.IDLE||(t?(this.movingPin=!0,this.startingPinData=this.copyPinData(a),this.allowExternalBehaviors(!1),this.draggingHandlers.renew(),this.engine.commandBinder.issueCommand(new y.u(w.C.GRABBING)),this.engine.commandBinder.issueCommand(new v.y(!0)),this.inAnchorClick=!0):this.log.debug("onAnchorSelect called on a non-editable pin"))},this.doneMovingPin=()=>{this.viewData.selectedPinId&&this.movingPin&&(this.draggingHandlers.cancel(),this.engine.commandBinder.issueCommand(new y.u(null)),this.engine.commandBinder.issueCommand(new v.y(!1)),this.movingPin=!1,this.startingPinData=void 0,this.allowExternalBehaviors(!0),this.updateMeshPreviewSphere(!1))},this.onClickElsewhere=e=>{const{selectedPinId:t,pinEditorState:i}=this.viewData;if(!(i===L.V8.CREATING&&t||this.inAnchorClick))return t&&(this.movingPin?this.doneMovingPin():this.engine.commandBinder.issueCommand(new $.yR)),!0},this.onLongPressStart=async e=>{if(e.buttons!==N.r.PRIMARY)return;const t=this.viewData;t.pinEditorState===L.V8.CREATING&&(this.longPressStart=Date.now(),t.setPinEditorState(L.V8.PRESSING),this.allowExternalBehaviors(!1),this.saveScreenPosition(e.position.x,e.position.y),this.longPressTimeout=window.setTimeout((async()=>{t.setPinEditorState(L.V8.PLACING);await this.positionPin(e)||(t.setPinEditorState(L.V8.CREATING),t.setCanPlace(!1)),this.longPressTimeout=-1}),this.longPressCreateThreshold))},this.onLongPressEnd=()=>{const e=this.viewData.pinEditorState;e===L.V8.PRESSING?(this.log.debug("Did not press long enough"),this.endPinCreation()):e===L.V8.PLACING&&this.placePin()},this.onPointerEvent=e=>{const t=this.viewData.pinEditorState;t!==L.V8.PLACING&&t!==L.V8.CREATING||this.positionPin(e)},this.onClickToPlacePin=()=>{this.placePin()},this.onKeyEvent=e=>{if(e.state===R.M.PRESSED)switch(e.key){case F.R.ESCAPE:this.viewData.creatingNewPin&&this.engine.broadcast(new W.pe)}},Promise.all([t.market.waitForData(m.M),t.market.waitForData(K.i),t.market.waitForData(h.c),t.market.waitForData(p.O),t.getModuleBySymbol(s.y.FAT_RAYCAST),t.getModuleBySymbol(s.y.MESH_QUERY)]).then((([t,n,a,s,o,r])=>{this.cameraData=t,this.floorsData=n,this.floorsViewData=a,this.viewmodeData=s,this.fatcaster=o,this.meshQuery=r,this.bindings.push(i.registerPriorityHandler(O.er,H.$,this.stopEventPropagation),e.onSelectedPinChanged(this.onSelectedPinChanged)),this.selectedHandlers=new C.V(i.registerPriorityHandler(M.R,A.S,this.onClickElsewhere),i.registerPriorityHandler(M.R,I.i,this.onClickElsewhere)),this.selectedHandlers.cancel()}))}dispose(){this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1),this.dragInterceptor.cancel(),this.addingHandlers.cancel(),this.draggingHandlers.cancel(),this.selectedHandlers.cancel(),this.editableSelectedHandlers.cancel(),this.bindings.forEach((e=>{e.cancel()}))}update(){if(!this.editEnabled)return;const e=this.viewData;if(this.touchDevice&&e.pinEditorState===L.V8.PRESSING){const t=Math.min(1,(Date.now()-this.longPressStart)/this.longPressCreateThreshold);e.setProgress(t)}}toggleEditing(e){e!==this.editEnabled&&(this.editEnabled=e,e?(this.handlersRegistered?this.creationHandlers.renew():this.registerHandlers(),this.updateAnchorMesh()):(this.inAnchorClick=!1,this.anchored=!1,this.movingPin=!1,this.creationHandlers.cancel(),this.allowExternalBehaviors(!0),this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)),this.dragInterceptor.cancel(),this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.editableSelectedHandlers.cancel())}registerHandlers(){const e=this.input,t=this.viewData;this.creationHandlers=new C.V(t.onPinEditorStateChanged(this.onPinStateUpdated)),this.dragInterceptor=new C.V(e.registerPriorityHandler(V._t,A.S,(()=>!0)),e.registerPriorityHandler(V._t,I.i,(()=>!0))),this.draggingHandlers=new C.V(e.registerUnfilteredHandler(V._t,this.onDragEvent),e.registerUnfilteredHandler(V._R,this.onDragEnd)),this.editableSelectedHandlers=new C.V(e.registerMeshHandler(V.E0,k.s.isType(_),this.onAnchorDragBegin)),this.touchDevice?this.addingHandlers=new C.V(e.registerHandler(O.er,this.onPointerButton),e.registerUnfilteredHandler(B.Vh,this.onLongPressStart),e.registerUnfilteredHandler(B.pt,this.onLongPressEnd)):this.addingHandlers=new C.V(e.registerHandler(x.e,this.onKeyEvent),e.registerHandler(O.er,this.onPointerButton),e.registerUnfilteredHandler(M.R,this.onClickToPlacePin),e.registerHandler(O.mE,this.onPointerEvent))}removePinAnchorMesh(){this.pinRenderer.hideAnchorMesh(),this.anchored=!1}copyPinData(e){return{anchorPosition:e.anchorPosition.clone(),stemNormal:e.stemNormal.clone(),floorId:e.floorId,roomId:e.roomId,stemLength:e.stemLength,stemEnabled:e.stemEnabled,color:e.color,layerId:e.layerId}}saveScreenPosition(e,t){this.ndcPoint.set(e,t,0);const i=(0,o.fi)(this.cameraData.width,this.cameraData.height,this.ndcPoint);this.viewData.setScreenPosition(i)}}var Q=i(23612),X=i(4510),ee=i(7402),te=i(23885),ie=i(55763);class ne extends n.Mesh{constructor(e){super(new n.PlaneGeometry(z.Z.anchor.size,z.Z.anchor.size),new ie.Dx),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=U.z.pinSelectedHalo}}class ae{constructor(e,t,i,a){this.input=e,this.layer=t,this.commandBinder=i,this.raycaster=a,this.container=new n.Object3D,this.floorIdToContainer=new Map,this.hexColorToColor=new Map,this.bindings=[],this.anchor=null,this.selected=null,this.haloEasing=(0,te.tf)(.5,.52,0,1.98),this.pinsWithOverrideTexture=new Set,this.iconsEnabled=!1,this.updateAnchorPosition=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3;return n=>{const a=this.anchorMesh;if(!a)return;const s=this.raycaster.picking;e.copy(n.stemNormal).normalize(),t.copy(e).multiplyScalar(.2).add(n.anchorPosition),i.copy(e).multiplyScalar(-1);const o=s.pick(t,i,(e=>e instanceof ee.g));if(o){const e=Math.min(.2,o.distance);a.position.copy(t).add(i.multiplyScalar(.999*e))}else a.position.copy(t).add(i.multiplyScalar(.999*n.stemLength));a.lookAt(t)}})(),this.onAnchorHover=()=>{this.commandBinder.issueCommand(new y.u(w.C.GRAB)),this.commandBinder.issueCommand(new v.y(!0))},this.onAnchorUnhover=()=>{this.commandBinder.issueCommand(new y.u(null)),this.commandBinder.issueCommand(new v.y(!1))}}init(){this.container.name="PinContainer",this.container.layers.mask=this.layer.mask,this.anchorMesh=new _(this.layer),this.anchorMesh.name="Anchor Mesh",this.container.add(this.anchorMesh),this.selectedMesh=new ne(this.layer),this.selectedMesh.name="Selected Mesh",this.container.add(this.selectedMesh)}dispose(){this.container.parent&&this.container.parent.remove(this.container);for(const e of[this.anchorMesh,this.selectedMesh])e&&e.parent&&e.parent.remove(e)}activate(e){this.bindings.length>0||this.bindings.push(this.input.registerMeshHandler(Q.z,k.s.isType(_),this.onAnchorHover),this.input.registerMeshHandler(Q.A,k.s.isType(_),this.onAnchorUnhover))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}render(e){if(!this.selected)return;const{animation:t,hideWhenDoneAnimating:i}=this.selected,a=this.selectedMesh;if(a&&a.visible&&t){const e=this.pinHeadTransform(this.selected.id),s=new n.Vector3,o=new n.Quaternion,r=new n.Vector3;e.decompose(s,o,r),r.multiplyScalar(t.getUpdatedValue()),i&&!t.isAnimating?(a.visible=!1,this.selected=null):(a.position.copy(s),a.quaternion.copy(o),a.scale.copy(r))}}updatePin(e,t,i,n,a,s){this.anchorMesh&&this.anchorMesh.visible&&this.anchor&&this.anchor.pinType===t&&this.anchor.id===e&&this.updateAnchorPosition(i)}removePin(e){this.selected&&this.selected.id===e&&this.clearSelected()}removePinsByType(e){this.removePinsByPredicate((t=>t===e))}removePinsByPredicate(e){}setPinVisible(e,t){}setPinColorVariant(e,t){}setPinColorVariants(e,t){}setPinColorVariantByType(e,t,i){}setPinOpacity(e,t){}setPinOpacityByType(e,t,i){}fadePinOpacity(e,t){}fadePinOpacityByType(e,t,i=[]){}setPinRenderOverrides(e,t,i){t?(this.pinsWithOverrideTexture.add(e),this.selected&&this.selected.id===e&&this.clearSelected()):this.pinsWithOverrideTexture.delete(e)}setFloorsHidden(e){this.floorIdToContainer.forEach(((t,i)=>{t.visible=!e(i)}))}setPinTypeVisible(e,t){this.floorIdToContainer.forEach((i=>{i.userData.typeContainers[e].visible=t}))}showAnchorMesh(e,t,i){this.anchor={pinType:e,id:t},this.anchorMesh&&!this.anchorMesh.visible&&(this.anchorMesh.visible=!0,this.input.registerMesh(this.anchorMesh,!1)),this.updateAnchorPosition(i)}hideAnchorMesh(){this.anchorMesh&&this.anchorMesh.visible&&(this.anchorMesh.visible=!1,this.input.unregisterMesh(this.anchorMesh))}showSelectedMesh(e,t){const i=this.selected&&this.selected.pinType===e&&this.selected.id===t;this.selected&&i||this.pinsWithOverrideTexture.has(t)||(this.selected={pinType:e,id:t,hideWhenDoneAnimating:!1,animation:new X.Z({startValue:10,endValue:14,duration:300,easingFunction:this.haloEasing})},this.selectedMesh.visible=!0)}hideSelectedMesh(){this.selected&&(this.selected.animation=new X.Z({startValue:14,endValue:10,duration:300}),this.selected.hideWhenDoneAnimating=!0)}getFloorContainer(e){let t=this.floorIdToContainer.get(e);if(t)return t;t=new n.Object3D,t.name="Floor "+e,t.userData.typeContainers={},t.layers.mask=this.layer.mask;for(const e of Object.values(L.Er)){const i=new n.Object3D;i.name=e,i.layers.mask=this.layer.mask,t.add(i),t.userData.typeContainers[e]=i}return this.container.add(t),this.floorIdToContainer.set(e,t),t.userData.floorId=e,t}getColor(e){let t=this.hexColorToColor.get(e);if(t)return t;const i=new n.Color(e),a={h:0,s:0,l:0};i.getHSL(a);return t={baseColor:i,hoverColor:(new n.Color).setHSL(a.h,a.s,.8*a.l),dimmedColor:(new n.Color).setHSL(a.h,.5*a.s,a.l)},this.hexColorToColor.set(e,t),t}getViewportScale(e){return Math.sqrt(Math.min(e.width,e.height)/z.Z.pinHeadMesh.scale.baseViewportSize)}clearSelected(){this.selectedMesh.visible=!1,this.selected=null}}class se extends n.Line{constructor(e,t,i,a,s){const o=new n.BufferGeometry,r=new Float32Array(6);r[0]=r[1]=r[2]=0,r[3]=e.x,r[4]=e.y,r[5]=e.z,o.setAttribute("position",new n.BufferAttribute(r,3));const d=new ie.l0;super(o,d),this.geometry=o,this.layers.mask=i.mask,this.visible=t,this.vector=e.clone(),this.onBeforeRender=(e,t,i,n,o)=>{const r=o;r.uniforms.pinHeadMatrix.value.copy(a.matrixWorld),r.uniforms.resolution.value.set(s.width,s.height),r.uniformsNeedUpdate=!0},this.pinStemMaterial=d}dispose(){this.geometry.dispose()}updatePosition(e){this.vector.copy(e.stemNormal).setLength(Math.max(e.stemLength,.01));const t=this.geometry.getAttribute("position");t.setXYZ(1,this.vector.x,this.vector.y,this.vector.z),t.needsUpdate=!0}}var oe=i(39689),re=i(89557);class de extends n.Object3D{constructor(e,t,i,a,s,o,r,d,l,h,c){super(),this.pinId=e,this.pinType=t,this.pinColor=a,this.stemVector=new n.Vector3,this.stemEnabled=!0,this.currentColorVariant=L.K_.DEFAULT,this.baseOpacity=1,this.opacityScale=1,this.pinHeadGeometryInst=new n.PlaneGeometry(z.l,z.l),this.pinHeadGeometryInst.setAttribute("instanceUvOffset",new n.BufferAttribute(s,2)),this.pinHeadGeometryInst.setAttribute("instanceUvScale",new n.BufferAttribute(o,1)),this.pinHeadGeometryInst.setAttribute("instanceStrokeWidth",new n.BufferAttribute(c,1)),de.pinHeadGeometry||(de.pinHeadGeometry=new n.PlaneGeometry(z.l,z.l));const m=(new n.Color).copy(a.baseColor);this.pinHeadMeshMaterial=new ie.Nv(m,l,h,1),this.pinHeadMesh=new H.$(e,this.pinHeadGeometryInst,this.pinHeadMeshMaterial,r),this.add(this.pinHeadMesh),this.stemMesh=new se(i.stemNormal,i.stemEnabled,r,this.pinHeadMesh,d),this.add(this.stemMesh),this.updateMeshPosition(i),this.opacityAnimation=new re.z(1)}dispose(){this.remove(this.pinHeadMesh),this.pinHeadMesh.material.dispose(),this.pinHeadMesh.dispose(),this.remove(this.stemMesh),this.stemMesh.dispose()}static disposeAll(){de.pinHeadGeometry.dispose()}updateFromPin(e,t,i,a,s,o,r){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemVector.copy(e.stemNormal).setLength(e.stemLength),this.stemEnabled=e.stemEnabled,this.stemMesh.updatePosition(e),this.stemMesh.visible=e.stemEnabled,this.pinHeadGeometryInst.setAttribute("instanceUvOffset",new n.BufferAttribute(i,2)),this.pinHeadGeometryInst.setAttribute("instanceUvScale",new n.BufferAttribute(a,1)),this.pinHeadGeometryInst.setAttribute("instanceStrokeWidth",new n.BufferAttribute(r,1)),t!==this.pinColor&&(this.pinColor=t,this.setColorVariant(this.currentColorVariant));const d=this.pinHeadMeshMaterial.uniforms;d.bg.value===s&&d.mask.value===o||(d.bg.value=s,d.mask.value=o,this.pinHeadMeshMaterial.uniformsNeedUpdate=!0)}setColorVariant(e){const t=(0,oe.k)(this.pinColor,e);this.pinHeadMeshMaterial.uniforms.color.value.copy(t),this.currentColorVariant=e}setOpacity(e){this.baseOpacity=e,this.updateOpacity()}setOpacityScale(e){this.opacityScale=e,this.updateOpacity()}fadeOpacity(e){e>0&&(this.visible=!0),this.opacityAnimation.modifyAnimation(this.opacityAnimation.value,e,300).onComplete((()=>{e<=0&&(this.visible=!1)}))}setVisibility(e,t){this.visible=e,this.pinHeadMesh.visible=e,this.stemMesh.visible=e&&t}setStemEnabled(e){this.stemMesh.visible=this.visible&&e}updateMeshPosition(e){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemMesh.updatePosition(e)}update(e,t,i,n){this.pinHeadMesh.update(t,i,n);const a=this.opacityAnimation.active;this.opacityAnimation.tick(e),a&&this.updateOpacity()}setRenderOverrides(e,t){this.pinHeadMesh.material=e?new ie.m0(e,!1):this.pinHeadMeshMaterial,t?this.pinHeadMesh.geomScale.copy(t):this.pinHeadMesh.geomScale.set(1,1,1),this.setOpacity(this.pinHeadMeshMaterial.opacity)}updateOpacity(){const e=this.opacityAnimation.value*this.baseOpacity*this.opacityScale;if(this.pinHeadMeshMaterial.opacity=e,this.pinHeadMeshMaterial.uniforms.alpha.value=e,this.pinHeadMesh.material!==this.pinHeadMeshMaterial){this.pinHeadMesh.material.opacity=e;const t=this.pinHeadMesh.material;t&&t.uniforms&&t.uniforms.alpha&&(t.uniforms.alpha.value=e)}this.stemMesh.pinStemMaterial.uniforms.alpha.value=e}}var le=i(81346);class he extends ae{constructor(e,t,i,n,a,s,o,r){super(e,n,a,s),this.camera=t,this.canvasData=i,this.codepointMap=r,this.idToMesh=new Map,this.inputCallbacks=o}dispose(){super.dispose(),this.removePinsByPredicate((()=>!0)),de.disposeAll()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(M.R,H.$,((e,t)=>{const i=t.parent;return this.inputCallbacks.onClick(i.pinId,i.pinType),!0}))),(0,r.Jm)()||(this.bindings.push(this.input.registerMeshHandler(Q.z,k.s.isType(H.$),((e,t)=>{const i=t.parent;this.inputCallbacks.onHover(i.pinId,i.pinType)}))),this.bindings.push(this.input.registerMeshHandler(Q.A,k.s.isType(H.$),((e,t)=>{const i=t.parent;this.inputCallbacks.onUnhover(i.pinId,i.pinType)})))))}render(e){const t=this.getViewportScale(this.canvasData);this.idToMesh.forEach((i=>{i.update(e,this.camera,t,this.canvasData)})),super.render(e)}updatePin(e,t,i,n,a,s){var o,r;super.updatePin(e,t,i,n,a,s);const d=this.getColor(i.color),l=(0,oe.m)(t,i.icon,this.iconsEnabled),h=le.f[l],c=this.codepointMap[+h],m=new Float32Array(8),u=new Float32Array(4),p=new Float32Array(4);if(c){const{u:e,v:t,uvScale:i}=c;u[0]=i,u[1]=i,u[2]=i,u[3]=i,m[0]=e,m[2]=e,m[4]=e,m[6]=e,m[1]=t,m[3]=t,m[5]=t,m[7]=t}const g=t===L.Er.OBJECT?0:.06;p[0]=g,p[1]=g,p[2]=g,p[3]=g;let v=this.idToMesh.get(e);v||(v=new de(e,t,i,d,m,u,this.layer,this.canvasData,n,a,p),this.idToMesh.set(e,v),this.input.registerMesh(v.pinHeadMesh,!1)),void 0!==s&&(v.visible=s),v.updateFromPin(i,d,m,u,n,a,p);const y=i.floorId;v.parent&&(null===(o=v.parent)||void 0===o?void 0:o.userData.floorId)===y||(v.parent&&(null===(r=v.parent)||void 0===r||r.remove(v)),this.getFloorContainer(y).userData.typeContainers[t].add(v))}removePin(e){var t;super.removePin(e);const i=this.idToMesh.get(e);i&&(this.idToMesh.delete(e),null===(t=i.parent)||void 0===t||t.remove(i),this.input.unregisterMesh(i.pinHeadMesh),i.dispose())}removePinsByPredicate(e){this.idToMesh.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToMesh.get(e);i&&(i.visible=t)}setPinColorVariant(e,t){const i=this.idToMesh.get(e);i&&i.setColorVariant(t)}setPinColorVariants(e,t){this.idToMesh.forEach((i=>{i.pinId!==t&&i.setColorVariant(e)}))}setPinColorVariantByType(e,t,i){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==i&&n.setColorVariant(t)}))}setPinOpacity(e,t){const i=this.idToMesh.get(e);i&&i.setOpacity(t)}setPinOpacityScale(e,t){const i=this.idToMesh.get(e);i&&i.setOpacityScale(t)}fadePinOpacity(e,t){const i=this.idToMesh.get(e);i&&i.fadeOpacity(t)}setPinOpacityByType(e,t,i){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==i&&n.setOpacity(t)}))}fadePinOpacityByType(e,t,i=[]){this.idToMesh.forEach((n=>{n.pinType!==e||i.includes(n.pinId)||n.fadeOpacity(t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToMesh.get(e);n&&n.setRenderOverrides(t,i)}pinHeadTransform(e){const t=this.idToMesh.get(e);return t?t.pinHeadMesh.matrixWorld:new n.Matrix4}}var ce=i(66372),me=i(49827),ue=i(21646),pe=i(90304),ge=i(79183);const ve=new ie.uW,ye=new E.Z("InstancedPinHeads");class we extends n.InstancedMesh{constructor(e){const t=new n.BufferGeometry,i=new Float32Array(6);i[0]=i[1]=i[2]=0,i[3]=1,i[4]=1,i[5]=1,t.setAttribute("position",new n.BufferAttribute(i,3));const a=new Float32Array(3*e),s=new n.InstancedBufferAttribute(a,3);t.setAttribute("stemVector",s);const o=new Float32Array(e),r=new n.InstancedBufferAttribute(o,1);t.setAttribute("instanceAlpha",r);const d=[],l=[];for(let i=0;i<4;i++){const a=new Float32Array(4*e),s=new n.InstancedBufferAttribute(a,4);t.setAttribute(`pinHeadMatrixCol${i}`,s),d.push(a),l.push(s)}super(t,ve,e),this.maxCount=e,this.stemVectorArray=a,this.stemVectorAttrib=s,this.pinHeadMatrixArray=d,this.pinHeadMatrixAttrib=l,this.opacityArray=o,this.opacityAttrib=r,this.renderOrder=U.z.lines,this.posMatrix=new n.Matrix4,this.isLine=!0,this.isMesh=!1}update(e,t){let i=0;for(const t of e){if(!t.visible||!t.stemEnabled||t.stemLength<.001)continue;if(i>=this.maxCount){ye.error("Instance count is too small!");continue}this.posMatrix.setPosition(t.anchorPosition),this.setMatrixAt(i,this.posMatrix),this.opacityArray[i]=t.opacity*t.opacityAnimation.value*t.opacityScale;const e=3*i;t.pinHeadObjPosition.toArray(this.stemVectorArray,e);let n=0;for(let e=0;e<4;e++)for(let a=0;a<4;a++)this.pinHeadMatrixArray[e][a+4*i]=t.pinHeadMatrix.elements[n++];i++}this.count=i,this.visible=this.count>0,this.instanceMatrix.needsUpdate=!0,this.stemVectorAttrib.needsUpdate=!0;for(const e of this.pinHeadMatrixAttrib)e.needsUpdate=!0;this.opacityAttrib.needsUpdate=!0,ve.uniforms.resolution.value.set(t.width,t.height),ve.uniformsNeedUpdate=!0}}const be=new E.Z("InstancedPinRenderer");class fe extends ae{constructor(e,t,i,a,s,o,r,d){super(e,a,s,o),this.camera=t,this.canvasData=i,this.codepointMap=d,this.pins=new Map,this.idToPin=new Map,this.keyToRenderObjs=new Map,this.updatePinHeadMatrix=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3,a=new n.Vector3,s=new n.Vector3,o=new n.Vector3,r=new n.Vector3;return n=>{const d=z.Z.pinHeadMesh.scale,l=this.getViewportScale(this.canvasData),h=1+d.responsiveness/100*(l-1);this.camera.getWorldPosition(o);const c=this.camera.quaternion,m=this.canvasData;for(const l of n){r.copy(l.pinHeadObjPosition).add(l.anchorPosition);const n=o.distanceTo(r),u=d.maxSize-(d.maxSize-d.minSize)*(0,ce.C)(n,d.nearBound,d.farBound);t.copy(r).project(this.camera),i.set(m.width/2,m.height/2,1).multiply(t),a.set(u/2,0,0).add(i),s.set(2/m.width,2/m.height,1).multiply(a);const p=s.unproject(this.camera).distanceTo(r)*h,g=(0,me.uZ)(p,ue.Z.epsilon,p),v=l.geomScale||pe.f.UNIT;e.set(g*v.x,g*v.y,g*v.z),l.pinHeadMatrix.compose(r,c,e)}}})(),this.inputCallbacks=r}dispose(){super.dispose()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(M.R,ge.z,((e,t,i)=>{if(!i||void 0===i.instanceId)return!0;const n=t.renderedPins[i.instanceId];return this.inputCallbacks.onClick(n.id,n.pinType),!0}))),(0,r.Jm)()||(this.bindings.push(this.input.registerMeshHandler(Q.z,k.s.isType(ge.z),((e,t,i)=>{if(!i||void 0===i.instanceId)return;const n=t.renderedPins[i.instanceId];this.lastHoverId=n.id,this.lastHoverType=n.pinType,this.inputCallbacks.onHover(n.id,n.pinType)}))),this.bindings.push(this.input.registerMeshHandler(Q.A,k.s.isType(ge.z),(()=>{this.inputCallbacks.onUnhover(this.lastHoverId,this.lastHoverType)})))))}render(e){var t,i,n,a;for(const s of this.pins.values()){const o=Array.from(s.values());if(0===o.length)continue;const r=this.keyFromPin(o[0]),d=this.keyToRenderObjs.get(r);if(!d){be.error("Expecting renderObjs for this key.",this.keyToRenderObjs,this.keyFromPin(o[0]));continue}let{lines:l,pinHeads:h}=d;if(o.forEach((t=>t.opacityAnimation.tick(e))),this.updatePinHeadMatrix(o),l.maxCount<o.length){const e=l.parent;if(!e){be.error("Expecting a parent.");continue}e.remove(l),l.dispose(),e.remove(h),this.input.unregisterMesh(h);const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=o[0];h.dispose(),Object.assign(d,this.createInstances(e,d.id,o.length+16,t,i,n)),l=d.lines,h=d.pinHeads}l.update(o,this.canvasData),(null===(t=o[0].maskTexture)||void 0===t?void 0:t.uuid)&&(null===(a=null===(n=null===(i=h.material.uniforms)||void 0===i?void 0:i.mask)||void 0===n?void 0:n.value)||void 0===a?void 0:a.uuid)&&o[0].maskTexture.uuid!==h.material.uniforms.mask.value.uuid&&h.updateMaskTexture(o[0].maskTexture),h.update(o)}super.render(e)}updatePin(e,t,i,a,s,o){var r;super.updatePin(e,t,i,a,s,o);let d=this.idToPin.get(e);const l=i.floorId,h=this.getColor(i.color).baseColor,c=`${l}_${t}_${(null===(r=null==d?void 0:d.overrideTexture)||void 0===r?void 0:r.uuid)||a.uuid}`,m=(0,oe.m)(t,i.icon,this.iconsEnabled),u=le.f[m],p=this.codepointMap[+u],g=t===L.Er.OBJECT?0:.06;if(!d){d=Object.assign(Object.assign({id:e},i),{visible:!0,opacity:1,opacityScale:1,pinType:t,opacityAnimation:new re.z(0),backgroundTexture:a,maskTexture:s,pinHeadMatrix:new n.Matrix4,pinHeadObjPosition:new n.Vector3,pinColor:h,colorVariant:L.K_.DEFAULT,overrideTexture:null,geomScale:null,pinIconUVOffset:p,pinStrokeWidth:g,needsEntryAnimation:!0}),this.idToPin.set(e,d);let o=this.pins.get(c);o||(o=new Map,this.pins.set(c,o)),o.set(e,d),this.createRenderObjsForPin(d)}const v=this.keyFromPin(d);Object.assign(d,i,{pinType:t,textureId:a.uuid,maskTexture:s}),this.changePinHeadGroupIfNeeded(v,c,d),d.pinHeadObjPosition.copy(d.stemNormal).setLength(d.stemLength),d.pinColor=(0,oe.k)(this.getColor(d.color),d.colorVariant),d.pinIconUVOffset=p,d.pinStrokeWidth=g,void 0!==o&&this.setPinVisible(e,o),p&&d.needsEntryAnimation&&(d.opacityAnimation.modifyAnimation(d.opacityAnimation.value,1,500,te.ad),d.opacityAnimation.onComplete((()=>{d&&(d.needsEntryAnimation=!1)})))}removePin(e){super.removePin(e);const t=this.idToPin.get(e);if(!t)return;this.idToPin.delete(e);const i=this.keyFromPin(t),n=this.pins.get(i);n&&(n.delete(e),this.cleanupRenderObjIfNeeded(i))}removePinsByPredicate(e){this.idToPin.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToPin.get(e);i?i.visible=t:be.error("setPinVisible on a pin that doesn't exist.",e)}setPinColorVariant(e,t){const i=this.idToPin.get(e);i?(i.colorVariant=t,i.pinColor=(0,oe.k)(this.getColor(i.color),t)):be.error("setPinColorVariant on a pin that doesn't exist.")}setPinColorVariants(e,t){this.idToPin.forEach(((i,n)=>{n!==t&&this.setPinColorVariant(n,e)}))}setPinColorVariantByType(e,t,i){this.idToPin.forEach(((n,a)=>{n.pinType===e&&a!==i&&this.setPinColorVariant(a,t)}))}setPinOpacity(e,t){const i=this.idToPin.get(e);i?i.opacity=t:be.error("setPinOpacity on a pin that doesn't exist.")}setPinOpacityScale(e,t){const i=this.idToPin.get(e);i?i.opacityScale=t:be.error("setPinOpacityScale on a pin that doesn't exist.")}fadePinOpacity(e,t){const i=this.idToPin.get(e);i?(t>0&&this.setPinVisible(e,!0),i.opacityAnimation.modifyAnimation(i.opacityAnimation.value,t,300).onComplete((()=>{i.opacityAnimation.endValue<=0&&this.setPinVisible(e,!1)}))):be.error("setPinVisible on a pin that doesn't exist.",e)}setPinOpacityByType(e,t,i){this.idToPin.forEach(((n,a)=>{n.pinType===e&&a!==i&&this.setPinOpacity(a,t)}))}fadePinOpacityByType(e,t,i=[]){this.idToPin.forEach(((n,a)=>{n.pinType!==e||i.includes(a)||this.fadePinOpacity(a,t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToPin.get(e);if(!n)return void be.error("setPinRenderOverrides on a pin that doesn't exist.");const a=this.keyFromPin(n);if(!this.keyToRenderObjs.get(a))return void be.error("Expecting renderObjs while setting override material");n.overrideTexture=t,n.geomScale=i;const s=this.keyFromPin(n);this.changePinHeadGroupIfNeeded(a,s,n)}pinHeadTransform(e){const t=this.idToPin.get(e);return t?t.pinHeadMatrix:(be.error("pinHeadTransform on a pin that doesn't exist."),new n.Matrix4)}keyFromPin(e){return`${e.floorId}_${e.pinType}_${e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid}`}createRenderObjsForPin(e){const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=e,a=this.keyFromPin(e);if(this.keyToRenderObjs.get(a))return;const s=this.getFloorContainer(e.floorId).userData.typeContainers[e.pinType];s.userData||(s.userData={});const o=e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid;if(!s.userData[o]){const e=this.createInstances(s,o,16,t,i,n);s.userData[o]=e,this.keyToRenderObjs.set(a,e)}}createInstances(e,t,i,n,a,s){const o=new we(i);o.layers.mask=this.layer.mask,e.add(o);const r=new ge.z(i,s||n,s?null:a,!s);return r.layers.mask=this.layer.mask,e.add(r),this.input.registerMesh(r,!1),{lines:o,pinHeads:r,id:t}}changePinHeadGroupIfNeeded(e,t,i){if(e!==t){let n=this.pins.get(t);n||(n=new Map,this.pins.set(t,n)),n.set(i.id,i),this.createRenderObjsForPin(i);const a=this.pins.get(e);a&&(null==a||a.delete(i.id),this.cleanupRenderObjIfNeeded(e))}}cleanupRenderObjIfNeeded(e){const t=this.pins.get(e),i=this.keyToRenderObjs.get(e);if(t&&0===t.size&&i){const t=i.lines.parent;if(this.input.unregisterMesh(i.pinHeads),this.pins.delete(e),this.keyToRenderObjs.delete(e),!t)return void be.error("Expecting pinTypeObj!");t.userData[i.id]=void 0,t.remove(i.lines),t.remove(i.pinHeads)}}}var Te=i(80742),De=i(67557),Ce=i(44148),Pe=i(34029);const Ae=Object.values(L.Qk),Ie=e=>e.map((e=>String.fromCharCode(+le.f[e]))),Ee={fontPath:"fonts/mp-font.woff",fontWeight:700,fontFamily:"mp-font",fontStyle:"normal",fontSize:120,squareSize:128,width:4096,height:4096,transparent:!0,defaultCharset:De.Tz.NONE,initialChars:Ie(Ae),outline:!1,outlineWidth:0,texturePadding:0};class ke extends a.Y{constructor(){super(...arguments),this.name="pins",this.editActivated=!1,this.editBindings=[],this.touchDevice=(0,r.Jm)(),this.worldPosition=new n.Vector3,this.fontManager=De.Qi.instance,this.visibilityChanged=()=>{const e=!this.in360View(),t=!this.interactionmodeData.isVR();this.pinRenderer.container.visible=e&&t;const{floorsViewData:i}=this,n=this.viewmode===g.Ey.Dollhouse||this.viewmode===g.Ey.Floorplan,a=i.transition.progress.active?()=>!0:i.isHidden;this.pinRenderer.setFloorsHidden(n?a:()=>!1)},this.viewmodeChanged=e=>{this.viewmode=e.toMode,this.visibilityChanged()},this.onEnablePinEditing=async e=>{e.enabled?this.enableEditing():this.disableEditing()},this.updateCurrentPin=()=>{const{pinEditorState:e,focusedPin:t,selectedPinId:i}=this.viewData;if(e!==L.V8.CREATING){const e=i?this.viewData.getPin(i):null,n=t||e;if(this.pinEditor.updateAnchorMesh(),n){const{id:e,pinType:t,backgroundTexture:i}=n;this.pinRenderer.updatePin(e,t,n,i,this.iconMaskTexture),this.pinRenderer.setPinColorVariant(e,L.K_.HIGHLIGHTED),this.pinRenderer.setPinColorVariants(L.K_.DEFAULT,e)}else this.pinRenderer.setPinColorVariants(L.K_.DEFAULT)}},this.onUpdatePin=async e=>{const{id:t,pinType:i,properties:n}=e,a=this.viewData.getPin(t);if(a&&a.pinType===i){const{focusedPin:e,selectedPinId:i}=this.viewData,s=i?this.viewData.getPin(i):null,o=Object.assign(Object.assign({},a),n);this.viewData.updatePin(o),this.pinRenderer.updatePin(o.id,o.pinType,o,o.backgroundTexture,this.iconMaskTexture),(null==s?void 0:s.id)===t&&(this.saveScreenPosition(o),this.updateCurrentPin()),(null==e?void 0:e.id)===t&&this.saveScreenPosition(o),o.icon&&this.addIconsToAtlas([o.icon])}else this.log.debug(`Cannot update non-existent ${i} pin`)},this.onUpdatePinViews=async e=>{const{pinViews:t}=e,i=[];t.forEach((e=>{this.viewData.updatePin(e),this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,this.iconMaskTexture,e.visible),this.viewData.selectedPinId===e.id&&(this.viewData.updatePin(e),this.updateCurrentPin()),void 0!==e.opacity&&this.pinRenderer.setPinOpacity(e.id,e.opacity),void 0!==e.scale&&this.pinRenderer.setPinRenderOverrides(e.id,null,e.scale),e.icon&&i.push(e.icon)})),this.addIconsToAtlas(i)},this.addIconsToAtlas=(e=Ae)=>{const t=Ie(e);this.fontManager.getFont(this.fontId).addCharsIfNeeded(t.join(""))},this.refreshPins=()=>{this.viewData.iteratePins(((e,t)=>{this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,this.iconMaskTexture)}))},this.onChangePinVisibility=async e=>{const{id:t,pinType:i,visible:n}=e,a=this.viewData.getPin(t);if(a&&a.pinType===i){this.pinRenderer.setPinVisible(t,n);const{selectedPinId:e,focusedPin:i}=this.viewData;n||e!==t||this.changeSelectedPin(null),n||(null==i?void 0:i.id)!==t||this.viewData.setFocusedPin(null)}else this.log.debug(`Cannot change visibility of non-existent ${i} pin`)},this.onChangePinVisibilityByType=async e=>{const{pinType:t,visible:i}=e;this.pinRenderer.setPinTypeVisible(t,i)},this.onChangePinOpacity=async e=>{const{id:t,pinType:i,opacity:n}=e,a=this.viewData.getPin(t);a&&a.pinType===i?this.pinRenderer.setPinOpacity(t,n):this.log.debug(`Cannot change opacity of non-existent ${i} pin`)},this.onChangePinOpacityScale=async e=>{const{id:t,pinType:i,scale:n}=e,a=this.viewData.getPin(t);a&&a.pinType===i?this.pinRenderer.setPinOpacityScale(t,n):this.log.debug(`Cannot change opacity scaling of non-existent ${i} pin`)},this.onChangePinOpacityByType=async e=>{const{pinType:t,opacity:i,skipIds:n}=e;this.pinRenderer.fadePinOpacityByType(t,i,n)},this.onUnselectPin=async e=>{const{pinType:t,id:i}=e,{selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;(null==a?void 0:a.pinType)===t&&(null==a?void 0:a.id)===i&&this.changeSelectedPin(null)},this.clearPinSelection=async()=>{this.changeSelectedPin(null)},this.onStartPinCreation=async e=>{const{id:t,pin:i,pinType:n,backgroundTexture:a}=e,s=this.viewData,o=Object.assign(Object.assign({id:t,pinType:n},i),{backgroundTexture:a});s.setEditablePin(!0),s.setPinEditorState(L.V8.CREATING),this.changeSelectedPin(o),this.pinEditor.startPinCreation()},this.saveScreenPosition=(()=>{const e=new n.Vector3;return t=>{const i=this.viewData;e.copy(t.stemNormal).setLength(t.stemLength),this.worldPosition.copy(t.anchorPosition).add(e);const n=(0,o.q9)(this.cameraData,this.worldPosition);i.setScreenPosition(n.ndcPosition.z>1?null:n.screenPosition)}})(),this.onCameraUpdate=()=>{const{creatingNewPin:e,focusedPin:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;!e&&t?this.saveScreenPosition(t):n&&this.saveScreenPosition(n)},this.handleSweepChange=()=>this.handleSweepAndViewModeChange(),this.handleViewModeChange=()=>this.handleSweepAndViewModeChange(),this.cancelPinCreation=()=>{const{creatingNewPin:e,selectedPinId:t}=this.viewData;if(this.changeSelectedPin(null),t){const i=t?this.viewData.getPin(t):null;e&&i&&(this.engine.broadcast(new W.hu(i.id,i.pinType)),this.removePin(i.id,i.pinType),this.pinEditor.endPinCreation())}this.resetEditingState()},this.onPinPlacementCancelled=()=>{this.cancelPinCreation()},this.onCancelNewPin=async()=>{this.cancelPinCreation()},this.onViewChange=()=>{this.cancelPinCreation()},this.handleRemovingPin=async e=>{const{pinType:t,id:i}=e;this.removePin(i,t)},this.handleRemovingPinsByType=async e=>{const{pinType:t}=e;if(t===L.Er.MATTERTAG&&!this.tagsEnabled)return;const{focusedPin:i,selectedPinId:n}=this.viewData,a=n?this.viewData.getPin(n):null;(null==a?void 0:a.pinType)===t&&this.changeSelectedPin(null),(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePinsByType(t),this.pinRenderer.removePinsByType(t)},this.onPinClicked=e=>{const{pinType:t,id:i}=e;if(t===L.Er.MATTERTAG&&!this.tagsEnabled)return;const{creatingNewPin:n,selectedPinId:a}=this.viewData,s=a?this.viewData.getPin(a):null,o=i===(null==s?void 0:s.id)&&t===(null==s?void 0:s.pinType);if(s&&o){if(n)return;this.changeSelectedPin(null)}else if(n)this.cancelPinCreation();else{if(!(i===(null==s?void 0:s.id)&&t===(null==s?void 0:s.pinType))){const e=this.viewData.getPin(i);e&&this.changeSelectedPin(e)}}},this.onHoverChanged=e=>{const{pinType:t,id:i,hovering:n}=e;if(t===L.Er.MATTERTAG&&!this.tagsEnabled)return;const{creatingNewPin:a,focusedPin:s,selectedPinId:o}=this.viewData;if(!a)if(n){const e=this.viewData.getPin(i);if(!e)return void this.log.debug("Cannot find pin to focus");const n=o?this.viewData.getPin(o):null;if(this.viewData.setFocusedPin(e),n&&n.id===i&&n.pinType===t)return;this.saveScreenPosition(e),this.pinRenderer.setPinColorVariantByType(t,L.K_.DEFAULT,null==s?void 0:s.id),this.pinRenderer.setPinColorVariant(i,L.K_.HIGHLIGHTED)}else s&&(this.pinRenderer.setPinColorVariant(s.id,L.K_.DEFAULT),this.viewData.setFocusedPin(null))},this.onSelectPin=async e=>{const{id:t,pinType:i,editable:n}=e,a=this.viewData,{selectedPinId:s,isPinEditable:o}=a;if(a.setPinEditorState(L.V8.IDLE),t===s&&n===o)return void this.log.debug("Pin is already selected");const r=this.viewData.getPin(t);r&&r.pinType===i?(a.setEditablePin(n),this.changeSelectedPin(r)):this.log.debug(`Cannot select ${i} pin`)},this.clickOffPin=async()=>{this.viewData.creatingNewPin||this.changeSelectedPin(null)},this.movePin=async e=>{const{isPinEditable:t,selectedPinId:i}=this.viewData;if(!t)return;const{pos:n,previousPos:a,id:s}=e,o=i?this.viewData.getPin(i):null;if(o&&o.id===s){const t=Object.assign(Object.assign({},o),e.pos);this.viewData.updatePin(t),this.updateCurrentPin(),this.engine.broadcast(new W.bV(o.id,o.pinType,n,a))}else this.log.debug("Cannot move the pin, not open for edit")},this.placePin=async e=>{const{isPinEditable:t,canPlace:i,selectedPinId:n}=this.viewData;if(!t)return;const a=n?this.viewData.getPin(n):null;a&&i?(this.viewData.setPinEditorState(L.V8.PLACED),this.engine.broadcast(new W.b0(a.id,a.pinType,a))):(this.log.debug("Cannot place pin because there is no open pin"),this.cancelPinCreation())}}async init(e,t){var i;this.engine=t,this.tagsEnabled=e.newTagsEnabled;const[n,a,o,r,g,C]=await Promise.all([t.getModuleBySymbol(s.y.INPUT),t.getModuleBySymbol(s.y.WEBGL_RENDERER),t.market.waitForData(l.W),t.market.waitForData(d.pu),t.getModuleBySymbol(s.y.RAYCASTER),t.market.waitForData(Te.R)]);this.input=n;const P={onClick:(e,i)=>{t.broadcast(new W.F7(e,i))},onHover:(e,i)=>{t.broadcast(new W.tP(e,!0,i)),t.commandBinder.issueCommand(new y.u(w.C.FINGER)),t.commandBinder.issueCommand(new v.y(!0))},onUnhover(e,i){t.broadcast(new W.tP(e,!1,i)),t.commandBinder.issueCommand(new y.u(null)),t.commandBinder.issueCommand(new v.y(!1))}},A=t.claimRenderLayer(this.name);this.defaultPinMaskTexture=(0,j.p)(Ce),this.iconMaskTexture=this.defaultPinMaskTexture;const I=`${null!==(i=(await t.market.waitForData(Pe.e)).getProperty("assetBasePath"))&&void 0!==i?i:""}`;this.fontId=this.fontManager.getFontId(Object.assign(Object.assign({},Ee),{fontPath:`${I}${Ee.fontPath}`}));const{font:E,codepointMap:k}=this.fontManager.getFontAndCodepoints(this.fontId);E.textures[0]&&(this.iconMaskTexture=E.textures[0]),E.onChanged((()=>{const e=this.fontManager.getFontAndCodepoints(this.fontId);e.font.textures[0]&&(this.iconMaskTexture=e.font.textures[0]),this.pinRenderer.codepointMap=e.codepointMap,this.refreshPins()})),this.pinRenderer=a.supportsInstancing()?new fe(n,a.getCamera(),o,A,t.commandBinder,g,P,k):new he(n,a.getCamera(),o,A,t.commandBinder,g,P,k),this.pinRenderer.iconsEnabled=e.tagIconsEnabled,a.getScene().add(this.pinRenderer.container),t.addComponent(this,this.pinRenderer),[this.floorsViewData,this.viewmodeData,this.interactionmodeData,this.sweepData,this.cameraData]=await Promise.all([t.market.waitForData(h.c),t.market.waitForData(p.O),t.market.waitForData(c.Z),t.market.waitForData(u.Z),t.market.waitForData(m.M)]),this.viewData=new D.B,this.pinEditor=new Z(this.viewData,this.engine,this.input,this.pinRenderer),this.floorsViewData.iterate((e=>this.pinRenderer.getFloorContainer(e.id))),this.viewmode=this.viewmodeData.currentMode,this.bindings.push(t.commandBinder.addBinding($.Ki,this.onEnablePinEditing),t.commandBinder.addBinding($.Ar,this.onSelectPin),t.commandBinder.addBinding($.RH,this.onUnselectPin),t.commandBinder.addBinding($.iK,this.clearPinSelection),t.commandBinder.addBinding($.yR,this.clickOffPin),t.commandBinder.addBinding($.tE,this.onUpdatePin),t.commandBinder.addBinding($.mE,this.onUpdatePinViews),t.commandBinder.addBinding($.ik,this.onChangePinVisibility),t.commandBinder.addBinding($.qN,this.onChangePinVisibilityByType),t.commandBinder.addBinding($._Y,this.onChangePinOpacity),t.commandBinder.addBinding($.nP,this.onChangePinOpacityScale),t.commandBinder.addBinding($.kb,this.onChangePinOpacityByType),t.commandBinder.addBinding($.fM,this.onStartPinCreation),t.commandBinder.addBinding($.OL,this.handleRemovingPin),t.commandBinder.addBinding($.zM,this.handleRemovingPinsByType),t.commandBinder.addBinding($.I$,this.movePin),this.interactionmodeData.onChanged(this.visibilityChanged),this.floorsViewData.onChanged(this.visibilityChanged),this.viewmodeData.makeModeChangeSubscription(this.visibilityChanged),t.subscribe(b.Z,this.visibilityChanged),t.subscribe(T.a,this.viewmodeChanged),t.subscribe(f.Z,this.viewmodeChanged),t.subscribe(W.F7,this.onPinClicked),this.viewData.onPinEditorStateChanged(this.updateCurrentPin),this.viewData.onSelectedPinChanged(this.updateCurrentPin),this.viewData.onFocusedPinChanged(this.updateCurrentPin),this.viewData.onPinEditableChanged(this.updateCurrentPin),this.cameraData.onChanged(this.onCameraUpdate),C.onPropertyChanged("currentViewId",this.onViewChange)),this.touchDevice||this.bindings.push(t.subscribe(W.tP,this.onHoverChanged));let S=r.application;this.bindings.push(r.onPropertyChanged("application",(e=>{e!==S&&(this.visibilityChanged(),this.viewData.creatingNewPin?this.cancelPinCreation():(this.changeSelectedPin(null),this.viewData.setFocusedPin(null),this.resetEditingState()),S=e)}))),this.visibilityChanged(),t.market.register(this,D.B,this.viewData)}dispose(e){this.disableEditing(),this.pinEditor.dispose(),this.pinRenderer.dispose(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.editBindings=[],super.dispose(e)}onUpdate(){this.editActivated&&this.pinEditor.update()}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}enableEditing(){if(!this.editActivated){if(this.editActivated=!0,this.pinEditor.toggleEditing(!0),0===this.editBindings.length){const e=this.engine,t=e.commandBinder;this.editBindings.push(t.addBinding($.ip,this.placePin),t.addBinding($.tT,this.onCancelNewPin),this.sweepData.makeSweepChangeSubscription(this.handleSweepChange),e.subscribe(f.Z,this.handleViewModeChange),e.subscribe(W.pe,this.onPinPlacementCancelled))}else this.editBindings.forEach((e=>{e.renew()}));this.handleSweepAndViewModeChange()}}disableEditing(){this.editActivated&&(this.editActivated=!1,this.pinEditor.toggleEditing(!1),this.cancelPinCreation(),this.editBindings.forEach((e=>{e.cancel()})))}changeSelectedPin(e){const{selectedPinId:t}=this.viewData;if(((null==e?void 0:e.id)||null)===t)return void this.log.debug("Pin selection did not change");(t?this.viewData.getPin(t):null)&&this.pinRenderer.hideSelectedMesh(),e?(this.saveScreenPosition(e),this.viewData.setSelectedPinId(e.id),this.pinRenderer.showSelectedMesh(e.pinType,e.id)):(this.viewData.setScreenPosition(null),this.viewData.setSelectedPinId(null))}handleSweepAndViewModeChange(){const e=this.viewData,t=!this.in360View();e.creatingNewPin&&!t?this.cancelPinCreation():e.setCanAdd(t)}resetEditingState(){const e=this.viewData;e.setPinEditorState(L.V8.IDLE),e.setEditablePin(!1),e.setCanPlace(!0),e.setCanAdd(!this.in360View())}removePin(e,t){if(t===L.Er.MATTERTAG&&!this.tagsEnabled)return;const{focusedPin:i,selectedPinId:n}=this.viewData;n===e&&this.changeSelectedPin(null),(null==i?void 0:i.id)===e&&(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePin(e),this.pinRenderer.removePin(e)}}const Se=ke},49657:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var n,a=i(97542),s=i(57956),o=i(53954),r=i(46368),d=i(9699),l=i(39880);!function(e){e[e.None=0]="None",e[e.Queued=1]="Queued",e[e.Rendering=2]="Rendering",e[e.Rendered=3]="Rendered"}(n||(n={}));class h{constructor(e){this.statusMap={},this.active=[],this.queued=[],this.panoRenderer=e,this.disablePreRendering()}init(){}dispose(){}activate(e){}deactivate(e){this.disablePreRendering()}enablePreRendering(){this.enabled=!0}disablePreRendering(){this.enabled=!1}render(){}beforeRender(){this.enabled&&this.processQueued()}tryPreRender(e){return this.getPreRenderState(e)===n.None&&(this.queued.push(e),this.statusMap[e]=n.Queued,!0)}getPreRenderState(e){const t=this.statusMap[e];return void 0!==t?t:n.None}processQueued(){let e=0;for(const t of Object.keys(this.statusMap))this.statusMap[t]===n.Rendering&&e++;if(0===e&&this.queued.length>0){const e=this.queued.shift();if(e){this.active.push(e),this.statusMap[e]=n.Rendering;this.panoRenderer.activateSweep(e).then((()=>{this.onRendered(e)}))}}}cleanup(e=[]){const t=(0,l.ow)(e),i=[];for(const e of this.queued)t[e]?i.push(e):this.statusMap[e]=n.None;this.queued.length=0,this.queued.push.apply(this.queued,i);const a=[];for(const e of this.active)t[e]?a.push(e):this.statusMap[e]=n.None;this.active.length=0,this.active.push.apply(this.active,a)}onRendered(e){this.statusMap[e]=n.Rendered}}var c=i(34029);class m extends a.Y{constructor(){super(...arguments),this.name="prerenderer-module",this.lastPrerendered=null}async init(e,t){if((await t.market.waitForData(c.e)).getOverrideParam("pre",!0)||e.preRenderTourPanos){this.sweepData=await t.market.waitForData(o.Z);const e=await t.getModuleBySymbol(s.y.SWEEP_PANO);this.panoRenderer=e.getRenderer(),this.preRenderer=new h(this.panoRenderer),t.addComponent(this,this.preRenderer),this.bindings.push(t.subscribe(r.Z,(e=>{this.preRenderer.enablePreRendering(),this.lastPrerendered=null,e.sweepIds&&e.sweepIds.length>=3&&(this.lastPrerendered=e.sweepIds[2],this.preRenderer.tryPreRender(this.lastPrerendered)),this.cleanup(this.sweepData),this.currentRestrictedSweeps=e.sweepIds}))),this.bindings.push(t.subscribe(d.Z,(e=>{this.preRenderer.disablePreRendering(),this.cleanup(this.sweepData,!0),this.currentRestrictedSweeps=null})))}}getCurrentSweeps(){return this.currentRestrictedSweeps||[]}cleanup(e,t=!1){const i=[];e.transition.active?(e.transition.from&&i.push(e.transition.from),e.transition.to&&i.push(e.transition.to)):e.currentSweep&&i.push(e.currentSweep),this.lastPrerendered&&i.push(this.lastPrerendered),t&&this.panoRenderer.freeAllTextures(i),this.preRenderer.cleanup(i)}}},74909:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var n=i(97542),a=i(57956),s=i(56692),o=i(92901),r=i(84428),d=i(35895),l=i(67678),h=i(86819),c=i(72996);const m=new r.Vector2;class u{constructor(e,t){this.inputIni=e,this.rendererModule=t,this.registrations=new Map,this.hovered=new Map,this.checkPointerLeave=()=>{if(this.hovered.size){const e=v(this.inputIni.getCurrentRayHits());this.hovered.forEach(((t,i)=>{var n,a,s,o,r,d;if(!e.find((e=>e.object===i))){this.hovered.delete(i);const l=Object.assign(Object.assign({},t),{intersections:e});null===(s=null===(n=i.__r3f)||void 0===n?void 0:(a=n.handlers).onPointerOut)||void 0===s||s.call(a,l),null===(d=null===(o=i.__r3f)||void 0===o?void 0:(r=o.handlers).onPointerLeave)||void 0===d||d.call(r,l)}}))}},this.checkPointerMissed=()=>{var e,t,i;const n=new Set(this.inputIni.getCurrentRayHits().map((e=>e.object)));for(const a of this.registrations.keys())n.has(a)||null===(i=null===(e=a.__r3f)||void 0===e?void 0:(t=e.handlers).onPointerMissed)||void 0===i||i.call(t,new MouseEvent("click",this.lastPointerUp.nativeEvent))},this.globalHandlers=[e.registerUnfilteredHandler(l.mE,this.checkPointerLeave),e.registerUnfilteredHandler(h.R,this.checkPointerMissed),e.registerUnfilteredHandler(l.er,(e=>{e.down?this.lastPointerDown=e:this.lastPointerUp=e}))]}dispose(){[...this.globalHandlers,...this.registrations.values()].forEach((e=>e.cancel()))}registerObject3D(e){const t=this.registrations.get(e);if(t)return t;const i=this;let n={};const a=(t,a,s)=>{var o,d,c,u,g,y,w,b,f,T,D,C;const P=this.rendererModule.getCamera(),A=new r.Vector2(t.position.x,t.position.y);let I,E=e;s||(s=n);let k=0;if(t instanceof h.R){const{x:e,y:t}=this.lastPointerDown.clientPosition,{x:i,y:n}=this.lastPointerUp.clientPosition;k=m.set(i-e,n-t).length(),I=new MouseEvent("click",this.lastPointerUp.nativeEvent)}else I=t.nativeEvent;const S=v(this.inputIni.getCurrentRayHits()),N={};for(const e in I)"function"!=typeof I[e]&&(N[e]=I[e]);const O=Object.assign(Object.assign(Object.assign({},N),s),{intersections:S,camera:P,delta:k,eventObject:E,nativeEvent:I,sourceEvent:I,pointer:A,ray:this.inputIni.getCurrentPointerRay(),stopPropagation(){O.stopped=!0,E&&i.handleStopPropagation(E,S)},stopped:!1,unprojectedPoint:new r.Vector3(A.x,A.y,0).unproject(P),spaceX:A.x,spaceY:A.y});for(;!O.stopped&&E;){const e=E.__r3f;e&&p(E)&&(O.eventObject=E,t instanceof l.er?t.down?null===(d=(o=e.handlers).onPointerDown)||void 0===d||d.call(o,O):null===(u=(c=e.handlers).onPointerUp)||void 0===u||u.call(c,O):t instanceof l.mE?(this.hovered.has(E)||(this.hovered.set(E,O),null===(y=(g=e.handlers).onPointerOver)||void 0===y||y.call(g,O),null===(b=(w=e.handlers).onPointerEnter)||void 0===b||b.call(w,O)),null===(T=(f=e.handlers).onPointerMove)||void 0===T||T.call(f,O)):t instanceof h.R&&(null===(C=(D=e.handlers).onClick)||void 0===C||C.call(D,O))),E=E.parent}return n=s,O.stopped},s=[l.er,l.mE,h.R],o=c.s.is((t=>g(t)===e)),u=s.map((e=>this.inputIni.registerMeshHandler(e,o,a))),y=(0,d.k1)((()=>{u.forEach((e=>e.renew())),this.registrations.set(e,y),this.inputIni.registerMesh(e,!1,(t=>g(t)===e))}),(()=>{u.forEach((e=>e.cancel())),this.registrations.delete(e),this.hovered.delete(e),this.inputIni.unregisterMesh(e)}),!1);return y.renew(),y}handleStopPropagation(e,t){if(this.hovered.has(e)){const i=t.findIndex((t=>t.object===e));if(i>-1){const e=[];for(let n=i+1;n<t.length;n++)for(let i=t[n].object;i;i=i.parent){const t=this.hovered.get(i);t&&e.push({obj:i,origEvent:t})}e.forEach((({obj:e,origEvent:i})=>{var n,a,s;const o=Object.assign(Object.assign({},i),{intersections:t,eventObject:e});this.hovered.delete(e);const r=null===(n=e.__r3f)||void 0===n?void 0:n.handlers;null===(a=null==r?void 0:r.onPointerOut)||void 0===a||a.call(r,o),null===(s=null==r?void 0:r.onPointerLeave)||void 0===s||s.call(r,o)}))}}}}function p(e){const t=e.__r3f;return!!t&&(t.hasOwnProperty("eventCount")?(t.eventCount||0)>0:t.handlers&&Object.keys(t.handlers).length>0)}function g(e){let t=e;for(;t&&!p(t);)t=t.parent;return t}function v(e){const t=new Set;return e.filter((e=>{const i=t.has(e.object);return t.add(e.object),!i}))}class y extends n.Y{constructor(){super(...arguments),this.name="react-three-fiber-external",this.onPlayerResized=e=>{var t;null===(t=this.externalCallbacks)||void 0===t||t.onSizeChange(e.width,e.height)},this.onPixelRatioChanged=e=>{var t;null===(t=this.externalCallbacks)||void 0===t||t.onPixelRatioChange(e.pixelRatio)}}async init(e,t){this.bindings.push(t.subscribe(s.a,this.onPlayerResized),t.subscribe(o.Vx,this.onPixelRatioChanged));const[i,n]=await Promise.all([t.getModuleBySymbol(a.y.INPUT),t.getModuleBySymbol(a.y.WEBGL_RENDERER)]);this.rendererModule=n,this.eventsAdapter=new u(i,n)}dispose(e){this.eventsAdapter.dispose(),super.dispose(e)}onUpdate(e){var t;null===(t=this.externalCallbacks)||void 0===t||t.onFrame()}registerExternalR3F(e){if(this.externalCallbacks)throw new Error("registerExternalR3F called twice");return this.externalCallbacks=e,{renderer:this.rendererModule.threeRenderer,scene:this.rendererModule.getScene().scene,camera:this.rendererModule.getCamera(),registerMeshEvents:e=>this.eventsAdapter.registerObject3D(e)}}}},74642:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(97542),a=i(57956),s=i(5332),o=i(17878),r=i(31362),d=i(41603),l=i(68191),h=i(84428),c=i(41187),m=i(23254),u=i(41326),p=i(64918),g=i(95882);class v extends n.Y{constructor(){super(...arguments),this.name="screenshots-module",this.capturer=new y}async init(e,t){this.engine=t,[this.settingsModule,this.canvas,this.renderer,this.renderToTexture]=await Promise.all([t.getModuleBySymbol(a.y.SETTINGS),t.market.waitForData(s.W),t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.getModuleBySymbol(a.y.RENDER_TO_TEXTURE)]),this.settingsModule.registerButton("Debug","Take screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take 4k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:2304,width:4096},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take 8k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:4608,width:8192},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take 16k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:9e3,width:16e3},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take FB 3D screenshot",(async()=>{const e=Date.now(),t=this.engine.getRenderLayer("model-mesh"),i=this.engine.getRenderLayer("skybox"),n=t.clone();n.addLayers(i);const a=(await this.engine.market.waitForData(m.O)).currentMode;try{await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,n),await this.engine.commandBinder.issueCommand(new l.U(l.U.modes.Depth)),await this.engine.commandBinder.issueCommand(new u._i(u.BD.MESH,p.n.Instant)),await this.takeAndDownloadScreenshot({height:Math.floor(this.canvas.height/4),width:Math.floor(this.canvas.width/4)},`image_${e}_depth.jpg`,t)}catch(e){throw this.log.error("Could not take screenshot"),e}finally{await this.engine.commandBinder.issueCommand(new l.U(null)),await this.engine.commandBinder.issueCommand(new u._i(u.KP[a||g.Ey.Panorama]))}}))}async takeAndDownloadScreenshot(e,t,i){this.renderTarget||(this.renderTarget=await this.engine.commandBinder.issueCommandWhenBound(new c.oM));const n=await this.capturer.capture(i,e,this.renderer,this.renderToTexture,this.renderTarget);(0,r.Hx)((0,d.Xk)(n),t)}}class y{constructor(){this.captureCamera=new h.Camera}async capture(e,t,i,n,a){const{camera:s,scene:o}=i.getScene();return s.getWorldPosition(this.captureCamera.position),s.getWorldQuaternion(this.captureCamera.quaternion),this.captureCamera.projectionMatrix.copy(s.projectionMatrix),this.captureCamera.layers.mask=e.mask,a.setSize(t.width,t.height),n.render(a.target,o,this.captureCamera),await(0,d.vP)(a)}}},56163:(e,t,i)=>{"use strict";i.d(t,{K:()=>r});var n=i(52528),a=i(71166),s=i(25823);const o=new n.v({});class r{constructor(e,t){this.commandBinder=e,this.layersData=t,this.enabled=!0,this.textParser=o,this.bindings=[]}getGroupingId(e){switch(e){case s.l.TYPE:return this.getTypeId();case s.l.FLOOR:return this.getFloorId();case s.l.LAYER:return this.getLayerGroupId();case s.l.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),n=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&n&&this.layerId===i?n:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(){this.commandBinder.issueCommand(new a.IL(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},21723:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>G});var n=i(97542),a=i(57956),s=i(53954),o=i(25985),r=i(95882),d=i(23254),l=i(41187),h=i(41603),c=i(27646),m=i(20387),u=i(71239),p=i(17878),g=i(76609),v=i(69505),y=i(50090),w=i(19663),b=i(60542);class f extends w.m{constructor(e){super(),this.id="CAPTURE_SNAPSHOT",this.payload={maxSize:e.maxSize||g.SL.ULTRAHIGH,aspect:e.aspect||b.g$,category:e.category||y.i.USER,onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}class T extends w.m{constructor(e){super(),this.id="EQUIRECTANGULAR_SNAPSHOT",this.payload={onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}var D=i(37082),C=i(42418),P=i(90304),A=i(67944),I=i(98010);class E extends I.v{constructor(e){super(),this.error=e}}var k=i(2224);class S extends k.y{constructor(e,t="72002"){super(e),this.name="SnapshotCaptureError"}}class N extends k.y{constructor(e,t="73002"){super(e),this.name="SnapshotUploadError"}}var O,M=i(79727),V=i(63252),B=i(39880),x=i(12039),R=i(8728);!function(e){e.CAPTURING="capturing",e.UPLOADING="uploading",e.ERROR="error",e.DONE="done"}(O||(O={}));var F=i(58368),L=i(66917),H=i(91380),U=i(76631);const j=u.Xd.uploadIntervalDelay;class G extends n.Y{constructor(){super(...arguments),this.name="snapshots-editor"}async init(e,t){this.engine=t,[this.renderer,this.sweepTilingModule]=await Promise.all([t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.getModuleBySymbol(a.y.SWEEP_PANO)]),[this.sweepData,this.viewmodeData,this.cameraData,this.floorsViewData]=await Promise.all([t.market.waitForData(s.Z),t.market.waitForData(d.O),t.market.waitForData(o.M),t.market.waitForData(M.c),t.market.waitForData(C.P)]),[this.snapshotTarget,this.snapshotOverlayTarget]=await Promise.all([t.commandBinder.issueCommandWhenBound(new l.oM),t.commandBinder.issueCommandWhenBound(new l.oM)]);const i=await t.market.waitForData(H.t);this.bindings.push(i.onToolChanged(this.onToolChanged.bind(this))),this.bindings.push(t.commandBinder.addBinding(f,(async e=>{const i=e.onProgress||(0,D.Y)(0);i.value=10,t.commandBinder.issueCommand(new x.ZK),t.commandBinder.issueCommand(new L.M);const n=await this.queryIdealResolution(e.maxSize,e.aspect);this.snapshotTarget.setSize(n.width,n.height),this.snapshotOverlayTarget.setSize(n.width,n.height),await this.fetchHighestAvailable(!1,e.maxSize,(e=>i.value=Math.max(10,e))),await(0,B.gw)(2*j),await this.takeScreenshot();const a=this.sweepData.getSweep(this.sweepData.currentSweep);this.viewmodeData.currentMode===r.Ey.Panorama&&await this.sweepTilingModule.resetSweep(a.id),t.commandBinder.issueCommand(new x.Lp),t.commandBinder.issueCommand(new L.I);let s=e.category;a&&(a.alignmentType===V.z9.UNALIGNED||a.placementType===V.hU.MANUAL)&&s===y.i.USER&&(s=y.i.UNALIGNED);const o=this.uploadAndAddSnapshot(s).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new E(e)),e}));return e.waitForUpload?o:null})));const n=P.f.FORWARD.clone(),c=P.f.FORWARD.clone();this.bindings.push(t.commandBinder.addBinding(T,(async e=>{const i=e.onProgress||(0,D.Y)(0);i.value=10,t.commandBinder.issueCommand(new x.ZK),await(0,B.gw)(50);const a=this.queryIdealEqResolution();this.snapshotTarget.setSize(a.width,a.height);const s=this.sweepData.getSweep(this.sweepData.currentSweep);n.copy(P.f.FORWARD).applyQuaternion(s.rotation).setY(0),c.copy(P.f.FORWARD).applyQuaternion(this.cameraData.pose.rotation).setY(0);const o=(0,A.k2)(n,c)+Math.PI;await this.fetchHighestAvailable(!0,g.SL.ULTRAHIGH,(e=>i.value=Math.max(10,e))),await this.takeEquirectangular(o),await this.sweepTilingModule.resetSweep(s.id),t.commandBinder.issueCommand(new x.Lp);const r=(0,h.fY)(this.snapshotTarget.width,this.snapshotTarget.height,o,0),d=this.uploadAndAddSnapshot(y.i.PANORAMA,r).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new E(e)),e}));return e.waitForUpload?d:null})))}onToolChanged(e){this.sweepTilingModule.setPreloadQuality(e===U.w1.PHOTOS||e===U.w1.START_LOCATION?this.sweepTilingModule.panoSizeClass.ULTRAHIGH:null)}async uploadAndAddSnapshot(e,t){const i=this.createSnapshot(e);i.state=O.CAPTURING,i.imageBlob=(0,h.Xk)(await(0,h.vP)(this.snapshotTarget,t)),i.state=O.UPLOADING;try{return await this.engine.commandBinder.issueCommand(new F.nM(i))}catch(e){throw i.state=O.ERROR,this.log.error(e),new N(e)}}createSnapshot(e){const t=this.viewmodeData.isInside();let i=(0,B.DZ)(new Date);if(t){const e=this.sweepData.getSweep(this.sweepData.currentSweep).name;e&&(i=e)}const n=new R.a;return n.name=i,n.category=e,n.is360=t&&!this.sweepData.currentAlignedSweepObject,n.metadata={cameraMode:this.viewmodeData.currentMode,cameraPosition:this.cameraData.pose.position.clone(),cameraQuaternion:this.cameraData.pose.rotation.clone(),orthoZoom:this.viewmodeData.currentMode===r.Ey.Floorplan?this.cameraData.zoom():-1,ssZoom:this.cameraData.zoom(),scanId:t?this.sweepData.currentSweep:void 0,floorId:this.floorsViewData.currentFloorId,floorVisibility:this.floorsViewData.getFloorsVisibility()},n}async queryIdealResolution(e=g.SL.ULTRAHIGH,t){let i=3840,n=i*b.LP;const a=this.renderer.maxTextureSize;if(i>a&&(this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${a}`),i=a,n=i*b.LP),this.viewmodeData.currentMode===r.Ey.Panorama){const s=await this.sweepTilingModule.availableResolution(this.sweepData.currentSweepObject,e),o=c.Z.getPanoSize(s)*(this.cameraData.fovY()*v.MN)/90;i=Math.min(Math.round(o*t),a),n=Math.round(i/t)}return Promise.resolve({width:i,height:n})}queryIdealEqResolution(){let e=4096,t=.5*e;if(this.viewmodeData.currentMode!==r.Ey.Panorama)throw new S("Equirectangular capture is only supported in Panorama mode");const i=this.renderer.maxTextureSize;return e>i&&this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${i}`),e=Math.min(i,e),t=.5*e,{width:e,height:t}}fetchHighestAvailable(e,t=g.SL.ULTRAHIGH,i){if(this.viewmodeData.currentMode===r.Ey.Panorama){const n=this.sweepData.currentSweepObject,a=e?m.v.FullPanorama:m.v.CurrentView;return this.sweepTilingModule.requestResolution(n,t,a,!0).then((e=>{const t=this.sweepTilingModule.waitForQueue(a,e);return i&&t.progress((e=>i(e*G.captureProgressFudgeFactor))),t.nativePromise()}))}return i&&i(G.captureProgressFudgeFactor),Promise.resolve()}takeScreenshot(){const e=p.o.ALL;e.removeLayers(this.engine.getRenderLayer("grid-underlay")),e.removeLayers(this.engine.getRenderLayer("cursor-mesh")),e.removeLayers(this.engine.getRenderLayer("current-pano-marker"));const t=this.renderer.getScene().scene,i=this.renderer.getScene().camera,n=i.layers.mask;return i.layers.mask=e.mask,this.engine.commandBinder.issueCommand(new l.vU(this.snapshotTarget,t,i)).then((()=>{i.layers.mask=n}))}takeEquirectangular(e){const t=this.sweepData.currentSweep,i=this.sweepTilingModule.getRenderer(),n=i.useTexture(t),a=this.engine.commandBinder.issueCommand(new l.fZ(this.snapshotTarget,n,e));return i.freeTexture(t),a}}G.captureProgressFudgeFactor=90},9699:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var n=i(98010);class a extends n.v{constructor(){super()}}},46368:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var n=i(98010);class a extends n.v{constructor(e){super(),this.sweepIds=e}}},65594:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var n=i(84428),a=i(97542),s=i(53954),o=i(26306);const r=Object.freeze({sweeps:{maxNeighborDistance:50}});var d=i(46368),l=i(9699);class h extends a.Y{constructor(){super(...arguments),this.name="sweep-path"}async init(e,t){this.engine=t,this.sweepData=await t.market.waitForData(s.Z),this.validNeighbors={},this.maxNeighborDistance=e.maxNeighborDistance||r.sweeps.maxNeighborDistance,this.buildDistanceMap()}setRestrictedSweeps(e,t=0){if(this.restrictedSweeps=[],e){for(let i=t;i<e.length;i++)this.restrictedSweeps.push(e[i].id);this.engine.broadcast(new d.Z(this.restrictedSweeps))}else this.restrictedSweeps=void 0,this.engine.broadcast(new l.Z)}findShortestPath(e,t,i,n,a,s,r=5e3){const d=this.sweepData.getSweep(e),l=this.sweepData.getSweep(t),h=this,c=(0,o.K)({start:d,isEnd:e=>e===l,*neighbors(e){for(const t of e.neighbours)yield h.sweepData.getSweep(t)},distance:(e,t)=>h.getDistance(e.id,t.id),heuristic:(e,t)=>1,timeout:r});return c.status===o.h.Success&&c.path.length<a?(this.addSweepsNearPath(c.path,i),this.filterCloseSweepsFromPath(c.path,n)):null}addSweepsNearPath(e,t){const i=new n.Vector3,a=new n.Vector3,s=new n.Vector3,o=new n.Vector3,r=new n.Vector3,d=new n.Vector3,l=[],h=new n.Vector3,c=(e,t,i)=>(s.copy(t).sub(e),s.dot(i)),m=(e,t)=>c(h,e.position,i)-c(h,t.position,i);let u=0;for(;u<e.length-1;){const n=e[u].id,c=e[u+1].id,p=this.sweepData.getSweep(n),g=this.sweepData.getSweep(c);h.copy(p.position),l.length=0,i.copy(g.position).sub(h).normalize();const v=this.findConnectedSweeps(p,this.maxNeighborDistance),y=this.findConnectedSweeps(g,this.maxNeighborDistance),w=v.concat(y);for(const e of w){const n=s.copy(e.position).sub(h).dot(i);if(n>0){r.copy(i),r.multiplyScalar(n),o.copy(s),o.sub(r);if(o.length()<t){a.copy(i).negate(),d.copy(e.position).sub(g.position);d.dot(a)>0&&l.push(e)}}}if(l.length>0){l.sort(m);for(let t=e.length+l.length-1;t>=u+l.length;t--)e[t]=e[t-l.length];for(let t=0;t<l.length;t++)e[t+u+1]=l[t]}u+=l.length+1}}findConnectedSweeps(e,t,i=2){const n=[];return this._findConnectedSweeps(e,e,t,n,{},i,0),n}_findConnectedSweeps(e,t,i,n,a,s,o){const r=this.getValidNeighbors(e.id);for(const e of r)if(!a[e.id]){e.position.distanceTo(t.position)<i&&(n.push(e),a[e.id]=!0,o<s&&this._findConnectedSweeps(e,t,i,n,a,s,o+1))}}getValidNeighbors(e,t){let i=this.validNeighbors[e];if(!i){i=[],this.validNeighbors[e]=i;const n=this.sweepData.getSweep(e),a=n.neighbours;for(const s of a){const a=this.sweepData.getSweep(s),o=this.getDistance(e,s);if(!a.enabled)continue;if(o>this.maxNeighborDistance)continue;let r=!0;if(t){const e=a.position.clone().sub(n.position).normalize();r=0===t(n.position,e,o).length}r&&i.push(a)}}return i}filterCloseSweepsFromPath(e,t){const i=[];let n=null,a=!1;for(const s of e)a=n&&s.position.distanceTo(n.position)<t||!1,n&&a||(i.push(s),n=s);return i.length<2?e:(a&&e.length>1&&(i[i.length-1]=e[e.length-1]),i)}getCurveForPath(e){let t=0;const i=[0];for(let n=1;n<e.length;n++)t+=e[n-1].distanceTo(e[n]),i.push(t);const a=[0];for(let n=1;n<e.length;n++)a.push(i[n]/t);const s=new n.CatmullRomCurve3(e,!1);return{curve:new n.CatmullRomCurve3(s.getSpacedPoints(2*t).concat(e[e.length-1])),totalLength:t,sourceDistances:i,normalSourceDistances:a}}buildDistanceMap(){const e={},t=new n.Vector3(0,0,0);this.sweepData.iterate((i=>{const n={},a=i.neighbours;for(const e of a){const a=this.sweepData.getSweep(e);t.copy(i.position).sub(a.position);let s,o=Math.max(0,Math.abs(t.y)-.2),r=Math.sqrt(t.x*t.x+t.z*t.z);o>0?(o=Math.pow(4*o,2),r=Math.pow(r,2),s=Math.sqrt(o*o+r*r)):s=t.length(),n[a.id]=s}e[i.id]=n})),this.distanceMap=e}getDistance(e,t){return this.distanceMap[e][t]}}},46857:(e,t,i)=>{"use strict";i.d(t,{m1:()=>g,Vp:()=>w});var n=i(84428),a=i(77256),s=i.n(a),o=i(62118),r=i.n(o);class d extends n.RawShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(d.uniforms);i.tMask.value=e,i.tPinHole.value=t,super({vertexShader:s(),fragmentShader:r(),uniforms:i,name:"PinMaterial",transparent:!0})}}d.uniforms={tMask:{type:"t",value:null},tPinHole:{type:"t",value:null},pinColor:{type:"c",value:new n.Color},opacity:{type:"f",value:1}};var l=i(87926),h=i(49827),c=i(12529),m=i(15462),u=i(87928),p=i(48072);class g extends n.Mesh{}let v;const y=()=>v||(v=(0,l.p)(p),v);class w extends u.E{constructor(e,t,i,n){const a=new d(y(),t);super(w.geometry,a),this.layers.mask=n.mask,this.name="PinMesh",this.cameraData=i,this._collider=new g(w.colliderGeometry,w.colliderMaterial),this._collider.name="PinMeshCollider",this._collider.material.visible=!1,this.add(this._collider),this.opacityProgress=0,this.shouldHide=!0,this.uniforms=a.uniforms,this.unhover(),this.selected=0,this.visible=!1,this.position.copy(e),this.renderOrder=c.z.pins360}updatePosition(e){this.position.copy(e)}get collider(){return this._collider}render(e){this.quaternion.copy(this.cameraData.pose.rotation),null===this.uniforms.tPinHole.value?this.opacityProgress=0:!this.shouldHide&&this.opacityProgress<1?this.opacityProgress+=e/w.FADE_DURATION:this.shouldHide&&this.opacityProgress>0&&(this.opacityProgress-=e/w.FADE_DURATION),this.opacityProgress=(0,h.uZ)(this.opacityProgress,0,1),this.uniforms.opacity.value=this.opacityProgress,this.visible=0!==this.opacityProgress}activate(){this.shouldHide=!1}deactivate(){this.shouldHide=!0}dispose(){this.collider.geometry.dispose(),this.collider.material.dispose()}setPinHover(e,t=!0,i=!0){const n=Math.min(Math.max(e,0),1);this.selected!==n&&(i&&this.uniforms.pinColor.value.copy(m.I.WHITE).lerp(m.I.MP_BRAND,n),t&&n>0&&n<=1&&(this.material.depthTest=!1),0===n&&(this.material.depthTest=!0),this.selected=n)}unhover(){this.uniforms.pinColor.value.copy(m.I.WHITE)}}w.FADE_DURATION=500,w.geometry=new n.PlaneGeometry(1.5,1.5),w.colliderGeometry=new n.SphereGeometry(1.5*.65),w.colliderMaterial=new n.MeshBasicMaterial({transparent:!0,opacity:.5,depthWrite:!1,color:16724312})},3054:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>B});var n=i(97542),a=i(57956),s=i(84428),o=i(46857),r=i(98010);class d extends r.v{constructor(e,t){super(),this.sweepId=e,this.selected=t}}class l extends r.v{constructor(e,t,i){super(),this.sweepId=e,this.pinIndex=t,this.placed=i}}var h=i(63252),c=i(76609),m=i(98169),u=i(23612),p=i(97998),g=i(35826),v=i(72996);const y=new p.Z("pin-mesh");class w{constructor(e,t,i,n,a,o){this.sweepViewData=e,this.scene=t,this.sweepTextureLoader=i,this.input=n,this.layer=o,this.container=new s.Object3D,this.bindings=[],this.visibilityFilter=()=>!0,this.updatePlacementType=(e,t)=>{this.dataToMeshMap[e.id]||e.placementType!==h.hU.MANUAL?this.dataToMeshMap[e.id]&&e.placementType!==h.hU.MANUAL&&(this.removePinMesh(e),this.engine.broadcast(new l(e.id,t,!1))):(this.createPinMesh(e,this.cameraData),this.engine.broadcast(new l(e.id,t,!0)))},this.hoverSweep=(e,t)=>{this.issueCommand(new g.kR(e,t,0));const i=this.sweepViewData.selectedSweep===e;this.highlightPin(e,t||i)},this.meshes=[],this.meshToDataMap={},this.dataToMeshMap={},this.cameraData=a,e.iterate((t=>{t.alignmentType!==h.z9.ALIGNED&&(t.placementType===h.hU.MANUAL&&this.createPinMesh(t,a),this.bindings.push(t.onChanged((()=>{const i=e.getIndexByAlignment(!1,t.id);this.updatePlacementType(t,i),m.H7(t)&&this.updatePinMeshPosition(t.id,t.position)}))))}))}updatePinMeshPosition(e,t){this.mapSweepToMesh(e).updatePosition(t)}mapSweepToMesh(e){return this.dataToMeshMap[e]}mapColliderToSweep(e){const t=e.hasOwnProperty("collider")?e:e.parent;if(t){const e=this.meshToDataMap[t.id];if(e)return e.sweep}return null}filter(e){this.visibilityFilter=e;for(const e of this.meshes)this.filterMesh(e)}init(){}dispose(){for(const e in this.meshToDataMap){const t=this.meshToDataMap[e];this.removePinMesh(t.sweep)}}render(e){for(const t of this.meshes)t.render(e)}activate(e){this.engine=e,this.issueCommand=e.commandBinder.issueCommand.bind(e.commandBinder),this.bindings.push(this.input.registerMeshHandler(u.z,v.s.isType(o.m1),((e,t)=>this.onHoverEvent(t,!0)))),this.bindings.push(this.input.registerMeshHandler(u.A,v.s.isType(o.m1),((e,t)=>this.onHoverEvent(t,!1)))),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}getMeshes(){return this.meshToDataMap}highlightPin(e,t){this.dataToMeshMap[e]&&this.dataToMeshMap[e].setPinHover(t?1:0,!1)}lockSelection(e,t){return t&&(this.engine.broadcast(new d(e.id,!0)),this.hoverSweep(e.id,!0)),!0}createPinMesh(e,t){const i=new o.Vp(e.position,null,t,this.layer);this.meshes.push(i),this.dataToMeshMap[e.id]=i,this.meshToDataMap[i.id]={id:i.id,sweep:e},this.container.add(i),this.filterMesh(i),this.sweepTextureLoader.loadFace(e,c.SL.BASE,1,{flipY:!0}).then((e=>{i.material.uniforms.tPinHole.value=e})).catch((t=>{y.error(`${e.id} failed to load texture: ${t}`)}))}removePinMesh(e){const t=this.dataToMeshMap[e.id],i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.id],t.dispose()}filterMesh(e){const t=this.meshToDataMap[e.id];if(t){const i=t.sweep;this.visibilityFilter(i)?this.activateMesh(e):this.deactivateMesh(e)}}onHoverEvent(e,t){const i=this.mapColliderToSweep(e);i&&this.hoverSweep(i.id,t)}activateMesh(e){this.input.registerMesh(e.collider,!1),e.activate()}deactivateMesh(e){this.input.unregisterMesh(e.collider);const t=this.meshToDataMap[e.id];t&&(this.hoverSweep(t.sweep.id,!1),e.deactivate())}}w.MENU_CLEAR_DEBOUNCE=100;var b=i(66777),f=i(19663);class T extends f.m{constructor(e){super(),this.id="PIN_UNSELECT",this.payload={id:e}}}var D=i(54244),C=i(25985),P=i(23254),A=i(34029),I=i(95882),E=i(79727),k=i(21973),S=i(71161),N=i(56159);class O extends r.v{constructor(e){super(),this.sweepId=e}}class M extends r.v{constructor(e){super(),this.sweepId=e}}var V=i(43736);class B extends n.Y{constructor(){super(...arguments),this.name="sweep-pin-mesh",this.onChange=()=>{const e=this.sweepViewData,t=e.selectedSweep,i=e.toolState===S._.ROTATING||e.toolState===S._.ROTATED;this.pinRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(V.s,!0))return!1;if(i&&t===e.id)return!1;if(this.viewmodeData.transition.active&&(0,I.Bw)(this.viewmodeData.transition.to))return!1;const n=!this.nextFloor||this.nextFloor===e.floorId||!e.floorId,a=this.config.showPinsInFloorplanDollhouse||this.applicationData.application===D.Mx.WORKSHOP,s=this.viewmodeData.closestMode===I.Ey.Dollhouse||this.viewmodeData.closestMode===I.Ey.Floorplan;return n&&s&&a}))},this.onSelectedPinChange=()=>{const e=this.sweepViewData.selectedSweep;e&&(this.engine.commandBinder.issueCommand(new g.iF(e,!0,0)),this.pinRenderer.highlightPin(e,!0))}}async init(e,t){var i;[this.model,this.webglRenderer,this.input,this.sweepViewData,this.cameraData,this.settingsData,this.viewmodeData,this.floorsViewData,this.applicationData]=await Promise.all([t.getModuleBySymbol(a.y.MODEL_DATA),t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.getModuleBySymbol(a.y.INPUT),t.market.waitForData(k.D),t.market.waitForData(C.M),t.market.waitForData(A.e),t.market.waitForData(P.O),t.market.waitForData(E.c),t.market.waitForData(D.pu)]);const n=t.claimRenderLayer(this.name),s=this.webglRenderer.getScene().scene;this.config={showPinsInFloorplanDollhouse:null===(i=e&&e.showPinsInFloorplanDollhouse)||void 0===i||i},this.engine=t;const o=new b.Z(this.model.getSignedUrls());this.pinRenderer=new w(this.sweepViewData,s,o,this.input,this.cameraData,n),t.addComponent(this,this.pinRenderer),this.bindings.push(this.applicationData.onPropertyChanged("application",this.onChange),this.settingsData.onPropertyChanged(V.s,this.onChange),this.viewmodeData.onChanged(this.onChange),this.sweepViewData.onSelectedSweepChanged(this.onSelectedPinChange),t.subscribe(N.S,(e=>{this.nextFloor=e.to,this.onChange()})),t.subscribe(O,this.onChange),t.subscribe(M,this.onChange),t.commandBinder.addBinding(T,(async e=>{this.pinRenderer.highlightPin(e.id,!1)}))),this.nextFloor=this.floorsViewData.currentFloorId,this.onChange()}mapColliderToSweep(e){return this.pinRenderer.mapColliderToSweep(e)}selectPinMesh(e,t){return this.pinRenderer.lockSelection(e,t)}highlightPinMesh(e,t){this.pinRenderer.highlightPin(e,t)}mapSweepToMesh(e){return this.pinRenderer.mapSweepToMesh(e)}updatePosition(e,t){this.pinRenderer.updatePinMeshPosition(e,t)}}},39531:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n=i(97542),a=i(57956),s=i(46857),o=i(38987),r=i(34956),d=i(95882),l=i(64918),h=i(23254),c=i(84428),m=i(86819),u=i(23612),p=i(72996);class g extends n.Y{constructor(){super(...arguments),this.name="sweep-pin-navigation"}async init(e,t){const[i,n,g,v]=await Promise.all([t.getModuleBySymbol(a.y.SWEEP_PIN),t.getModuleBySymbol(a.y.VIEWMODE),t.market.waitForData(h.O),t.getModuleBySymbol(a.y.INPUT)]),y=new c.Quaternion;this.bindings.push(v.registerMeshHandler(m.R,p.s.isType(s.m1),((e,t,a)=>{const s=i.mapColliderToSweep(t);return!(!s||g.transition.active)&&(y.set(0,0,0,1).multiply(s.rotation),o=s.id,r=y,g.currentMode&&g.currentMode!==d.Ey.Panorama&&n.switchToMode(d.Ey.Panorama,l.n.FadeToBlack,{sweepID:o,rotation:r}),!0);var o,r})),v.registerMeshHandler(u.z,p.s.isType(s.m1),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.u(r.C.FINGER))})),v.registerMeshHandler(u.A,p.s.isType(s.m1),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.u(null))})))}}},8513:(e,t,i)=>{"use strict";i.d(t,{p:()=>f,Y:()=>v});var n=i(84428),a=i(35490),s=i.n(a),o=i(8346),r=i.n(o);class d extends n.RawShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(d.uniforms);i.tNoHover.value=e,i.tHover.value=t,i.tPortal.value=null,super({vertexShader:s(),fragmentShader:r(),uniforms:i,name:"PortalMaterial",transparent:!0})}}d.uniforms={tNoHover:{type:"t",value:null},tHover:{type:"t",value:null},tPortal:{type:"t",vlaue:null},progress:{type:"f",value:1},opacity:{type:"f",value:1}};var l=i(87926),h=i(68444),c=i(85089),m=i(45545),u=i(64293);let p;const g={get:()=>p||(p={toExteriorTexture:(0,l.p)(h),toExteriorHoverTexture:(0,l.p)(c),toInteriorTexture:(0,l.p)(m),toInteriorHoverTexture:(0,l.p)(u)},p)};var v,y=i(49827),w=i(12529),b=i(23331);!function(e){e[e.HIDE=0]="HIDE",e[e.SHOW=1]="SHOW",e[e.ONTOP=2]="ONTOP"}(v||(v={}));class f extends n.Mesh{constructor(e,t){const i=new d(g.get().toInteriorTexture,g.get().toInteriorHoverTexture);super(f.geometry,i),this.layers.mask=t.mask,this.uniforms=i.uniforms,this.renderOrder=w.z.portals,this.setState(v.HIDE),this.update(e)}update(e){if(this.portalData=e,this.position.copy(e.position),null!==e.lookDirection){const t=e.lookDirection.clone().add(e.position);this.lookAt(t)}this.hoverProgress=0,this.hovered=!1,e.toExterior?(this.uniforms.tNoHover.value=g.get().toExteriorTexture,this.uniforms.tHover.value=g.get().toExteriorHoverTexture):(this.uniforms.tNoHover.value=g.get().toInteriorTexture,this.uniforms.tHover.value=g.get().toInteriorHoverTexture)}resetMesh(e=0,t=!1,i=!1){this.uniforms.opacity.value=e,this.visible=0!==e,this.material.depthTest=t,this.material.depthWrite=i}setHover(e){this.hovered=e}setState(e){switch(e){case v.HIDE:this.resetMesh(0,!0,!0);break;case v.SHOW:this.resetMesh(1,!0,!0);break;case v.ONTOP:this.resetMesh(1)}}render(e,t){var i;if(this.hovered&&this.hoverProgress<1?this.hoverProgress+=e/300:!this.hovered&&this.hoverProgress>0&&(this.hoverProgress-=e/300),this.hoverProgress=(0,y.uZ)(this.hoverProgress,0,1),this.uniforms.progress.value=this.hoverProgress,null===(i=this.portalData)||void 0===i?void 0:i.billboard){const e=t.pose.position,i=this.position.copy(this.portalData.position),n=e.distanceTo(i);n<b.nm?i.lerpVectors(e,i,b.nm/n):n>b.iz&&i.lerpVectors(e,i,b.iz/n),this.lookAt(t.pose.position)}}updatePortalTexture(e){this.uniforms.tPortal.value=e}raycast(e,t){if(!this.visible)return;const i=[];super.raycast(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}f.geometry=new n.PlaneGeometry(b.vX,b.vX)},9162:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>k});var n=i(97542),a=i(57956),s=i(76609),o=i(84428),r=i(29837),d=i.n(r),l=i(45405),h=i.n(l);class c extends o.RawShaderMaterial{constructor(){const e=o.UniformsUtils.clone(c.uniforms);super({vertexShader:d(),fragmentShader:h(),uniforms:e,name:"PortalViewportMaterial",side:o.BackSide})}updateTexture(e){this.uniforms.tMap.value=e}}c.uniforms={tMap:{type:"t",value:null}};class m{constructor(e,t,i,n){this.tempLookDirection=new o.Vector3,this.worldCamera=n,this.camera=new o.Camera,this.renderSize=i,this.sweepTextureLoader=e,this.textureRenderer=t,this.renderTargets={},this.renderCube=new o.Mesh(new o.BoxGeometry(4,4,4),new c)}async getPortalTexture(e,t,i){const n=this.renderTargets[e.id]||this.textureRenderer.createRenderTarget2D(this.renderSize,this.renderSize),a=await this.sweepTextureLoader.load(e,s.SL.BASE);return this.renderCube.material.updateTexture(a),this.renderCube.quaternion.copy(t),this.camera.projectionMatrix.copy(this.worldCamera.projectionMatrix),this.worldCamera.getWorldPosition(this.tempLookDirection),this.camera.lookAt(this.tempLookDirection.sub(i).negate()),this.textureRenderer.render(n,this.renderCube,this.camera),n.texture}releasePortalTexture(e){const t=this.renderTargets[e];t&&this.textureRenderer.disposeRenderTarget2D(t)}}var u=i(8513),p=i(70903),g=i(23612),v=i(86819),y=i(72996),w=i(48476);class b{constructor(e,t,i,n,a){this.container=new o.Object3D,this.bindings=[],this.visibilityFilter=e=>u.Y.HIDE,this.scene=e,this.input=t,this.layer=n,this.cameraData=a,this.viewportLoader=i,this.meshes=[],this.activeMeshes={},this.meshToDataMap={},this.dataToMeshMap={},this.activeTexturePromises={},this.meshPool=new p.L}addPortal(e){let t;const i=this.meshPool.get();i?(t=i.object,t.update(e)):t=this.meshPool.add(new u.p(e,this.layer)).object,this.meshes.push(t),this.container.add(t),this.meshToDataMap[t.id]=e,this.dataToMeshMap[e.index]=t,this.activateMesh(t,this.visibilityFilter(e))}removePortal(e){const t=this.dataToMeshMap[e.index];if(t){this.meshPool.free(t);const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.index]}}init(){}activate(e){this.broadcast=e.broadcast.bind(e),this.bindings.push(this.input.registerMeshHandler(g.z,y.s.isType(u.p),((e,t)=>{this.onPuckSelect(t)}))),this.bindings.push(this.input.registerMeshHandler(g.A,y.s.isType(u.p),((e,t)=>{this.onPuckDeselect(t)}))),this.bindings.push(this.input.registerMeshHandler(v.R,y.s.isType(u.p),((e,t)=>{this.onPuckClick(t)}))),this.scene.add(this.container)}dispose(){for(const e of Object.keys(this.meshToDataMap)){const t=this.meshToDataMap[e],i=this.dataToMeshMap[t.index];this.removePortal(t),i.material.dispose(),i.geometry.dispose()}}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}render(e){for(const t of this.meshes)t.render(e,this.cameraData)}filter(e){this.visibilityFilter=e;for(const t of this.meshes){const i=e(this.meshToDataMap[t.id]);i===u.Y.HIDE?this.deactivateMesh(t):this.activateMesh(t,i)}}mapSweepToMesh(e){for(const t in this.meshToDataMap){const i=this.meshToDataMap[t];if(i.toSweep.id===e&&i.toExterior&&i.fromInterior)return this.dataToMeshMap[i.index]}return null}activateMesh(e,t=0){this.activeMeshes[e.id]||(this.input.registerMesh(e,!1),this.activeMeshes[e.id]=!0),e.setState(t)}deactivateMesh(e){this.input.unregisterMesh(e),this.activeMeshes[e.id]=!1,this.onPuckDeselect(e),e.setState(u.Y.HIDE)}onPuckClick(e){this.broadcast(new w.K(this.meshToDataMap[e.id]))}onPuckSelect(e){this.broadcast(new w.x(!0));const t=this.meshToDataMap[e.id].toSweep,i=this.viewportLoader.getPortalTexture(t,t.rotation,e.position);this.activeTexturePromises[e.id]=i,i.then((t=>{this.activeTexturePromises.hasOwnProperty(e.id)&&i===this.activeTexturePromises[e.id]&&(e.updatePortalTexture(t),e.setHover(!0))}))}onPuckDeselect(e){this.broadcast(new w.x(!1)),e.setHover(!1),this.viewportLoader.releasePortalTexture(this.meshToDataMap[e.id].toSweep.id),delete this.activeTexturePromises[e.id]}}var f=i(23331),T=i(16769),D=i(53954),C=i(25985),P=i(63252),A=i(66777),I=i(98169),E=i(81248);class k extends n.Y{constructor(){super(...arguments),this.name="sweep-portal-mesh",this.portalCount=0}async init(e,t){const[i,n,s,o,r,d,l]=await Promise.all([t.getModuleBySymbol(a.y.MODEL_DATA),t.getModuleBySymbol(a.y.RAYCASTER),t.getModuleBySymbol(a.y.INPUT),t.getModuleBySymbol(a.y.RENDER_TO_TEXTURE),t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.market.waitForData(D.Z),t.market.waitForData(C.M)]),h=t.claimRenderLayer(this.name);this.portalData={};const c=r.getScene().camera,u=new A.Z(i.getSignedUrls());this.raycaster=n;const p=new m(u,o,256,c),g=r.getScene().scene;this.portalRenderer=new b(g,s,p,h,l),await Promise.all([t.getModuleBySymbol(a.y.MESH_API_FIXUP)]);const v=P.hU.MANUAL,y=d.filter((e=>I.H7(e)));d.iterate((e=>{this.portalData[e.id]||(this.portalData[e.id]=[]),I.H7(e)&&this.addPortals(e,this.portalRenderer,d,y);let t=e.placementType;this.bindings.push(e.onPropertyChanged("placementType",(i=>{t!==v&&i===v&&this.addPortals(e,this.portalRenderer,d,y),t===v&&i!==v&&this.removePortals(e.id,this.portalRenderer),t=i}))),this.bindings.push(e.onChanged((()=>{I.H7(e)&&(this.removePortals(e.id,this.portalRenderer),this.addPortals(e,this.portalRenderer,d,y))})))})),t.addComponent(this,this.portalRenderer)}filter(e){this.portalRenderer.filter(e)}getPortalToExterior(e){return this.portalRenderer.mapSweepToMesh(e)}removePortals(e,t){for(const i of this.portalData[e])t.removePortal(i);this.portalData[e]=[]}addPortals(e,t,i,n){const a=this.nearestAlignedSweep(e,i);if(a){const i=this.entryLinks(e,a),s=this.neighborLinks(e,n);this.portalData[e.id]=i.concat(s);for(const i of this.portalData[e.id])t.addPortal(i)}else this.log.debug(`Couldn't find the nearest sweep for a 360 on floor ${e.floorId}; not adding portals`)}nearestAlignedSweep(e,t){const i=[I.ff(e),I._k(),I._T(),I.b1(e)],n=[E.TE(e.position)],a=t.sortByScore(i,n)[0];return a?a.sweep:null}modelIntersection(e,t,i=1/0){const n=(new o.Vector3).copy(e.position).sub(t.position).setY(0).normalize(),a=this.raycaster.picking.pick(t.position,n,T.T0);return{intersect:a&&a.distance<=i?a:null,rayDirection:n}}entryLinks(e,t){const i=[],n=e.position.distanceTo(t.position),a=this.modelIntersection(e,t,n+f.vX);let s,r,d=!1;a.intersect&&a.intersect.face?(s=a.intersect.face.normal.clone().setY(0).normalize(),Math.abs(a.rayDirection.dot(s))<.3&&s.copy(a.rayDirection).multiplyScalar(-1),r=a.intersect.point.clone().addScaledVector(s,f.AF)):(s=null,d=!0,r=e.position.clone()),r.y=t.position.y,i.push({index:this.portalCount++,toSweep:e,fromSweep:t,position:r,lookDirection:s,billboard:d,toExterior:!0,fromInterior:!0});const l=(new o.Vector3).lerpVectors(e.position,t.position,2/n).setY(e.position.y);return i.push({index:this.portalCount++,toSweep:t,fromSweep:e,position:l,lookDirection:s?s.clone().negate():null,billboard:d,toExterior:!1,fromInterior:!1}),i}neighborLinks(e,t){const i=[];for(const n of t)if(e!==n&&n.floorId===e.floorId&&e.position.distanceTo(n.position)<f.M0){const t=e.position.distanceTo(n.position);if(this.modelIntersection(e,n,t).intersect||this.modelIntersection(n,e,t).intersect)continue;const a=e.position.clone().sub(n.position).setY(0).normalize(),s=n.position.clone(),o=f.iz;t>o&&s.addScaledVector(a,t-o),i.push({index:this.portalCount++,toSweep:n,fromSweep:e,position:s,lookDirection:a,billboard:!1,toExterior:!0,fromInterior:!1})}return i}}},48476:(e,t,i)=>{"use strict";i.d(t,{K:()=>a,x:()=>s});var n=i(98010);class a extends n.v{constructor(e){super(),this.toSweep=e.toSweep,this.toExterior=e.toExterior,this.fromInterior=e.fromInterior,this.meshPosition=e.position}}class s extends n.v{constructor(e){super(),this.hovered=e}}},23331:(e,t,i)=>{"use strict";i.d(t,{M0:()=>n,AF:()=>a,vX:()=>s,nm:()=>o,iz:()=>r});const n=15,a=.1,s=.3,o=.75,r=4},87295:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>b});const n=(0,i(78283)._F)(20);var a=i(97542),s=i(57956),o=i(63252),r=i(95882),d=i(64918),l=i(25985),h=i(53954),c=i(23254),m=i(8513),u=i(48476),p=i(12039),g=i(34029),v=i(43736),y=i(34956),w=i(38987);class b extends a.Y{constructor(){super(...arguments),this.name="sweep-portal-navigation",this.onChange=()=>{this.portalRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(v.s,!0))return m.Y.HIDE;if(!(0,r.Bw)(this.viewmodeData.closestMode))return m.Y.HIDE;const t=this.sweepData.getSweep(this.sweepData.currentSweep||"");if(t)if(t.alignmentType===o.z9.ALIGNED){if(e.fromInterior&&e.toExterior&&e.position.distanceTo(t.position)<n)return m.Y.SHOW}else if(t.placementType===o.hU.MANUAL&&e.fromSweep.id===t.id)return m.Y.ONTOP;return m.Y.HIDE}))}}async init(e,t){this.engine=t,[this.portalRenderer,this.cameraData,this.viewmodeModule,this.viewmodeData,this.sweepData,this.settingsData]=await Promise.all([t.getModuleBySymbol(s.y.SWEEP_PORTAL),t.market.waitForData(l.M),t.getModuleBySymbol(s.y.VIEWMODE),t.market.waitForData(c.O),t.market.waitForData(h.Z),t.market.waitForData(g.e)]);const i=(e,i)=>{this.viewmodeData.currentMode&&this.cameraData.canTransition()&&(this.viewmodeData.currentMode!==r.Ey.Panorama?this.viewmodeModule.switchToMode(r.Ey.Panorama,d.n.FadeToBlack,{sweepID:e,rotation:i}):t.commandBinder.issueCommand(new p.ju({sweep:e,rotation:i,transition:d.n.FadeToBlack})))};this.settingsData.onPropertyChanged(v.s,this.onChange),this.bindings.push(t.subscribe(u.K,(e=>{i(e.toSweep.id)})),t.subscribe(u.x,(e=>this.onPortalHover(e.hovered))),this.viewmodeData.onChanged(this.onChange),this.sweepData.onChanged(this.onChange)),this.onChange()}onPortalHover(e){const t=e?y.C.FINGER:null;this.engine.commandBinder.issueCommand(new w.u(t))}}},57560:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelNewTagCommand:()=>V.$g,CloseTagCommand:()=>V.xb,DeleteTagCommand:()=>V.T3,EditTagCommand:()=>V.zt,FilterVisibleTagsCommand:()=>V.Sq,OpenTagCommand:()=>V.lt,SaveCustomTagOrderCommand:()=>V.$B,SaveTagCommand:()=>V.QG,SaveTagVisibilityCommand:()=>V.bg,SetTagOrderByCommand:()=>V.kT,SetTagsModeCommand:()=>V.Li,StartNewTagCommand:()=>V.$J,TagOrderBy:()=>M.D,TagsMode:()=>M.U,TagsToolToggleCommand:()=>V.yU,TagsViewData:()=>ue.n,TagsVisibilityFilterEnabledCommand:()=>V.aI,ToggleDirtyTagStateCommand:()=>V.q4,default:()=>Se});var n=i(84428),a=i(97542),s=i(57956),o=i(5823),r=i(38399),d=i(39880),l=i(87926),h=i(4592),c=i(79728),m=i(635),u=i(64918),p=i(12039),g=i(25071),v=i(52528),y=i(74082),w=i(14630),b=i(64773),f=i(47620),T=i(30643),D=i(54244),C=i(89570),P=i(35221),A=i(43470),I=i(86283),E=i(56163),k=i(39689),S=i(62612);class N extends E.K{constructor(e,t,i,a,s,r){super(e,t),this.layersData=t,this.tag=i,this.tagIconsEnabled=s,this.defaultTagLabel=r,this.id=this.tag.id,this.title=this.tag.label||this.textParser.getPlainText(this.tag.description)||this.defaultTagLabel,this.description=this.tag.label?this.textParser.getPlainText(this.tag.description):"",this.icon=`icon-${(0,k.m)(S.Er.MATTERTAG,this.tag.icon,this.tagIconsEnabled)}`,this.typeId=o.SF.MATTERTAG,this.floorId=this.tag.floorId,this.layerId=this.tag.layerId,this.dateBucket=(0,P.f)(this.tag.created),this.color=function(e){const t=new n.Color(e);return`rgb(${255*t.r}, ${255*t.g}, ${255*t.b})`}(this.tag.color),this.enabled=this.tag.enabled,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new p.OR({pinPosition:this.tag,transition:u.n.FadeToBlack}));!(0,g.OR)()?this.commandBinder.issueCommand(new A.bd(this.id,I.J.TAG)):this.commandBinder.issueCommand(new A.oM(this.id,I.J.TAG))},this.textParser=a}}var O=i(59279),M=i(12150),V=i(43037),B=i(71166),x=i(48945);const{TAGS:R}=r.Z.SHOWCASE,F=new v.v({links:!0}),L="0"===(0,O.eY)("mt");function H(e,t,i,n,a,s,r){let d=s.application===D.Mx.WORKSHOP;const l=a.tryGetProperty(x.RV,!1),h=(t,a,s=[])=>{const o=[];return(i.tagOrder===M.D.ALPHABETICAL?i.getAlphabeticTagViewMapFilter().values:i.getOrderedTagViewMapFilter().values).forEach((i=>{if(!(d||i.enabled&&n.layerToggled(i.layerId)))return;if(i.objectAnnotationId)return;let a=t(i.label,F.getPlainText(i.description));a&&s.length>0&&(a=i.keywords.length>0&&i.keywords.some((e=>s.includes(e)))),a&&o.push(new N(e,n,i,F,l,r))})),e.issueCommand(new V.Sq(o.map((e=>e.id)))),o},c=t=>{e.issueCommand(new V.aI(!!t))},m=e=>new C.V(i.getOrderedTagViewMapFilter().onChanged(e)),u={renew:()=>{e.issueCommandWhenBound(new B.c6({id:o.SF.MATTERTAG,groupPhraseKey:R.SEARCH_GROUP_HEADER,getSimpleMatches:h,registerChangeObserver:m,onSearchActivatedChanged:c,getKeywords:t.getTagKeywords.bind(t),groupOrder:20,groupIcon:"toolbar-mattertags"}))},cancel:()=>{e.issueCommandWhenBound(new B.Pe(o.SF.MATTERTAG))}},p=e=>{d=e===D.Mx.WORKSHOP;!L||d?u.renew():u.cancel()},g=s.onPropertyChanged("application",p);return p(s.application),new C.V(u,g)}var U,j=i(98010);class G extends j.v{constructor(e,t,i){super(),this.sid=e,this.position=t,this.distanceFromCamera=i}}class z extends j.v{constructor(e,t){super(),this.sid=e,this.removeMethod=t}}class _ extends j.v{constructor(e,t){super(),this.sid=e,this.characterCount=t}}class $ extends j.v{constructor(e,t,i){super(),this.sid=e,this.characterCount=t,this.tagDescriptionChunks=i}}class W extends j.v{constructor(e,t,i){super(),this.sid=e,this.mediaType=t,this.mediaSrc=i}}class K extends j.v{constructor(e,t,i){super(),this.sid=e,this.property=t,this.value=i}}class J extends j.v{constructor(e,t,i,n){super(),this.sid=e,this.position=t,this.distanceFromCamera=i,this.distanceMoved=n}}!function(e){e.DISC_COLOR="disc_color",e.STEM_VISIBLE="stem_visible",e.STEM_LENGTH="stem_length",e.TITLE="title",e.DESCRIPTION="description",e.MEDIA="media",e.LINKS="links",e.ENABLED="enabled",e.KEYWORDS="keywords"}(U||(U={}));var Y=i(72936),q=i(60083),Z=i(13132),Q=i(16935),X=i(5604),ee=i(76631),te=i(40964),ie=i(91380),ne=i(89549),ae=i(92211),se=i(24102),oe=i(43846),re=i(66338),de=i(25561),le=i(71776),he=i(19648),ce=i(20480),me=i(85679),ue=i(61774),pe=i(35446),ge=i(21149),ve=i(79727),ye=i(53954),we=i(34029),be=i(23254),fe=i(55318),Te=i(25985),De=i(76957),Ce=i(80742),Pe=i(76087),Ae=i(28022),Ie=i(55502),Ee=i(51397);class ke extends a.Y{constructor(){super(...arguments),this.name="tags-module",this.opening=null,this.activated=!1,this.registered=!1,this.activeBindings=[],this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(le.re,!1),t=!this.in360View()&&e;this.engine.commandBinder.issueCommand(new Y.qN(S.Er.MATTERTAG,t)),t||this.closeTagBillboard()},this.tagsToolToggled=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.updateViewingControls=()=>{const{openTagView:e}=this.viewData,t=this.toolsData.toolPanelLayout===ee.wS.BOTTOM_PANEL,i=!this.activated||!t&&!e;this.engine.broadcast(new te.ps(i))},this.onCloseTag=async()=>{this.closeTag()},this.pinAddCancelled=e=>{e.pinType===S.Er.MATTERTAG&&this.cancelTagCreation(!1)},this.onCancelNewTag=async()=>{this.cancelTagCreation(!0)},this.cancelTagCreation=e=>{var t;const i=this.viewData,n=null===(t=i.openTagView)||void 0===t?void 0:t.id;this.cancelAttachmentChanges(),i.setOpenTagView(null),i.creatingTag=!1,i.commit(),n&&(e&&this.engine.commandBinder.issueCommand(new Y.tT(n,S.Er.MATTERTAG)),this.engine.commandBinder.issueCommand(new A.Aj(n,I.J.TAG)))},this.tagsWereChanged=()=>{this.updateTagViews(),this.displayTags()},this.updateTagViews=()=>{this.viewData.updateTagViews(this.getCustomTagOrder())},this.onTagRemoved=e=>{const t=e.objectAnnotationId?S.Er.OBJECT:S.Er.MATTERTAG;this.engine.commandBinder.issueCommand(new Y.OL(e.sid,t))},this.handleModelViewChange=()=>{if(this.viewData.openTagView)if(this.viewData.creatingTag)this.cancelTagCreation(!0);else{this.tagsData.getTag(this.viewData.openTagView.id)||this.closeTag()}},this.onLayersChanged=()=>{this.closeTagBillboard(),this.displayTags()},this.onOpenTagViewChanged=()=>{const e=this.viewData.openTagView;e&&this.updateTagPin(e)},this.startTagCreation=async()=>{const e=this.viewData;e.setTagsMode(M.U.DEFAULT),await this.closeTag();let t=(0,d.O1)(11);for(;this.tagsData.getTag(t);)t=(0,d.O1)(11);const i=new ce.U;i.sid=t,i.floorId=this.floorsViewData.getHighestVisibleFloor().id;const n=e.createTagView(i);e.creatingTag=!0,e.commit(),e.setOpenTagView(n),this.engine.commandBinder.issueCommand(new Y.fM(n.id,n,S.Er.MATTERTAG,n.backgroundTexture))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:a,embed:s}=e,o=this.viewData,{openTagView:r,creatingTag:d}=o;if(!r)return void this.log.debug("No open tag");const l=Object.assign({},r,i);this.trackChanges(t,l,s),d?(o.creatingTag=!1,o.commit(),await this.engine.commandBinder.issueCommand(new he.Mm(t,l,n,s))):await this.engine.commandBinder.issueCommand(new he.qq(t,l,n,a,s)),l.objectAnnotationId||this.selectPin(t,!0),await this.engine.commandBinder.issueCommand(new pe.x9),this.closeTag()},this.saveTagVisibility=async e=>{const{id:t,visible:i}=e,n=this.tagsData.getTag(t);if(!n)throw new Error("Tag not found!");this.engine.commandBinder.issueCommand(new Y.ik(t,S.Er.MATTERTAG,this.getTagVisibility(t,n.layerId,i)));const a={enabled:i};return this.trackChanges(t,a),this.engine.commandBinder.issueCommand(new he.qq(t,a))},this.onToggleTagDirty=async e=>{this.viewData.dirtyTagState=e.dirty,this.viewData.commit()},this.onDeleteTag=async e=>{const t=e.id;this.tagsData.getTag(t)?(this.engine.commandBinder.issueCommand(new ae.rE),this.engine.broadcast(new z(t,e.removalMethod)),this.engine.commandBinder.issueCommand(new he.Gn(t)).then((()=>{this.saveTags().then((()=>{this.engine.commandBinder.issueCommand(new Y.OL(t,S.Er.MATTERTAG));const e=this.viewData.openTagView;e&&e.id===t&&this.closeTag()}))})),this.engine.commandBinder.issueCommand(new pe.x9)):this.log.debug("Cannot delete a non-existent tag")},this.onEditTag=async e=>{const{tagId:t}=e;this.tagsData.getTag(t)?(await this.engine.commandBinder.issueCommand(new pe.x9),await this.openTag(t,u.n.FadeToBlack,!0,!0),this.openAnnotation(t,!0),this.selectPin(t,!0)):this.log.debug("Cannot edit a non-existent tag")},this.onSaveCustomTagOrder=async e=>{const{ids:t}=e,i=t.map((e=>({id:e,type:se.l.TAG})));await this.engine.commandBinder.issueCommand(new oe.wg(de.q,i)),this.viewData.updateTagViews(t)},this.pinMoved=e=>{const{id:t,pinType:i,pinPos:n,previousPos:a}=e,s=this.viewData.openTagView;if(s&&i===S.Er.MATTERTAG&&t===s.id){if(this.tagsData.getTag(t)){const e={position:n.anchorPosition,normal:n.stemNormal,floorId:n.floorId};this.engine.broadcast(new J(t,e.position,e.position.distanceTo(this.cameraData.pose.position),a?e.position.distanceTo(a.anchorPosition):0)),this.engine.commandBinder.issueCommand(new he.qq(t,e))}else this.log.debug("Cannot move a non-existent tag")}},this.pinPlaced=e=>{const{openTagView:t}=this.viewData;t&&e.pinType===S.Er.MATTERTAG&&e.id===t.id&&(Object.assign(t,e.pinPos),this.openAnnotation(t.id,!0))},this.handlePinFocusChange=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPinId:a}=this.pinsViewData,{billboardAnnotation:s}=this.annotationsViewData;if(!n)return void(s&&s.annotationType===I.J.TAG&&s.id!==a&&await i.issueCommand(new A.Aj(s.id,I.J.TAG)));const o=this.getSelectedTag(),r=o&&(null==o?void 0:o.id)===(null==e?void 0:e.id),d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeTag(),n.pinType===S.Er.MATTERTAG){const t=this.viewData.getTagView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no tag view.");t.id!==(null==e?void 0:e.id)&&(i.issueCommand(new A.Kw(t.id,I.J.TAG)),this.engine.broadcast(new Ie.dJ(t.id,Ee.V.HOVER)))}},this.handlePinSelectionChange=async()=>{const{openTagView:e,dirtyTagState:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null,a=this.appData.application===D.Mx.WORKSHOP;if(e&&!n)!a&&this.activated?this.deactivateTool():this.closeTag();else if(n&&n.pinType===S.Er.MATTERTAG){const e=this.isTagDocked(),t=a&&this.activated&&!!e,i=!(0,g.OR)()||t;this.engine.broadcast(new Ie.dJ(n.id,Ee.V.OPEN)),await this.openTag(n.id,u.n.Interpolate,i),this.openAnnotation(n.id,i)}},this.handleAnnotationsChanged=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t||this.opening)return;const i=this.getDockedTag(),n=this.getSelectedTag(),a=i||n,s=!!i,{dockedAnnotation:o}=this.annotationsViewData;e&&!a&&(null==o?void 0:o.annotationType)!==I.J.OBJECT?this.closeTag():a&&a.id!==(null==e?void 0:e.id)&&(await this.openTag(a.id,u.n.Interpolate,s),this.selectPin(a.id,s));const{previousToolName:r}=this.toolsData;!s&&(r===ee.w1.SEARCH||r===ee.w1.LAYERS)||this.toggleToolForDocking(s)},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==I.J.TAG)return;const a=this.viewData.getTagView(i);if(!a)return void this.log.debug("Cannot view attachment for a non-existent tag");const s=a.attachments,o=s.find((e=>e.id===n));if(o&&(0,ge.lV)(o)){const e=s.filter((e=>(0,ge.lV)(e)));this.engine.commandBinder.issueCommand(new pe.xW(!0,e,n))}},this.onOpenTag=async e=>{const{tagId:t,dock:i,transition:n,objectTag:a,forceOpen:s}=e,o=this.annotationsViewData.getCapabilities(t).dock,r=!(!i||!o),d=null===i&&this.isTagDocked()&&o,l=r||d||!(!i||!s);l&&a?this.dockObjectTag(t):(await this.openTag(t,n,l,!1),this.openAnnotation(t,l,s),this.selectPin(t,l))},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayTags()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayTags()},this.setTagOrderBy=async({order:e})=>{e!==this.viewData.tagOrder&&(this.viewData.tagOrder=e,this.viewData.commit())},this.setTagsMode=async({mode:e})=>{e===M.U.REORDERING&&this.closeTag(),this.viewData.setTagsMode(e)}}async init(e,t){const[i,n,a,o,d,c,m,u,p,g,f,T]=await Promise.all([t.market.waitForData(Te.M),t.market.waitForData(me.n),t.market.waitForData(ie.t),t.market.waitForData(ye.Z),t.market.waitForData(we.e),t.market.waitForData(be.O),t.market.waitForData(Q.A),t.market.waitForData(D.pu),t.market.waitForData(ve.c),t.market.waitForData(re.W),t.market.waitForData(Ce.R),t.getModuleBySymbol(s.y.LOCALE)]),[C,P,A]=await Promise.all([t.market.waitForData(De.i),t.market.waitForData(fe.O),t.getModuleBySymbol(s.y.DEEP_LINKS)]);this.cameraData=i,this.tagsData=n,this.toolsData=a,this.sweepData=o,this.settingsData=d,this.viewmodeData=c,this.annotationsViewData=m,this.appData=u,this.floorsViewData=p,this.orderedListData=g,this.layersData=f,this.engine=t,this.backgroundTexture=(0,l.p)(h),this.descriptionParser=new y.$({supportLinks:!0,keepLinkLabels:!0});const I=new v.v({links:!0,hashtags:!1}),E=this.getCustomTagOrder(),k=T.t(r.Z.WORKSHOP.MATTERTAGS.DEFAULT_TAG_TITLE),S=this.settingsData.tryGetProperty(Pe.fc,!1);this.viewData=new ue.n(this.tagsData,C,P,E,I,A,k,this.backgroundTexture,e.objectTagsEnabled,S),this.pinsViewData=await t.market.waitForData(q.B),this.bindings.push(d.onPropertyChanged(le.re,this.updatePerSettings),t.commandBinder.addBinding(V.yU,this.tagsToolToggled),t.subscribe(X.q,this.handleViewingAttachment),t.subscribe(w.Z,this.updatePerSettings),t.subscribe(b.m,this.updatePerSettings),c.makeModeChangeSubscription(this.updatePerSettings),t.commandBinder.addBinding(V.xb,this.onCloseTag),t.commandBinder.addBinding(V.lt,this.onOpenTag),t.commandBinder.addBinding(V.Li,this.setTagsMode),t.commandBinder.addBinding(V.kT,this.setTagOrderBy),t.commandBinder.addBinding(V.QG,this.saveTag),t.commandBinder.addBinding(V.q4,this.onToggleTagDirty),t.commandBinder.addBinding(V.T3,this.onDeleteTag),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.annotationsViewData.onChanged(this.handleAnnotationsChanged),this.viewData.onOpenTagViewChanged(this.onOpenTagViewChanged),this.orderedListData.onChanged(this.updateTagViews),this.tagsData.onChanged(this.tagsWereChanged),this.tagsData.collection.onElementChanged({onRemoved:this.onTagRemoved}),this.appData.onChanged((()=>this.displayTags())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),t.commandBinder.addBinding(V.Sq,this.filterVisibleTags),t.commandBinder.addBinding(V.aI,this.tagVisbilityFilterEnabled),t.subscribe(Ae.Y,this.handleModelViewChange)),t.market.register(this,ue.n,this.viewData),this.updatePerSettings(),this.displayTags();const N=H(t.commandBinder,this.tagsData,this.viewData,this.layersData,this.settingsData,this.appData,k);this.bindings.push(N)}dispose(e){this.deactivateTool(!0),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new Y.zM(S.Er.MATTERTAG)),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(){}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new A.yL(I.J.TAG)),this.engine.commandBinder.issueCommand(new Y.Ki(!0)),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0,this.updateViewingControls())}deactivateTool(e){if(!this.activated)return;const{creatingTag:t,openTagView:i,tagsMode:n}=this.viewData;n!==M.U.DEFAULT&&this.viewData.setTagsMode(M.U.DEFAULT),this.engine.commandBinder.issueCommand(new Y.iK),t?this.cancelTagCreation(!0):i&&this.closeTag(),this.engine.commandBinder.issueCommand(new Y.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.activated=!1,this.updateViewingControls(),this.engine.commandBinder.issueCommand(new pe.x9)}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(Z.b0,this.pinPlaced),this.engine.subscribe(Z.bV,this.pinMoved),this.engine.subscribe(Z.hu,this.pinAddCancelled),e.addBinding(V.bg,this.saveTagVisibility),e.addBinding(V.$J,this.startTagCreation),e.addBinding(V.$g,this.onCancelNewTag),e.addBinding(V.zt,this.onEditTag),e.addBinding(V.$B,this.onSaveCustomTagOrder),this.viewData.onOpenTagViewChanged(this.updateViewingControls),this.viewData.onPropertyChanged("creatingTag",this.updateViewingControls),this.viewData.onPropertyChanged("tagsMode",(()=>this.displayTags()))),this.registered=!0}closeTagBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===I.J.TAG&&this.engine.commandBinder.issueCommand(new A.Aj(e.id,I.J.TAG))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeTag(){const{commandBinder:e}=this.engine,t=this.viewData,{openTagView:i}=t;if(i){const{id:n,layerId:a,enabled:s}=i;t.setOpenTagView(null),this.cancelAttachmentChanges(),e.issueCommand(new B.IL(null)),e.issueCommand(new pe.xW(!1));const o=this.tagsData.getTag(n);o&&(e.issueCommand(new Y.RH(n,S.Er.MATTERTAG)),o.objectAnnotationId?e.issueCommand(new Y.OL(n,S.Er.MATTERTAG)):e.issueCommand(new Y.ik(n,S.Er.MATTERTAG,this.getTagVisibility(n,a,s)))),await e.issueCommand(new A.Aj(n,I.J.TAG))}this.engine.commandBinder.issueCommand(new pe.x9)}getTagVisibility(e,t,i){const{openTagView:n,idVisibilityEnabled:a,idVisibility:s,tagsMode:o}=this.viewData,r=this.appData.application===D.Mx.WORKSHOP||this.layersData.layerToggled(t),d=this.layersData.layerVisible(t),l=o===M.U.REORDERING,h=!a||s.has(e),c=(null==n?void 0:n.id)===e;return r&&(c||i&&l||i&&h&&d)}displayTags(){const e=[];this.viewData.getOrderedTags(!1).forEach((t=>{const i=this.getPinUpdate(t);i&&e.push(i)})),this.engine.commandBinder.issueCommand(new Y.mE(e))}updateTagPin(e){const t=this.getPinUpdate(e);t&&this.engine.commandBinder.issueCommand(new Y.mE([t]))}getPinUpdate(e){return e.objectAnnotationId?null:Object.assign(Object.assign({},e),{pinType:S.Er.MATTERTAG,backgroundTexture:this.backgroundTexture,visible:this.getTagVisibility(e.id,e.layerId,e.enabled)})}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new pe.Ze)}getCustomTagOrder(){const e=this.orderedListData.getOrderedList(de.q);return e?e.entries.map((e=>e.id)):[]}async saveTags(){this.engine.commandBinder.issueCommand(new m.VQ({dataTypes:[c.g.MATTERTAGS]}))}openAnnotation(e,t,i=!1){const n=this.annotationsViewData.getCapabilities(e);t?(n.dock||i)&&this.engine.commandBinder.issueCommand(new A.bd(e,I.J.TAG,i)):(n.preview||i)&&this.engine.commandBinder.issueCommand(new A.oM(e,I.J.TAG,i))}async selectPin(e,t=!1){const i=t&&this.activated&&this.appData.application===D.Mx.WORKSHOP;t?this.engine.broadcast(new Ie.dJ(e,Ee.V.DOCKED)):this.engine.broadcast(new Ie.dJ(e,Ee.V.OPEN)),await this.engine.commandBinder.issueCommand(new Y.Ar(e,S.Er.MATTERTAG,i))}dockObjectTag(e){const t=this.viewData.getTagView(e);this.engine.commandBinder.issueCommand(new A.bd(e,I.J.OBJECT)),this.viewData.setOpenTagView(t),this.selectPin(e,!0),this.toolsData.toolCollapsed&&this.engine.commandBinder.issueCommand(new ne.Fg(!1))}async openTag(e,t,i,n){const a=this.viewData,s=a.getTagView(e);if(s){const{openTagView:r,tagsMode:d}=this.viewData,{commandBinder:l}=this.engine,{dockedAnnotation:h,selectedAnnotation:c}=this.annotationsViewData;i&&d===M.U.REORDERING&&a.setTagsMode(M.U.DEFAULT),i&&this.toolsData.toolCollapsed&&this.activated&&l.issueCommand(new ne.Fg(!1));const m=(null==r?void 0:r.id)===e;if(m&&this.activated===i)return void this.log.debug("Tag is already open and "+(i?"docked":"undocked"));if(i!==!!h){this.annotationsViewData.getCapabilities(e).dock&&await this.toggleToolForDocking(i),h&&await this.engine.commandBinder.issueCommand(new A.Aj(h.id,h.annotationType))}if(!m&&this.opening!==e){this.opening=e,l.issueCommand(new ae.rE),c&&c.id!==e&&await this.engine.commandBinder.issueCommand(new A.Aj(c.id,c.annotationType)),a.setOpenTagView(s);const i=a.getCapabilities(e);null!==t&&i.focus&&!n&&await this.engine.commandBinder.issueCommand(new p.OR({pinPosition:s,transition:t})).then((()=>{this.engine.broadcast(new Ie.QY(s.id))})),this.engine.commandBinder.issueCommand(new B.IL(s.id,o.SF.MATTERTAG)),setTimeout((()=>{this.opening=null}),0)}}else this.log.debug("Cannot open a non-existent tag")}isTagDocked(){const{dockedAnnotation:e}=this.annotationsViewData;return(null==e?void 0:e.annotationType)===I.J.TAG}getDockedTag(){const{dockedAnnotation:e}=this.annotationsViewData;return e&&e.annotationType===I.J.TAG?this.viewData.getTagView(e.id):null}getSelectedTag(){const{billboardAnnotation:e,billboardSelected:t}=this.annotationsViewData;return e&&t&&e.annotationType===I.J.TAG||(null==e?void 0:e.annotationType)===I.J.OBJECT?this.viewData.getTagView(e.id):null}async toggleToolForDocking(e){const t=this.appData.application===D.Mx.WORKSHOP;if(e){const e=!this.activated;await this.engine.commandBinder.issueCommand(new ne.z2(ee.w1.TAGS,e))}else t||await this.engine.commandBinder.issueCommand(new ne.CH(ee.w1.TAGS))}trackChanges(e,t,i){const a=this.tagsData.getTag(e),{position:s,color:o,description:r,label:d,stemHeight:l,stemVisible:h,enabled:c,keywords:m}=t;if(!a&&s)return void this.engine.broadcast(new G(e,s,s.distanceTo(this.cameraData.pose.position)));if(void 0!==c&&a.enabled!==c&&this.engine.broadcast(new K(e,U.ENABLED,c)),o){const t=new n.Color(o.r,o.g,o.b).getHexString();a.color.getHexString()!==t&&this.engine.broadcast(new K(e,U.DISC_COLOR,`#${t}`))}if(void 0!==l&&a.stemHeight!==l&&this.engine.broadcast(new K(e,U.STEM_LENGTH,l)),void 0!==h&&a.stemVisible!==h&&this.engine.broadcast(new K(e,U.STEM_VISIBLE,h)),void 0!==d&&a.label!==d&&(this.engine.broadcast(new K(e,U.TITLE,d.length)),this.engine.broadcast(new _(e,d.length))),void 0!==r&&a.description!==r){this.engine.broadcast(new K(e,U.DESCRIPTION,r.length));const t=this.descriptionParser.parse(r,this.layersData.getNonworkshopViewId());this.engine.broadcast(new $(e,r.length,t));const i=y.$.getNumLinks(t);y.$.getNumLinks(a.parsedDescription)!==i&&this.engine.broadcast(new K(e,U.LINKS,i))}if(i){const t=i?i.src:"",n=i?(0,f.F5)(i.mediaType):T.z.none;a.mediaSrc===t&&a.mediaType===n||(this.engine.broadcast(new K(e,U.MEDIA,n)),this.engine.broadcast(new W(e,n,t)))}const u=a.keywords.every((e=>m&&m.includes(e)));if((null==m?void 0:m.length)!==a.keywords.length||!u){const t=(null==m?void 0:m.length)||0;this.engine.broadcast(new K(e,U.KEYWORDS,t))}}}const Se=ke},79232:(e,t,i)=>{"use strict";i.d(t,{F:()=>s});var n=i(75287),a=i(39880);class s extends n.T{constructor(e){super(),this.id=(0,a.O1)(11),e&&Object.assign(this,e)}}},33824:(e,t,i)=>{"use strict";i.d(t,{B:()=>a,p:()=>s});var n=i(19663);class a extends n.m{constructor(e){super(),this.id="REGISTER_DELETED_OBJECT_TYPE_COMMAND",this.payload=e}}class s extends n.m{constructor(e){super(),this.id="RESTORE_DELETED_OBJECT_COMMAND",this.payload={id:e}}}},70903:(e,t,i)=>{"use strict";i.d(t,{L:()=>n});class n{constructor(e){this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e){const t=this.createObjectDescriptor(e);return t.object=e,t.inUse=!0,this.addObjectDescriptorToPool(t),t}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}free(e){for(const t of this.poolArray)if(t.object===e)return t.inUse=!1,!0;return!1}all(){return this.poolArray}remove(e){const t=this.poolArray.findIndex((t=>t.object===e));return-1!==t&&(this.poolArray.splice(t,1),!0)}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},77597:(e,t,i)=>{"use strict";i.d(t,{f:()=>l});var n=i(84428);const a={extensions:{derivatives:!0},defines:{RING_COUNT:0,USE_TEXTURE:!1},uniforms:{discRadius:{value:.2},discNormal:{value:new n.Vector3(0,0,1)},ringRadii:{value:[]},ringColors:{value:[]},opacity:{value:1},texture:{value:null}},vertexShader:i(29535),fragmentShader:i(37198),side:n.FrontSide,transparent:!0};var s=i(93377);const o=new n.Color,r=[{outerRadius:1,innerRadius:.75,color:16777215,opacity:1}];class d extends s.b{constructor(e=r){super(Object.assign(Object.assign({},a),{defines:Object.assign({},a.defines),uniforms:n.UniformsUtils.clone(a.uniforms)})),this.setRings(e),Object.defineProperty(this,"opacity",{set(e){this.uniforms.opacity.value=e},get(){return this.uniforms.opacity.value}})}setDiscNormal(e){this.uniforms.discNormal.value.copy(e)}setDiscRadius(e){this.uniforms.discRadius.value=e}setRings(e){e=e||[],this.defines.RING_COUNT!==e.length&&(this.defines.RING_COUNT=e.length,this.needsUpdate=!0),this.uniforms.ringRadii.value=e.map((({innerRadius:e,outerRadius:t})=>new n.Vector2(e||-1,t))),this.uniforms.ringColors.value=e.map((({color:e,opacity:t})=>(o.set(e),new n.Vector4(o.r,o.g,o.b,t))))}setTexture(e){this.defines.USE_TEXTURE!==!!e&&(this.defines.USE_TEXTURE=!!e,this.needsUpdate=!0),this.uniforms.texture.value=e}getTexture(){return this.uniforms.texture.value}}class l extends n.Mesh{constructor(e){super(new n.SphereGeometry(Math.sqrt(2),8,6),new d),e&&this.configure(e)}configure(e){const{radius:t,normal:i,rings:n,texture:a,opacity:s}=e,{material:o}=this;void 0!==t&&(this.scale.setScalar(t),o.setDiscRadius(t)),void 0!==i&&o.setDiscNormal(i),void 0!==n&&o.setRings(n),void 0!==a&&o.setTexture(a),void 0!==s&&(o.opacity=s)}dispose(){var e;null===(e=this.material.getTexture())||void 0===e||e.dispose(),this.geometry.dispose()}}},62118:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform sampler2D tMask;uniform sampler2D tPinHole;uniform vec3 pinColor;uniform float opacity;void main(){vec4 maskColor=texture2D(tMask,vUv);vec4 pinHoleColor=vec4(texture2D(tPinHole,vec2(vUv.x,vUv.y-0.11)).xyz,1.);float redness=maskColor.r-maskColor.b;vec4 mixedPinColor=mix(vec4(pinColor,1.),pinHoleColor,redness);mixedPinColor.a=min(mixedPinColor.a,maskColor.a)*opacity;gl_FragColor=mixedPinColor;}"},77256:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;attribute vec2 uv;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},45405:e=>{e.exports="precision highp float;precision highp int;uniform samplerCube tMap;varying vec3 vUvw;void main(){vec4 color=textureCube(tMap,vec3(-vUvw.x,vUvw.yz));gl_FragColor=vec4(color.rgb,1.);}"},29837:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;varying vec3 vUvw;void main(){vUvw=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},8346:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform float progress;uniform float opacity;uniform sampler2D tNoHover;uniform sampler2D tHover;uniform sampler2D tPortal;void main(){vec4 noHoverColor=texture2D(tNoHover,vUv);vec4 hoverColor=texture2D(tHover,vUv);vec4 portalColor=texture2D(tPortal,vUv);float xToCtr=2.*vUv.x-1.;float yToCtr=2.*vUv.y-1.;float withinRadius=step(xToCtr*xToCtr+yToCtr*yToCtr,0.9);vec4 mixedPortalColor=mix(hoverColor,portalColor,withinRadius);mixedPortalColor=mix(mixedPortalColor,hoverColor,hoverColor.a);mixedPortalColor=mix(noHoverColor,mixedPortalColor,progress);mixedPortalColor.a=min(mixedPortalColor.a,opacity);gl_FragColor=mixedPortalColor;}"},35490:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;attribute vec2 uv;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},37198:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform float opacity;uniform float discRadius;uniform vec3 discNormal;varying vec3 vFragWorldPos;varying vec3 vCenterWorldPos;\n#ifdef USE_TEXTURE\nuniform sampler2D texture;\n#else\nuniform vec2 ringRadii[RING_COUNT];uniform vec4 ringColors[RING_COUNT];\n#endif\nfloat rayDistToPlane(vec3 rayOrigin,vec3 rayDir,vec3 planeOrigin,vec3 planeNormal){float planeConstant=-dot(planeOrigin,planeNormal);float denom=dot(planeNormal,rayDir);return denom==0.?-1e9:-(dot(rayOrigin,planeNormal)+planeConstant)/denom;}vec4 getColorAtRay(vec3 rayOrigin,vec3 rayDir){vec4 color=vec4(0.);float intersectDist=rayDistToPlane(rayOrigin,rayDir,vCenterWorldPos,discNormal);vec3 intersect=rayOrigin+rayDir*intersectDist;\n#ifdef USE_TEXTURE\nif(intersectDist>0.){vec3 stableDir=abs(discNormal.y)>0.8?normalize((vCenterWorldPos-rayOrigin)*vec3(1.,0.,1.))*sign(discNormal.y):vec3(0.,1.,0.);vec3 xAxis=normalize(cross(stableDir,discNormal));vec3 yAxis=normalize(cross(discNormal,xAxis));intersect-=vCenterWorldPos;vec2 uv=vec2(dot(xAxis,intersect),dot(yAxis,intersect))/discRadius/2.+0.5;if(clamp(uv,vec2(0.),vec2(1.))==uv){color=texture2D(texture,uv);}}\n#else\nfloat fragRadius=intersectDist>0.?distance(intersect,vCenterWorldPos):1e9;if(fragRadius<=discRadius*2.){for(int i=0;i<RING_COUNT;i++){vec2 radii=ringRadii[i]*discRadius;vec4 ringColor=ringColors[i];float ringDist=min(fragRadius-radii[0],radii[1]-fragRadius);\n#if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\nfloat delta=length(vec2(dFdx(fragRadius),dFdy(fragRadius)))*0.70710678;ringColor.a*=smoothstep(-delta,delta,ringDist);\n#else\nringColor.a*=step(0.,ringDist);\n#endif\ncolor=vec4(color.rgb,1.)*color.a+ringColor*(1.-color.a);}}\n#endif\nreturn color;}void main(){vec3 rayDir=normalize(vFragWorldPos-cameraPosition);gl_FragColor=getColorAtRay(cameraPosition,rayDir);gl_FragColor.a*=opacity;if(gl_FragColor.a==0.){discard;}}"},29535:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vCenterWorldPos;varying vec3 vFragWorldPos;void main(){vCenterWorldPos=(modelMatrix*vec4(0.,0.,0.,1.)).xyz;vFragWorldPos=(modelMatrix*vec4(position,1.)).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},44602:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"FileAttachments"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"fileAttachmentsByModelId"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"results"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteFileAttachment"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"id"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteFileAttachment"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"id"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"FileAttachmentDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"FileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"bytes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mimeType"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ImageFileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"imageWidth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"imageHeight"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UploadFileAttachmentToModel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"organizationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"contents"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"FileUpload"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"filename"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"uploadFileAttachmentToModel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"organizationId"},value:{kind:"Variable",name:{kind:"Name",value:"organizationId"}}},{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"contents"},value:{kind:"Variable",name:{kind:"Name",value:"contents"}}},{kind:"Argument",name:{kind:"Name",value:"filename"},value:{kind:"Variable",name:{kind:"Name",value:"filename"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}],loc:{start:0,end:757}};t.loc.source={body:"# read all attachments for the specified model\nquery FileAttachments($modelId: ID!) {\n  fileAttachmentsByModelId(modelId: $modelId) {\n    results { ...FileAttachmentDetails }\n  }\n}\n\nmutation DeleteFileAttachment($id: ID!) {\n  deleteFileAttachment(id: $id)\n}\n\nfragment FileAttachmentDetails on FileAttachment {\n  id\n  created\n  filename\n  url\n  validUntil\n  bytes\n  mimeType\n  ...on ImageFileAttachment {\n      imageWidth\n      imageHeight\n  }\n}\n\nmutation UploadFileAttachmentToModel($organizationId: ID!, $modelId: ID!, $contents: FileUpload!, $filename: String!) {\n  uploadFileAttachmentToModel(organizationId: $organizationId, modelId: $modelId,\n                              contents: $contents, filename: $filename) {\n    ...FileAttachmentDetails\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function s(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var s=n[t]||new Set,o=new Set,r=new Set;for(s.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=a(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.FileAttachments=s(t,"FileAttachments"),e.exports.DeleteFileAttachment=s(t,"DeleteFileAttachment"),e.exports.FileAttachmentDetails=s(t,"FileAttachmentDetails"),e.exports.UploadFileAttachmentToModel=s(t,"UploadFileAttachmentToModel")},69665:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}},type:{kind:"NamedType",name:{kind:"Name",value:"Float"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}},type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"inferenceEvents"},value:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}}},{kind:"Argument",name:{kind:"Name",value:"minimumConfidenceOverride"},value:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}}},{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}},{kind:"Argument",name:{kind:"Name",value:"includeDisabled"},value:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotation"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationPatch"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"SetBulkObjectAnnotationsEnabled"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"setBulkObjectAnnotationsEnabled"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}},{kind:"Argument",name:{kind:"Name",value:"setEnabled"},value:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotation"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[{kind:"Directive",name:{kind:"Name",value:"include"},arguments:[{kind:"Argument",name:{kind:"Name",value:"if"},value:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}}}]}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"panos"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"region"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"tag"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:2011}};t.loc.source={body:"# Object Tag Suggestions\n# Reference: https://matterport-confluence.atlassian.net/wiki/spaces/PP/pages/2678521926/Datafication+Object+Detection+Schema+Proposal\n\nquery GetObjectAnnotations($modelId: ID!, $inferenceEvents: [ID!], $minConfidence: Float, $ids: [ID!], $includeDisabled: Boolean, $includeLayers: Boolean!) {\n  model(id: $modelId) {\n    objectAnnotations(inferenceEvents: $inferenceEvents, minimumConfidenceOverride: $minConfidence, ids: $ids, includeDisabled: $includeDisabled) {\n      ...ObjectAnnotationInfo\n    }\n  }\n}\n\nmutation AddObjectAnnotation($modelId: ID!, $objectAnnotation: ObjectAnnotationDetails!, $includeLayers: Boolean!) {\n  addObjectAnnotation(modelId: $modelId, objectAnnotation: $objectAnnotation) {\n    ...ObjectAnnotationInfo\n  }\n}\n\n# Update a single object annotation\nmutation PatchObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!, $data: ObjectAnnotationPatch!, $includeLayers: Boolean!) {\n  patchObjectAnnotation(modelId: $modelId, , objectAnnotationId: $objectAnnotationId, patch: $data) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation SetBulkObjectAnnotationsEnabled($modelId: ID! $objectAnnotationIds:[ID!]!, $setEnabled: Boolean!, $includeLayers: Boolean!) {\n  setBulkObjectAnnotationsEnabled(modelId: $modelId, objectAnnotationIds: $objectAnnotationIds, setEnabled: $setEnabled) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation DeleteObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!) {\n  deleteObjectAnnotation(modelId: $modelId, objectAnnotationId: $objectAnnotationId)\n}\n\nfragment ObjectAnnotationInfo on ObjectAnnotation {\n  id\n  created\n  modified\n  model {\n    id\n  }\n  floor {\n    id\n  }\n  room {\n    id\n  }\n  layer @include(if: $includeLayers) { id } \n  enabled\n  label\n  confidence\n  panos {\n    id\n  }\n  region {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n  tag {\n    id\n  }\n  keywords\n  classification {\n    id,\n    label,\n    defaultKeywords\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function s(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var s=n[t]||new Set,o=new Set,r=new Set;for(s.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=a(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.GetObjectAnnotations=s(t,"GetObjectAnnotations"),e.exports.AddObjectAnnotation=s(t,"AddObjectAnnotation"),e.exports.PatchObjectAnnotation=s(t,"PatchObjectAnnotation"),e.exports.SetBulkObjectAnnotationsEnabled=s(t,"SetBulkObjectAnnotationsEnabled"),e.exports.DeleteObjectAnnotation=s(t,"DeleteObjectAnnotation"),e.exports.ObjectAnnotationInfo=s(t,"ObjectAnnotationInfo")}}]);